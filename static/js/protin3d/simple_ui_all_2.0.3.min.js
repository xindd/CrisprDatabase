var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,i,o;e=e||{},t=void 0!==e.parent?e.parent:document.body,i=void 0!==e.id?e.id:"oldie",o=Detector.getWebGLErrorMessage(),o.id=i,t.appendChild(o)}};if("object"==typeof module&&(module.exports=Detector),THREE.TrackballControls=function(e,t,i){function o(e){u.enabled!==!1&&(window.removeEventListener("keydown",o),v=u._state,u._state===u.STATE.NONE&&(e.keyCode!==u.keys[u.STATE.ROTATE]||u.noRotate?e.keyCode!==u.keys[u.STATE.ZOOM]||u.noZoom?e.keyCode!==u.keys[u.STATE.PAN]||u.noPan||(u._state=u.STATE.PAN):u._state=u.STATE.ZOOM:u._state=u.STATE.ROTATE))}function r(e){u.enabled!==!1&&(u._state=v,window.addEventListener("keydown",o,!1))}function n(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state===u.STATE.NONE&&(u._state=e.button),u._state!==u.STATE.ROTATE||u.noRotate?u._state!==u.STATE.ZOOM||u.noZoom?u._state!==u.STATE.PAN||u.noPan||(u._panStart.copy(w(e.pageX,e.pageY)),u._panEnd.copy(u._panStart)):(u._zoomStart.copy(w(e.pageX,e.pageY)),u._zoomEnd.copy(u._zoomStart)):(u._rotateStart.copy(T(e.pageX,e.pageY)),u._rotateEnd.copy(u._rotateStart)),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",a,!1),u.dispatchEvent(b))}function s(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state!==u.STATE.ROTATE||u.noRotate?u._state!==u.STATE.ZOOM||u.noZoom?u._state!==u.STATE.PAN||u.noPan||u._panEnd.copy(w(e.pageX,e.pageY)):u._zoomEnd.copy(w(e.pageX,e.pageY)):u._rotateEnd.copy(T(e.pageX,e.pageY)))}function a(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state=u.STATE.NONE,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),u.dispatchEvent(C))}function c(e){if(u.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),u._zoomStart.y=.005*t,u.dispatchEvent(b),u.dispatchEvent(C)}}function d(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._state=u.STATE.TOUCH_ROTATE,u._rotateStart.copy(T(e.touches[0].pageX,e.touches[0].pageY)),u._rotateEnd.copy(u._rotateStart);break;case 2:u._state=u.STATE.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;E=g=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panStart.copy(w(o,r)),u._panEnd.copy(u._panStart);break;default:u._state=u.STATE.NONE}u.dispatchEvent(b)}}function l(e){if(u.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:u._rotateEnd.copy(T(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;E=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(w(o,r));break;default:u._state=u.STATE.NONE}}function h(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._rotateEnd.copy(T(e.touches[0].pageX,e.touches[0].pageY)),u._rotateStart.copy(u._rotateEnd);break;case 2:g=E=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(w(t,i)),u._panStart.copy(u._panEnd)}u._state=u.STATE.NONE,u.dispatchEvent(C)}}var u=this;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var p=1e-6,m=new THREE.Vector3;this._state=this.STATE.NONE;var v=this.STATE.NONE,f=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var g=0,E=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var y={type:"change"},b={type:"start"},C={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var w=function(){var e=new THREE.Vector2;return function(t,i){return e.set((t-u.screen.left)/u.screen.width,(i-u.screen.top)/u.screen.height),e}}(),T=function(){var e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(o,r){i.set((o-.5*u.screen.width-u.screen.left)/(.5*u.screen.width),(.5*u.screen.height+u.screen.top-r)/(.5*u.screen.height),0);var n=i.length();return u.noRoll?n<Math.SQRT1_2?i.z=Math.sqrt(1-n*n):i.z=.5/n:n>1?i.normalize():i.z=Math.sqrt(1-n*n),f.copy(u.object.position).sub(u.target),e.copy(u.object.up).setLength(i.y),e.add(t.copy(u.object.up).cross(f).setLength(i.x)),e.add(f.setLength(i.z)),e}}();this.rotateCamera=function(e,t){var o=new THREE.Vector3,r=new THREE.Quaternion;return function(e,t){var n;void 0===e&&(n=Math.acos(u._rotateStart.dot(u._rotateEnd)/u._rotateStart.length()/u._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(o.crossVectors(u._rotateStart,u._rotateEnd).normalize(),n*=u.rotateSpeed,r.setFromAxisAngle(o,-n)):r.copy(e),(void 0===t||t===!0)&&i.quaternion.multiplyQuaternions(r,i.quaternion),f.applyQuaternion(r),u.object.up.applyQuaternion(r),u._rotateEnd.applyQuaternion(r),u.staticMoving?u._rotateStart.copy(u._rotateEnd):(r.setFromAxisAngle(o,n*(u.dynamicDampingFactor-1)),u._rotateStart.applyQuaternion(r)))}}(),this.zoomCamera=function(e,t){if(u._state===u.STATE.TOUCH_ZOOM_PAN){var o;void 0!==e?o=e:(o=g/E,g=E),f.multiplyScalar(o),(void 0===t||t===!0)&&(i._zoomFactor*=o)}else{var o;o=void 0!==e?e:1+(u._zoomEnd.y-u._zoomStart.y)*u.zoomSpeed,(void 0===t||t===!0)&&(i._zoomFactor*=o),1!==o&&(f.multiplyScalar(o),u.staticMoving?u._zoomStart.copy(u._zoomEnd):u._zoomStart.y+=(u._zoomEnd.y-u._zoomStart.y)*this.dynamicDampingFactor)}},this.panCamera=function(e,t){var o=new THREE.Vector2,r=new THREE.Vector3,n=new THREE.Vector3;return function(e,t){void 0!==e?(o=e,(void 0===t||t===!0)&&i.mouseChange.add(e)):(o.copy(u._panEnd).sub(u._panStart),(void 0===t||t===!0)&&i.mouseChange.add(u._panEnd).sub(u._panStart)),o.lengthSq()&&(o.multiplyScalar(f.length()*u.panSpeed),n.copy(f).cross(u.object.up).setLength(o.x),n.add(r.copy(u.object.up).setLength(o.y)),u.object.position.add(n),u.target.add(n),u.staticMoving?u._panStart.copy(u._panEnd):u._panStart.add(o.subVectors(u._panEnd,u._panStart).multiplyScalar(u.dynamicDampingFactor)))}}(),this.checkDistances=function(){u.noZoom&&u.noPan||(f.lengthSq()>u.maxDistance*u.maxDistance&&u.object.position.addVectors(u.target,f.setLength(u.maxDistance)),f.lengthSq()<u.minDistance*u.minDistance&&u.object.position.addVectors(u.target,f.setLength(u.minDistance)))},this.update=function(e){f.subVectors(u.object.position,u.target),u.noRotate||(void 0!==e&&void 0!==e.quaternion?u.rotateCamera(e.quaternion,e.update):u.rotateCamera()),u.noZoom||(void 0!==e&&void 0!==e._zoomFactor?u.zoomCamera(e._zoomFactor,e.update):u.zoomCamera()),u.noPan||(void 0!==e&&void 0!==e.mouseChange?u.panCamera(e.mouseChange,e.update):u.panCamera()),u.object.position.addVectors(u.target,f),u.checkDistances(),u.object.lookAt(u.target),m.distanceToSquared(u.object.position)>p&&(u.dispatchEvent(y),m.copy(u.object.position))},this.reset=function(){u._state=u.STATE.NONE,v=u.STATE.NONE,u.target.copy(u.target0),u.object.position.copy(u.position0),u.object.up.copy(u.up0),f.subVectors(u.object.position,u.target),u.object.lookAt(u.target),u.dispatchEvent(y),m.copy(u.object.position)},this.domElement.addEventListener("contextmn",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",d,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",o,!1),window.addEventListener("keyup",r,!1),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls,THREE.OrthographicTrackballControls=function(e,t,i){function o(e){u.enabled!==!1&&(window.removeEventListener("keydown",o),g=u._state,u._state===p.NONE&&(e.keyCode!==u.keys[p.ROTATE]||u.noRotate?e.keyCode!==u.keys[p.ZOOM]||u.noZoom?e.keyCode!==u.keys[p.PAN]||u.noPan||(u._state=p.PAN):u._state=p.ZOOM:u._state=p.ROTATE))}function r(e){u.enabled!==!1&&(u._state=g,window.addEventListener("keydown",o,!1))}function n(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state===p.NONE&&(u._state=e.button),u._state!==p.ROTATE||u.noRotate?u._state!==p.ZOOM||u.noZoom?u._state!==p.PAN||u.noPan||(u._panStart.copy(H(e.pageX,e.pageY)),u._panEnd.copy(u._panStart)):(u._zoomStart.copy(H(e.pageX,e.pageY)),u._zoomEnd.copy(u._zoomStart)):(u._rotateStart.copy(S(e.pageX,e.pageY)),u._rotateEnd.copy(u._rotateStart)),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",a,!1),u.dispatchEvent(T))}function s(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state!==p.ROTATE||u.noRotate?u._state!==p.ZOOM||u.noZoom?u._state!==p.PAN||u.noPan||u._panEnd.copy(H(e.pageX,e.pageY)):u._zoomEnd.copy(H(e.pageX,e.pageY)):u._rotateEnd.copy(S(e.pageX,e.pageY)))}function a(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state=p.NONE,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),u.dispatchEvent(R))}function c(e){if(u.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),u._zoomStart.y=.01*t,u.dispatchEvent(T),u.dispatchEvent(R)}}function d(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._state=p.TOUCH_ROTATE,u._rotateStart.copy(S(e.touches[0].pageX,e.touches[0].pageY)),u._rotateEnd.copy(u._rotateStart);break;case 2:u._state=p.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;C=b=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panStart.copy(H(o,r)),u._panEnd.copy(u._panStart);break;default:u._state=p.NONE}u.dispatchEvent(T)}}function l(e){if(u.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:u._rotateEnd.copy(S(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;C=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(H(o,r));break;default:u._state=p.NONE}}function h(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._rotateEnd.copy(S(e.touches[0].pageX,e.touches[0].pageY)),u._rotateStart.copy(u._rotateEnd);break;case 2:b=C=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(H(t,i)),u._panStart.copy(u._panEnd)}u._state=p.NONE,u.dispatchEvent(R)}}var u=this,p={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=.5,this.zoomSpeed=1.2;var m=.01;this.zoomSpeed*=m,this.panSpeed=.03,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new THREE.Vector3;var v=1e-6,f=new THREE.Vector3;this._state=p.NONE;var g=p.NONE,E=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var y=1,b=0,C=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0=new THREE.Vector2((this.left0+this.right0)/2,(this.top0+this.bottom0)/2);var w={type:"change"},T={type:"start"},R={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0.set((this.left0+this.right0)/2,(this.top0+this.bottom0)/2)},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var H=function(){var e=new THREE.Vector2;return function(t,i){return e.set((t-u.screen.left)/u.screen.width,(i-u.screen.top)/u.screen.height),e}}(),S=function(){var e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(o,r){i.set((o-.5*u.screen.width-u.screen.left)/(.5*u.screen.width),(.5*u.screen.height+u.screen.top-r)/(.5*u.screen.height),0);var n=i.length();return u.noRoll?n<Math.SQRT1_2?i.z=Math.sqrt(1-n*n):i.z=.5/n:n>1?i.normalize():i.z=Math.sqrt(1-n*n),E.copy(u.object.position).sub(u.target),e.copy(u.object.up).setLength(i.y),e.add(t.copy(u.object.up).cross(E).setLength(i.x)),e.add(E.setLength(i.z)),e}}();this.rotateCamera=function(e,t){var o=new THREE.Vector3,r=new THREE.Quaternion;return function(e,t){var n;void 0===e&&(n=Math.acos(u._rotateStart.dot(u._rotateEnd)/u._rotateStart.length()/u._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(o.crossVectors(u._rotateStart,u._rotateEnd).normalize(),n*=u.rotateSpeed,r.setFromAxisAngle(o,-n)):r.copy(e),(void 0===t||t===!0)&&i.quaternion.multiplyQuaternions(r,i.quaternion),E.applyQuaternion(r),u.object.up.applyQuaternion(r),u._rotateEnd.applyQuaternion(r),u.staticMoving?u._rotateStart.copy(u._rotateEnd):(r.setFromAxisAngle(o,n*(u.dynamicDampingFactor-1)),u._rotateStart.applyQuaternion(r)))}}(),this.zoomCamera=function(e,t){var o;u._state===p.TOUCH_ZOOM_PAN?void 0!==e?o=e:(o=b/C,b=C):o=void 0!==e?e:1+(u._zoomEnd.y-u._zoomStart.y)*u.zoomSpeed/m,(void 0===t||t===!0)&&(i._zoomFactor*=o),1!==o&&(y=o,u.object.left=y*u.left0+(1-y)*u.center0.x,u.object.right=y*u.right0+(1-y)*u.center0.x,u.object.top=y*u.top0+(1-y)*u.center0.y,u.object.bottom=y*u.bottom0+(1-y)*u.center0.y,u.staticMoving?u._zoomStart.copy(u._zoomEnd):u._zoomStart.y+=(u._zoomEnd.y-u._zoomStart.y)*this.dynamicDampingFactor)},this.panCamera=function(e,t){var o=new THREE.Vector2,r=new THREE.Vector3,n=new THREE.Vector3;return function(e,t){void 0!==e?(o=e,(void 0===t||t===!0)&&i.mouseChange.add(e)):(o.copy(u._panEnd).sub(u._panStart),(void 0===t||t===!0)&&i.mouseChange.add(u._panEnd).sub(u._panStart)),o.lengthSq()&&(o.multiplyScalar(E.length()*u.panSpeed),n.copy(E).cross(u.object.up).setLength(o.x),n.add(r.copy(u.object.up).setLength(o.y)),u.object.position.add(n),u.target.add(n),u.staticMoving?u._panStart.copy(u._panEnd):u._panStart.add(o.subVectors(u._panEnd,u._panStart).multiplyScalar(u.dynamicDampingFactor)))}}(),this.update=function(e){E.subVectors(u.object.position,u.target),u.noRotate||(void 0!==e&&void 0!==e.quaternion?u.rotateCamera(e.quaternion,e.update):u.rotateCamera()),u.noZoom||(void 0!==e&&void 0!==e._zoomFactor?u.zoomCamera(e._zoomFactor,e.update):u.zoomCamera(),u.object.updateProjectionMatrix()),u.noPan||(void 0!==e&&void 0!==e.mouseChange?u.panCamera(e.mouseChange,e.update):u.panCamera()),u.object.position.addVectors(u.target,E),u.object.lookAt(u.target),f.distanceToSquared(u.object.position)>v&&(u.dispatchEvent(w),f.copy(u.object.position))},this.reset=function(){u._state=p.NONE,g=p.NONE,u.target.copy(u.target0),u.object.position.copy(u.position0),u.object.up.copy(u.up0),E.subVectors(u.object.position,u.target),u.object.left=u.left0,u.object.right=u.right0,u.object.top=u.top0,u.object.bottom=u.bottom0,u.object.lookAt(u.target),u.dispatchEvent(w),f.copy(u.object.position)},this.domElement.addEventListener("contextmn",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",d,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",o,!1),window.addEventListener("keyup",r,!1),this.handleResize(),this.update()},THREE.OrthographicTrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrthographicTrackballControls.prototype.constructor=THREE.OrthographicTrackballControls,THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){function e(){if(c===y){var e=new THREE.RenderableObject;return E.push(e),y++,c++,e}return E[c++]}function t(){if(l===C){var e=new THREE.RenderableVertex;return b.push(e),C++,l++,e}return b[l++]}function i(){if(u===T){var e=new THREE.RenderableFace;return w.push(e),T++,u++,e}return w[u++]}function o(){if(m===H){var e=new THREE.RenderableLine;return R.push(e),H++,m++,e}return R[m++]}function r(){if(f===A){var e=new THREE.RenderableSprite;return S.push(e),A++,f++,e}return S[f++]}function n(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function s(e,t){var i=0,o=1,r=e.z+e.w,n=t.z+t.w,s=-e.z+e.w,a=-t.z+t.w;return r>=0&&n>=0&&s>=0&&a>=0?!0:0>r&&0>n||0>s&&0>a?!1:(0>r?i=Math.max(i,r/(r-n)):0>n&&(o=Math.min(o,r/(r-n))),0>s?i=Math.max(i,s/(s-a)):0>a&&(o=Math.min(o,s/(s-a))),i>o?!1:(e.lerp(t,i),t.lerp(e,1-o),!0))}var a,c,d,l,h,u,p,m,v,f,g,E=[],y=0,b=[],C=0,w=[],T=0,R=[],H=0,S=[],A=0,_={objects:[],lights:[],elements:[]},x=new THREE.Vector3,O=new THREE.Vector3,L=new THREE.Vector3,D=new THREE.Vector3,I=new THREE.Vector4,k=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),M=new THREE.Box3,P=new Array(3),z=(new Array(4),new THREE.Matrix4),N=new THREE.Matrix4,j=new THREE.Matrix4,F=new THREE.Matrix3,U=new THREE.Frustum,V=new THREE.Vector4,B=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pkRay=function(e,t){console.error("THREE.Projector: .pkRay() is now raycaster.setFromCamera().")};var G=function(){var e=[],r=[],n=null,s=null,a=new THREE.Matrix3,c=function(t){n=t,s=n.material,a.getNormalMatrix(n.matrixWorld),e.length=0,r.length=0},l=function(e){var t=e.position,i=e.positionWorld,o=e.positionScreen;i.copy(t).applyMatrix4(g),o.copy(i).applyMatrix4(N);var r=1/o.w;o.x*=r,o.y*=r,o.z*=r,e.visible=o.x>=-1&&o.x<=1&&o.y>=-1&&o.y<=1&&o.z>=-1&&o.z<=1},u=function(e,i,o){d=t(),d.position.set(e,i,o),l(d)},m=function(t,i,o){e.push(t,i,o)},v=function(e,t){r.push(e,t)},f=function(e,t,i){return e.visible===!0||t.visible===!0||i.visible===!0?!0:(P[0]=e.positionScreen,P[1]=t.positionScreen,P[2]=i.positionScreen,k.isIntersectionBox(M.setFromPoints(P)))},E=function(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0},y=function(e,t){var i=b[e],r=b[t];p=o(),p.id=n.id,p.v1.copy(i),p.v2.copy(r),p.z=(i.positionScreen.z+r.positionScreen.z)/2,p.material=n.material,_.elements.push(p)},C=function(t,o,c){var d=b[t],l=b[o],u=b[c];if(f(d,l,u)!==!1&&(s.side===THREE.DoubleSide||E(d,l,u)===!0)){h=i(),h.id=n.id,h.v1.copy(d),h.v2.copy(l),h.v3.copy(u),h.z=(d.positionScreen.z+l.positionScreen.z+u.positionScreen.z)/3;for(var p=0;3>p;p++){var m=3*arguments[p],v=h.vertexNormalsModel[p];v.set(e[m],e[m+1],e[m+2]),v.applyMatrix3(a).normalize();var g=2*arguments[p],y=h.uvs[p];y.set(r[g],r[g+1])}h.vertexNormalsLength=3,h.material=n.material,_.elements.push(h)}};return{setObject:c,projectVertex:l,checkTriangleVisibility:f,checkBackfaceCulling:E,pushVertex:u,pushNormal:m,pushUv:v,pushLine:y,pushTriangle:C}},q=new G;this.projectScene=function(d,E,y,C){u=0,m=0,f=0,_.elements.length=0,d.autoUpdate===!0&&d.updateMatrixWorld(),void 0===E.parent&&E.updateMatrixWorld(),z.copy(E.matrixWorldInverse.getInverse(E.matrixWorld)),N.multiplyMatrices(E.projectionMatrix,z),U.setFromMatrix(N),c=0,_.objects.length=0,_.lights.length=0,d.traverseVisible(function(t){if(t instanceof THREE.Light)_.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Sprite){if(t.material.visible===!1)return;(t.frustumCulled===!1||U.intersectsObject(t)===!0)&&(a=e(),a.id=t.id,a.object=t,D.setFromMatrixPosition(t.matrixWorld),D.applyProjection(N),a.z=D.z,_.objects.push(a))}}),y===!0&&_.objects.sort(n);for(var w=0,T=_.objects.length;T>w;w++){var R=_.objects[w].object,H=R.geometry;if(q.setObject(R),g=R.matrixWorld,l=0,R instanceof THREE.Mesh){if(H instanceof THREE.BufferGeometry){var S=H.attributes,A=H.offsets;if(void 0===S.position)continue;for(var k=S.position.array,M=0,P=k.length;P>M;M+=3)q.pushVertex(k[M],k[M+1],k[M+2]);if(void 0!==S.normal)for(var G=S.normal.array,M=0,P=G.length;P>M;M+=3)q.pushNormal(G[M],G[M+1],G[M+2]);if(void 0!==S.uv)for(var W=S.uv.array,M=0,P=W.length;P>M;M+=2)q.pushUv(W[M],W[M+1]);if(void 0!==S.index){var $=S.index.array;if(A.length>0)for(var w=0;w<A.length;w++)for(var Y=A[w],X=Y.index,M=Y.start,P=Y.start+Y.count;P>M;M+=3)q.pushTriangle($[M]+X,$[M+1]+X,$[M+2]+X);else for(var M=0,P=$.length;P>M;M+=3)q.pushTriangle($[M],$[M+1],$[M+2])}else for(var M=0,P=k.length/3;P>M;M+=3)q.pushTriangle(M,M+1,M+2)}else if(H instanceof THREE.Geometry){var Q=H.vertices,Z=H.faces,K=H.faceVertexUvs[0];F.getNormalMatrix(g);for(var J=R.material instanceof THREE.MeshFaceMaterial,ee=J===!0?R.material:null,te=0,ie=Q.length;ie>te;te++){var oe=Q[te];q.pushVertex(oe.x,oe.y,oe.z)}for(var re=0,ne=Z.length;ne>re;re++){var se=Z[re],ae=J===!0?ee.materials[se.materialIndex]:R.material;if(void 0!==ae){var ce=ae.side,de=b[se.a],le=b[se.b],he=b[se.c];if(ae.morphTargets===!0){var ue=H.morphTargets,pe=R.morphTargetInfluences,me=de.position,ve=le.position,fe=he.position;x.set(0,0,0),O.set(0,0,0),L.set(0,0,0);for(var ge=0,Ee=ue.length;Ee>ge;ge++){var ye=pe[ge];if(0!==ye){var be=ue[ge].vertices;x.x+=(be[se.a].x-me.x)*ye,x.y+=(be[se.a].y-me.y)*ye,x.z+=(be[se.a].z-me.z)*ye,O.x+=(be[se.b].x-ve.x)*ye,O.y+=(be[se.b].y-ve.y)*ye,O.z+=(be[se.b].z-ve.z)*ye,L.x+=(be[se.c].x-fe.x)*ye,L.y+=(be[se.c].y-fe.y)*ye,L.z+=(be[se.c].z-fe.z)*ye}}de.position.add(x),le.position.add(O),he.position.add(L),q.projectVertex(de),q.projectVertex(le),q.projectVertex(he)}if(q.checkTriangleVisibility(de,le,he)!==!1){var Ce=q.checkBackfaceCulling(de,le,he);if(ce!==THREE.DoubleSide){if(ce===THREE.FrontSide&&Ce===!1)continue;if(ce===THREE.BackSide&&Ce===!0)continue}h=i(),h.id=R.id,h.v1.copy(de),h.v2.copy(le),h.v3.copy(he),h.normalModel.copy(se.normal),Ce!==!1||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||h.normalModel.negate(),h.normalModel.applyMatrix3(F).normalize();for(var we=se.vertexNormals,Te=0,Re=Math.min(we.length,3);Re>Te;Te++){var He=h.vertexNormalsModel[Te];He.copy(we[Te]),Ce!==!1||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||He.negate(),He.applyMatrix3(F).normalize()}h.vertexNormalsLength=we.length;var Se=K[re];if(void 0!==Se)for(var Ae=0;3>Ae;Ae++)h.uvs[Ae].copy(Se[Ae]);h.color=se.color,h.material=ae,h.z=(de.positionScreen.z+le.positionScreen.z+he.positionScreen.z)/3,_.elements.push(h)}}}}}else if(R instanceof THREE.Line){if(H instanceof THREE.BufferGeometry){var S=H.attributes;if(void 0!==S.position){for(var k=S.position.array,M=0,P=k.length;P>M;M+=3)q.pushVertex(k[M],k[M+1],k[M+2]);if(void 0!==S.index)for(var $=S.index.array,M=0,P=$.length;P>M;M+=2)q.pushLine($[M],$[M+1]);else for(var _e=R.mode===THREE.LinePieces?2:1,M=0,P=k.length/3-1;P>M;M+=_e)q.pushLine(M,M+1)}}else if(H instanceof THREE.Geometry){j.multiplyMatrices(N,g);var Q=R.geometry.vertices;if(0===Q.length)continue;de=t(),de.positionScreen.copy(Q[0]).applyMatrix4(j);for(var _e=R.mode===THREE.LinePieces?2:1,te=1,ie=Q.length;ie>te;te++)de=t(),de.positionScreen.copy(Q[te]).applyMatrix4(j),(te+1)%_e>0||(le=b[l-2],V.copy(de.positionScreen),B.copy(le.positionScreen),s(V,B)===!0&&(V.multiplyScalar(1/V.w),B.multiplyScalar(1/B.w),p=o(),p.id=R.id,p.v1.positionScreen.copy(V),p.v2.positionScreen.copy(B),p.z=Math.max(V.z,B.z),p.material=R.material,R.material.vertexColors===THREE.VertexColors&&(p.vertexColors[0].copy(R.geometry.colors[te]),p.vertexColors[1].copy(R.geometry.colors[te-1])),_.elements.push(p)))}}else if(R instanceof THREE.Sprite){I.set(g.elements[12],g.elements[13],g.elements[14],1),I.applyMatrix4(N);var xe=1/I.w;I.z*=xe,I.z>=-1&&I.z<=1&&(v=r(),v.id=R.id,v.x=I.x*xe,v.y=I.y*xe,v.z=I.z,v.object=R,v.rotation=R.rotation,v.scale.x=R.scale.x*Math.abs(v.x-(I.x+E.projectionMatrix.elements[0])/(I.w+E.projectionMatrix.elements[12])),v.scale.y=R.scale.y*Math.abs(v.y-(I.y+E.projectionMatrix.elements[5])/(I.w+E.projectionMatrix.elements[13])),v.material=R.material,_.elements.push(v))}}return C===!0&&_.elements.sort(n),_}},!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MMTF=e.MMTF||{})}(this,function(e){"use strict";function t(e,t,i){for(var o=(e.byteLength,0),r=i.length;r>o;o++){var n=i.charCodeAt(o);if(128>n)e.setUint8(t++,n>>>0&127|0);else if(2048>n)e.setUint8(t++,n>>>6&31|192),e.setUint8(t++,n>>>0&63|128);else if(65536>n)e.setUint8(t++,n>>>12&15|224),e.setUint8(t++,n>>>6&63|128),e.setUint8(t++,n>>>0&63|128);else{if(!(1114112>n))throw new Error("bad codepoint "+n);e.setUint8(t++,n>>>18&7|240),e.setUint8(t++,n>>>12&63|128),e.setUint8(t++,n>>>6&63|128),e.setUint8(t++,n>>>0&63|128)}}}function i(e){for(var t=0,i=0,o=e.length;o>i;i++){var r=e.charCodeAt(i);if(128>r)t+=1;else if(2048>r)t+=2;else if(65536>r)t+=3;else{if(!(1114112>r))throw new Error("bad codepoint "+r);t+=4}}return t}function o(e,r,n){var s=typeof e;if("string"===s){var a=i(e);if(32>a)return r.setUint8(n,160|a),t(r,n+1,e),1+a;if(256>a)return r.setUint8(n,217),r.setUint8(n+1,a),t(r,n+2,e),2+a;if(65536>a)return r.setUint8(n,218),r.setUint16(n+1,a),t(r,n+3,e),3+a;if(4294967296>a)return r.setUint8(n,219),r.setUint32(n+1,a),t(r,n+5,e),5+a}if(e instanceof Uint8Array){var a=e.byteLength,c=new Uint8Array(r.buffer);if(256>a)return r.setUint8(n,196),r.setUint8(n+1,a),c.set(e,n+2),2+a;if(65536>a)return r.setUint8(n,197),r.setUint16(n+1,a),c.set(e,n+3),3+a;if(4294967296>a)return r.setUint8(n,198),r.setUint32(n+1,a),c.set(e,n+5),5+a}if("number"===s){if(!isFinite(e))throw new Error("Number not finite: "+e);if(Math.floor(e)!==e)return r.setUint8(n,203),r.setFloat64(n+1,e),9;if(e>=0){if(128>e)return r.setUint8(n,e),1;if(256>e)return r.setUint8(n,204),r.setUint8(n+1,e),2;if(65536>e)return r.setUint8(n,205),r.setUint16(n+1,e),3;if(4294967296>e)return r.setUint8(n,206),r.setUint32(n+1,e),5;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return r.setInt8(n,e),1;if(e>=-128)return r.setUint8(n,208),r.setInt8(n+1,e),2;if(e>=-32768)return r.setUint8(n,209),r.setInt16(n+1,e),3;if(e>=-2147483648)return r.setUint8(n,210),r.setInt32(n+1,e),5;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if(null===e)return r.setUint8(n,192),1;if("boolean"===s)return r.setUint8(n,e?195:194),1;if("object"===s){var a,d=0,l=Array.isArray(e);if(l)a=e.length;else{var h=Object.keys(e);a=h.length}var d;if(16>a?(r.setUint8(n,a|(l?144:128)),d=1):65536>a?(r.setUint8(n,l?220:222),r.setUint16(n+1,a),d=3):4294967296>a&&(r.setUint8(n,l?221:223),r.setUint32(n+1,a),d=5),l)for(var u=0;a>u;u++)d+=o(e[u],r,n+d);else for(var u=0;a>u;u++){var p=h[u];d+=o(p,r,n+d),d+=o(e[p],r,n+d)}return d}throw new Error("Unknown type "+s)}function r(e){var t=typeof e;if("string"===t){var o=i(e);if(32>o)return 1+o;if(256>o)return 2+o;if(65536>o)return 3+o;if(4294967296>o)return 5+o}if(e instanceof Uint8Array){var o=e.byteLength;if(256>o)return 2+o;if(65536>o)return 3+o;if(4294967296>o)return 5+o}if("number"===t){if(Math.floor(e)!==e)return 9;if(e>=0){if(128>e)return 1;if(256>e)return 2;if(65536>e)return 3;if(4294967296>e)return 5;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return 1;if(e>=-128)return 2;if(e>=-32768)return 3;if(e>=-2147483648)return 5;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"===t||null===e)return 1;if("object"===t){var o,n=0;if(Array.isArray(e)){o=e.length;for(var s=0;o>s;s++)n+=r(e[s])}else{var a=Object.keys(e);o=a.length;for(var s=0;o>s;s++){var c=a[s];n+=r(c)+r(e[c])}}if(16>o)return 1+n;if(65536>o)return 3+n;if(4294967296>o)return 5+n;throw new Error("Array or object too long 0x"+o.toString(16))}throw new Error("Unknown type "+t)}function n(e){var t=new ArrayBuffer(r(e)),i=new DataView(t);return o(e,i,0),new Uint8Array(t)}function s(e,t,i){return t?new e(t.buffer,t.byteOffset,t.byteLength/(i||1)):void 0}function a(e){return s(DataView,e)}function c(e){return s(Uint8Array,e)}function d(e){return s(Int8Array,e)}function l(e){return s(Int32Array,e,4)}function h(e){
return s(Float32Array,e,4)}function u(e,t){var i=e.length/2;t||(t=new Int16Array(i));for(var o=0,r=0;i>o;++o,r+=2)t[o]=e[r]<<8^e[r+1]<<0;return t}function p(e,t){var i=e.length;t||(t=new Uint8Array(2*i));for(var o=a(t),r=0;i>r;++r)o.setInt16(2*r,e[r]);return c(t)}function m(e,t){var i=e.length/4;t||(t=new Int32Array(i));for(var o=0,r=0;i>o;++o,r+=4)t[o]=e[r]<<24^e[r+1]<<16^e[r+2]<<8^e[r+3]<<0;return t}function v(e,t){var i=e.length;t||(t=new Uint8Array(4*i));for(var o=a(t),r=0;i>r;++r)o.setInt32(4*r,e[r]);return c(t)}function f(e,t){var i=e.length;t||(t=new Float32Array(i/4));for(var o=a(t),r=a(e),n=0,s=0,c=i/4;c>n;++n,s+=4)o.setFloat32(s,r.getFloat32(s),!0);return t}function g(e,t,i){var o=e.length,r=1/t;i||(i=new Float32Array(o));for(var n=0;o>n;++n)i[n]=e[n]*r;return i}function E(e,t,i){var o=e.length;i||(i=new Int32Array(o));for(var r=0;o>r;++r)i[r]=Math.round(e[r]*t);return i}function y(e,t){var i,o;if(!t){var r=0;for(i=0,o=e.length;o>i;i+=2)r+=e[i+1];t=new e.constructor(r)}var n=0;for(i=0,o=e.length;o>i;i+=2)for(var s=e[i],a=e[i+1],c=0;a>c;++c)t[n]=s,++n;return t}function b(e){if(0===e.length)return new Int32Array;var t,i,o=2;for(t=1,i=e.length;i>t;++t)e[t-1]!==e[t]&&(o+=2);var r=new Int32Array(o),n=0,s=1;for(t=1,i=e.length;i>t;++t)e[t-1]!==e[t]?(r[n]=e[t-1],r[n+1]=s,s=1,n+=2):++s;return r[n]=e[e.length-1],r[n+1]=s,r}function C(e,t){var i=e.length;t||(t=new e.constructor(i)),i&&(t[0]=e[0]);for(var o=1;i>o;++o)t[o]=e[o]+t[o-1];return t}function w(e,t){var i=e.length;t||(t=new e.constructor(i)),t[0]=e[0];for(var o=1;i>o;++o)t[o]=e[o]-e[o-1];return t}function T(e,t){var i,o,r=e instanceof Int8Array?127:32767,n=-r-1,s=e.length;if(!t){var a=0;for(i=0;s>i;++i)e[i]<r&&e[i]>n&&++a;t=new Int32Array(a)}for(i=0,o=0;s>i;){for(var c=0;e[i]===r||e[i]===n;)c+=e[i],++i;c+=e[i],++i,t[o]=c,++o}return t}function R(e,t){var i,o=t?127:32767,r=-o-1,n=e.length,s=0;for(i=0;n>i;++i){var a=e[i];0===a?++s:a>0?(s+=Math.ceil(a/o),a%o===0&&(s+=1)):(s+=Math.ceil(a/r),a%r===0&&(s+=1))}var c=t?new Int8Array(s):new Int16Array(s),d=0;for(i=0;n>i;++i){var a=e[i];if(a>=0)for(;a>=o;)c[d]=o,++d,a-=o;else for(;r>=a;)c[d]=r,++d,a-=r;c[d]=a,++d}return c}function H(e,t){return C(y(e),t)}function S(e){return b(w(e))}function A(e,t,i){return g(y(e,l(i)),t,i)}function _(e,t){return b(E(e,t))}function x(e,t,i){return g(C(e,l(i)),t,i)}function O(e,t,i){return w(E(e,t),i)}function L(e,t,i){return g(T(e,l(i)),t,i)}function D(e,t,i){var o=T(e,l(i));return x(o,t,h(o))}function I(e,t,i){return R(O(e,t),i)}function k(e){var t=a(e),i=t.getInt32(0),o=t.getInt32(4),r=e.subarray(8,12),e=e.subarray(12);return[i,e,o,r]}function M(e,t,i,o){var r=new ArrayBuffer(12+o.byteLength),n=new Uint8Array(r),s=new DataView(r);return s.setInt32(0,e),s.setInt32(4,t),i&&n.set(i,8),n.set(o,12),n}function P(e){var t=e.length,i=c(e);return M(2,t,void 0,i)}function z(e){var t=e.length,i=v(e);return M(4,t,void 0,i)}function N(e,t){var i=e.length/t,o=v([t]),r=c(e);return M(5,i,o,r)}function j(e){var t=e.length,i=v(b(e));return M(6,t,void 0,i)}function F(e){var t=e.length,i=v(S(e));return M(8,t,void 0,i)}function U(e,t){var i=e.length,o=v([t]),r=v(_(e,t));return M(9,i,o,r)}function V(e,t){var i=e.length,o=v([t]),r=p(I(e,t));return M(10,i,o,r)}function B(e){var t={};return ee.forEach(function(i){void 0!==e[i]&&(t[i]=e[i])}),e.bondAtomList&&(t.bondAtomList=z(e.bondAtomList)),e.bondOrderList&&(t.bondOrderList=P(e.bondOrderList)),t.xCoordList=V(e.xCoordList,1e3),t.yCoordList=V(e.yCoordList,1e3),t.zCoordList=V(e.zCoordList,1e3),e.bFactorList&&(t.bFactorList=V(e.bFactorList,100)),e.atomIdList&&(t.atomIdList=F(e.atomIdList)),e.altLocList&&(t.altLocList=j(e.altLocList)),e.occupancyList&&(t.occupancyList=U(e.occupancyList,100)),t.groupIdList=F(e.groupIdList),t.groupTypeList=z(e.groupTypeList),e.secStructList&&(t.secStructList=P(e.secStructList)),e.insCodeList&&(t.insCodeList=j(e.insCodeList)),e.sequenceIndexList&&(t.sequenceIndexList=F(e.sequenceIndexList)),t.chainIdList=N(e.chainIdList,4),e.chainNameList&&(t.chainNameList=N(e.chainNameList,4)),t}function G(e){function t(e){for(var t={},i=0;e>i;i++){var o=n();t[o]=n()}return t}function i(t){var i=e.subarray(s,s+t);return s+=t,i}function o(t){var i=e.subarray(s,s+t);s+=t;var o=65535;if(t>o){for(var r=[],n=0;n<i.length;n+=o)r.push(String.fromCharCode.apply(null,i.subarray(n,n+o)));return r.join("")}return String.fromCharCode.apply(null,i)}function r(e){for(var t=new Array(e),i=0;e>i;i++)t[i]=n();return t}function n(){var n,c,d=e[s];if(0===(128&d))return s++,d;if(128===(240&d))return c=15&d,s++,t(c);if(144===(240&d))return c=15&d,s++,r(c);if(160===(224&d))return c=31&d,s++,o(c);if(224===(224&d))return n=a.getInt8(s),s++,n;switch(d){case 192:return s++,null;case 194:return s++,!1;case 195:return s++,!0;case 196:return c=a.getUint8(s+1),s+=2,i(c);case 197:return c=a.getUint16(s+1),s+=3,i(c);case 198:return c=a.getUint32(s+1),s+=5,i(c);case 202:return n=a.getFloat32(s+1),s+=5,n;case 203:return n=a.getFloat64(s+1),s+=9,n;case 204:return n=e[s+1],s+=2,n;case 205:return n=a.getUint16(s+1),s+=3,n;case 206:return n=a.getUint32(s+1),s+=5,n;case 208:return n=a.getInt8(s+1),s+=2,n;case 209:return n=a.getInt16(s+1),s+=3,n;case 210:return n=a.getInt32(s+1),s+=5,n;case 217:return c=a.getUint8(s+1),s+=2,o(c);case 218:return c=a.getUint16(s+1),s+=3,o(c);case 219:return c=a.getUint32(s+1),s+=5,o(c);case 220:return c=a.getUint16(s+1),s+=3,r(c);case 221:return c=a.getUint32(s+1),s+=5,r(c);case 222:return c=a.getUint16(s+1),s+=3,t(c);case 223:return c=a.getUint32(s+1),s+=5,t(c)}throw new Error("Unknown type 0x"+d.toString(16))}var s=0,a=new DataView(e.buffer);return n()}function q(e,t,i,o){switch(e){case 1:return f(t);case 2:return d(t);case 3:return u(t);case 4:return m(t);case 5:return c(t);case 6:return y(m(t),new Uint8Array(i));case 7:return y(m(t));case 8:return H(m(t));case 9:return A(m(t),m(o)[0]);case 10:return D(u(t),m(o)[0]);case 11:return g(u(t),m(o)[0]);case 12:return L(u(t),m(o)[0]);case 13:return L(d(t),m(o)[0]);case 14:return T(u(t));case 15:return T(d(t))}}function W(e,t){t=t||{};var i=t.ignoreFields,o={};return ie.forEach(function(t){var r=i?-1!==i.indexOf(t):!1,n=e[t];r||void 0===n||(n instanceof Uint8Array?o[t]=q.apply(null,k(n)):o[t]=n)}),o}function $(e){return String.fromCharCode.apply(null,e).replace(/\0/g,"")}function Y(e,t,i){i=i||{};var o,r,n,s,a,c,d=i.firstModelOnly,l=t.onModel,h=t.onChain,u=t.onGroup,p=t.onAtom,m=t.onBond,v=0,f=0,g=0,E=0,y=0,b=-1,C=e.chainNameList,w=e.secStructList,T=e.insCodeList,R=e.sequenceIndexList,H=e.atomIdList,S=e.bFactorList,A=e.altLocList,_=e.occupancyList,x=e.bondAtomList,O=e.bondOrderList;for(o=0,r=e.chainsPerModel.length;r>o&&!(d&&v>0);++o){var L=e.chainsPerModel[v];for(l&&l({chainCount:L,modelIndex:v}),n=0;L>n;++n){var D=e.groupsPerChain[f];if(h){var I=$(e.chainIdList.subarray(4*f,4*f+4)),k=null;C&&(k=$(C.subarray(4*f,4*f+4))),h({groupCount:D,chainIndex:f,modelIndex:v,chainId:I,chainName:k})}for(s=0;D>s;++s){var M=e.groupList[e.groupTypeList[g]],P=M.atomNameList.length;if(u){var z=null;w&&(z=w[g]);var N=null;e.insCodeList&&(N=String.fromCharCode(T[g]));var j=null;R&&(j=R[g]),u({atomCount:P,groupIndex:g,chainIndex:f,modelIndex:v,groupId:e.groupIdList[g],groupType:e.groupTypeList[g],groupName:M.groupName,singleLetterCode:M.singleLetterCode,chemCompType:M.chemCompType,secStruct:z,insCode:N,sequenceIndex:j})}for(a=0;P>a;++a){if(p){var F=null;H&&(F=H[E]);var U=null;S&&(U=S[E]);var V=null;A&&(V=String.fromCharCode(A[E]));var B=null;_&&(B=_[E]),p({atomIndex:E,groupIndex:g,chainIndex:f,modelIndex:v,atomId:F,element:M.elementList[a],atomName:M.atomNameList[a],formalCharge:M.formalChargeList[a],xCoord:e.xCoordList[E],yCoord:e.yCoordList[E],zCoord:e.zCoordList[E],bFactor:U,altLoc:V,occupancy:B})}E+=1}if(m){var G=M.bondAtomList;for(a=0,c=M.bondOrderList.length;c>a;++a)m({atomIndex1:E-P+G[2*a],atomIndex2:E-P+G[2*a+1],bondOrder:M.bondOrderList[a]})}g+=1}f+=1}if(y=b+1,b=E-1,m&&x)for(a=0,c=x.length;c>a;a+=2){var q=x[a],W=x[a+1];(q>=y&&b>=q||W>=y&&b>=W)&&m({atomIndex1:q,atomIndex2:W,bondOrder:O?O[a/2]:null})}v+=1}}function X(e){return n(B(e))}function Q(e,t){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var i;return i=e instanceof Uint8Array?G(e):e,W(i,t)}function Z(e,t,i,o){function r(){try{var e=Q(n.response);i(e)}catch(t){o(t)}}var n=new XMLHttpRequest;n.addEventListener("load",r,!0),n.addEventListener("error",o,!0),n.responseType="arraybuffer",n.open("GET",t+e.toUpperCase()),n.send()}function K(e,t,i){Z(e,ne,t,i)}function J(e,t,i){Z(e,se,t,i)}var ee=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"],te=["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],ie=ee.concat(te),oe="v1.0.1",re="//mmtf.rcsb.org/v1.0/",ne=re+"full/",se=re+"reduced/";e.encode=X,e.decode=Q,e.traverse=Y,e.fetch=K,e.fetchReduced=J,e.version=oe,e.fetchUrl=ne,e.fetchReducedUrl=se,e.encodeMsgpack=n,e.encodeMmtf=B,e.decodeMsgpack=G,e.decodeMmtf=W}),$NGL_shaderTextHash={},$NGL_shaderTextHash["SphereImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars","    #include lights_physical_pars_fragment","#endif","","bool flag2 = false;","bool interior = false;","vec3 cameraPos;","vec3 cameraNormal;","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","bool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){","","    vec3 cameraSpherePos = -vPointViewPosition;","    cameraSpherePos.z += vRadius;","","    vec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );","    vec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );","    vec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );","","    float B = dot( rayDirection, cameraSphereDir );","    float det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );","","    if( det < 0.0 ){","        discard;","        return false;","    }else{","        float sqrtDet = sqrt( det );","        float posT = mix( B + sqrtDet, B + sqrtDet, ortho );","        float negT = mix( B - sqrtDet, sqrtDet - B, ortho );","","        cameraPos = rayDirection * negT + rayOrigin;","","        #ifdef NEAR_CLIP","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else if( calcClip( cameraPos ) > 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    flag2 = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #else","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #endif","","        return true;","    }","","    return false; // ensure that each control flow has a return","","}","","void main(void){","","    bool flag = Impostor( cameraPos, cameraNormal );","","    #ifdef NEAR_CLIP","        if( calcClip( cameraPos ) > 0.0 )","            discard;","    #endif","","    // FIXME not compatible with custom clipping plane","    //Set the depth based on the new cameraPos.","    gl_FragDepthEXT = calcDepth( cameraPos );","    if( !flag ){","","        // clamp to near clipping plane and add a tiny value to","        // make spheres with a greater radius occlude smaller ones","        #ifdef NEAR_CLIP","if( flag2 ){","    gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","}else if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #else","if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #endif","","    }","","    // bugfix (mac only?)","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vNormal = cameraNormal;","        vec3 vViewPosition = -cameraPos;","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","        #include normal_flip","        #include normal_fragment","        if( interior ){","            normal = vec3( 0.0, 0.0, 0.4 );","        }","","        // include lights_phong_fragment","        #include lights_physical_fragment","        #include lights_template","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["SphereImpostor.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transpose( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        position.x, position.y, position.z, 1.0","    );","","    mat4 R = transpose( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere();","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - custom clipping","// - three.js lighting","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    varying vec3 vColor1;","    varying vec3 vColor2;","    #include common","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars","    #include lights_physical_pars_fragment","#endif","","bool interior = false;","","float distSq3( vec3 v3a, vec3 v3b ){","    return (","        ( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +","        ( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +","        ( v3a.z - v3b.z ) * ( v3a.z - v3b.z )","    );","}","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","void main(){","","    vec3 point = w.xyz / w.w;","","    // unpacking","    vec3 base = base_radius.xyz;","    float vRadius = base_radius.w;","    vec3 end = end_b.xyz;","    float b = end_b.w;","","    vec3 end_cyl = end;","    vec3 surface_point = point;","","    vec3 ray_target = surface_point;","    vec3 ray_origin = vec3(0.0);","    vec3 ray_direction = mix(normalize(ray_origin - ray_target), vec3(0.0, 0.0, 1.0), ortho);","    mat3 basis = mat3( U, V, axis );","","    vec3 diff = ray_target - 0.5 * (base + end_cyl);","    vec3 P = diff * basis;","","    // angle (cos) between cylinder cylinder_axis and ray direction","    float dz = dot( axis, ray_direction );","","    float radius2 = vRadius*vRadius;","","    // calculate distance to the cylinder from ray origin","    vec3 D = vec3(dot(U, ray_direction),","                dot(V, ray_direction),","                dz);","    float a0 = P.x*P.x + P.y*P.y - radius2;","    float a1 = P.x*D.x + P.y*D.y;","    float a2 = D.x*D.x + D.y*D.y;","","    // calculate a dicriminant of the above quadratic equation","    float d = a1*a1 - a0*a2;","    if (d < 0.0)","        // outside of the cylinder","        discard;","","    float dist = (-a1 + sqrt(d)) / a2;","","    // point of intersection on cylinder surface","    vec3 new_point = ray_target + dist * ray_direction;","","    vec3 tmp_point = new_point - base;","    vec3 _normal = normalize( tmp_point - axis * dot(tmp_point, axis) );","","    ray_origin = mix( ray_origin, surface_point, ortho );","","    // test caps","    float front_cap_test = dot( tmp_point, axis );","    float end_cap_test = dot((new_point - end_cyl), axis);","","    // to calculate caps, simply check the angle between","    // the point of intersection - cylinder end vector","    // and a cap plane normal (which is the cylinder cylinder_axis)","    // if the angle < 0, the point is outside of cylinder","    // test front cap","","    #ifndef CAP","        vec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","        vec3 tmp_point2 = new_point2 - base;","    #endif","","    // flat","    if (front_cap_test < 0.0)","    {","        // ray-plane intersection","        float dNV = dot(-axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(-axis, (base)) / dNV;","        vec3 front_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if (dot(front_point - base, front_point-base) > radius2)","            discard;","","        #ifdef CAP","            new_point = front_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(axis, end_cyl) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - end_cyl, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    // test end cap","","","    // flat","    if( end_cap_test > 0.0 )","    {","        // ray-plane intersection","        float dNV = dot(axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(axis, end_cyl) / dNV;","        vec3 end_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if( dot(end_point - end_cyl, end_point-base) > radius2 )","            discard;","","        #ifdef CAP","            new_point = end_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(-axis, (base)) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - base, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    gl_FragDepthEXT = calcDepth( new_point );","","    #ifdef NEAR_CLIP","        if( calcClip( new_point ) > 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            if( calcClip( new_point ) > 0.0 )","                discard;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","            }","        }else if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #else","        if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #endif","","    // this is a workaround necessary for Mac","    // otherwise the modified fragment won't clip properly","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vViewPosition = -new_point;","        vec3 vNormal = _normal;","        vec3 vColor;","","        if( distSq3( new_point, end_cyl ) < distSq3( new_point, base ) ){","            if( b < 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }else{","            if( b > 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        //include color_fragment","         #ifdef USE_COLOR","     diffuseColor.r *= vColor[0];","     diffuseColor.g *= vColor[1];","     diffuseColor.b *= vColor[2];","     #endif","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","        if( interior ){","            normal = vec3( 0.0, 0.0, 0.4 );","        }","","        #include lights_physical_fragment","        #include lights_template","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","    #endif","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = position;","    vec3 center = ( position2 + position1 ) / 2.0;","    vec3 dir = normalize( position2 - position1 );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),
"undefined"==typeof jQuery)throw new Error("iCn3D requires jQuery");var iCn3D=function(e){this.REVISION="1.3",this.id=e,this.container=$("#"+e),this.overdraw=0,this.bDrawn=!1,this.bSecondaryStructure=!1,this.bHighlight=1,this.renderOrderPicking=-1,this.ALTERNATE_STRUCTURE=-1,Detector.webgl?(this.renderer=new THREE.WebGLRenderer({canvas:this.container.get(0),antialias:!0,preserveDrawingBuffer:!0,alpha:!0}),this.overdraw=0):alert("Currently your web browser has a problem on WebGL. If you are using Chrome, open a new tab for the same URL and WebGL may work again."),this.matShader=this.setOutlineColor("yellow"),this.frac=new THREE.Color(.1,.1,.1),this.scaleFactor=1.5,this.bImpo=!0,this.bExtFragDepth=this.renderer.extensions.get("EXT_frag_depth"),this.bExtFragDepth?console.log("EXT_frag_depth is supported. All spheres and cylinders are drawn using shaders."):(this.bImpo=!1,console.log("EXT_frag_depth is NOT supported. All spheres and cylinders are drawn using geometry.")),this.posArray=new Array,this.colorArray=new Array,this.pos2Array=new Array,this.color2Array=new Array,this.radiusArray=new Array,this.posArraySphere=new Array,this.colorArraySphere=new Array,this.radiusArraySphere=new Array,this.WIDTH=this.container.width(),this.HEIGHT=this.container.height(),this.setWidthHeight(this.WIDTH,this.HEIGHT),this.axis=!1,this.pk=1,this.highlightlevel=1,this.pickpair=!1,this.pAtomNum=0,this.pAtom=void 0,this.pAtom2=void 0,this.bCtrl=!1,this.bShift=!1,this.bStopRotate=!1,this.bCalphaOnly=!1,this.bAllAtoms=!0,this.bConsiderNeighbors=!1,this.bShowCrossResidueBond=!1,this.effects={none:this.renderer},this.maxD=500,this.oriMaxD=this.maxD,this.cam_z=2*this.maxD,this.commands=[],this.optsHistory=[],this.logs=[],this.bRender=!0,this.hColor=new THREE.Color(16776960),this.sphereGeometry=new THREE.SphereGeometry(1,32,32),this.boxGeometry=new THREE.BoxGeometry(1,1,1),this.cylinderGeometry=new THREE.CylinderGeometry(1,1,1,32,1),this.cylinderGeometryOutline=new THREE.CylinderGeometry(1,1,1,32,1,!0),this.axisDIV=5,this.strandDIV=6,this.tubeDIV=8,this.nucleicAcidStrandDIV=6,this.linewidth=1,this.hlLineRadius=.1,this.lineRadius=.1,this.coilWidth=.4,this.cylinderRadius=.4,this.traceRadius=.4,this.dotSphereScale=.3,this.sphereRadius=1.5,this.cylinderHelixRadius=1.6,this.ribbonthickness=.4,this.helixSheetWidth=1.3,this.nucleicAcidWidth=.8,this.LABELSIZE=30,this.opts={camera:"perspective",background:"transparent",color:"chain",sidec:"nothing",proteins:"ribbon",nucleotides:"nucleotide cartoon",surface:"nothing",wireframe:"no",opacity:"0.8",chemicals:"stick",water:"nothing",ions:"sphere",hbonds:"no",ssbonds:"no",labels:"no",lines:"no",rotationcenter:"molecule center",axis:"no",fog:"no",slab:"no",pk:"residue",nucleotides:"nucleotide cartoon",chemicalbinding:"hide"},this._zoomFactor=1,this.mouseChange=new THREE.Vector2(0,0),this.quaternion=new THREE.Quaternion(0,0,0,1);var t=this;this.container.bind("contextmn",function(e){e.preventDefault()}),t.switchHighlightLevel(),t.typetext=!1,$(document).bind("keyup",function(e){16===e.keyCode&&(t.bShift=!1),(17===e.keyCode||224===e.keyCode||91===e.keyCode)&&(t.bCtrl=!1)}),$("input[type=text], textarea").focus(function(){t.typetext=!0}),$("input[type=text], textarea").blur(function(){t.typetext=!1}),$(document).bind("keydown",function(e){if((e.shiftKey||16===e.keyCode)&&(t.bShift=!0),(e.ctrlKey||17===e.keyCode||224===e.keyCode||91===e.keyCode)&&(t.bCtrl=!0),t.controls&&(t.bStopRotate=!0,!t.typetext))if(90===e.keyCode){var i={};t.cam===t.perspectiveCamera?i._zoomFactor=.9:t.cam===t.orthographicCamera&&(t._zoomFactor<.1?t._zoomFactor=.1:t._zoomFactor>1&&(t._zoomFactor=1),i._zoomFactor=.8*t._zoomFactor,i._zoomFactor<.1&&(i._zoomFactor=.1)),i.update=!0,t.controls.update(i),t.render()}else if(88===e.keyCode){var i={};t.cam===t.perspectiveCamera?i._zoomFactor=1.03:t.cam===t.orthographicCamera&&(t._zoomFactor>10?t._zoomFactor=10:t._zoomFactor<1&&(t._zoomFactor=1),i._zoomFactor=1.01*t._zoomFactor,i._zoomFactor>10&&(i._zoomFactor=10)),i.update=!0,t.controls.update(i),t.render()}else if(76===e.keyCode){var o=new THREE.Vector3(0,1,0),r=-5/180*Math.PI;t.setRotation(o,r)}else if(74===e.keyCode){var o=new THREE.Vector3(0,1,0),r=5/180*Math.PI;t.setRotation(o,r)}else if(73===e.keyCode){var o=new THREE.Vector3(1,0,0),r=-5/180*Math.PI;t.setRotation(o,r)}else if(77===e.keyCode){var o=new THREE.Vector3(1,0,0),r=5/180*Math.PI;t.setRotation(o,r)}else 65===e.keyCode&&Object.keys(t.structures)>1&&t.alternateStructures()}),this.container.bind("mouseup touchend",function(e){t.isDragging=!1}),this.container.bind("mousedown touchstart",function(e){if(e.preventDefault(),t.scene){t.bStopRotate=!0;var i=e.pageX,o=e.pageY;if(e.originalEvent.targetTouches&&e.originalEvent.targetTouches[0]&&(i=e.originalEvent.targetTouches[0].pageX,o=e.originalEvent.targetTouches[0].pageY),t.isDragging=!0,t.pk&&(e.altKey||e.ctrlKey||e.shiftKey||18===e.keyCode||16===e.keyCode||17===e.keyCode||224===e.keyCode||91===e.keyCode)){t.highlightlevel=t.pk,t.mouse.x=(i-t.container.offset().left)/t.container.width()*2-1,t.mouse.y=2*-((o-t.container.offset().top)/t.container.height())+1;var r=new THREE.Vector3;r.x=t.mouse.x,r.y=t.mouse.y,this.cam_z>0?r.z=-1:r.z=1,t.cam===t.perspectiveCamera?(this.cam_z>0?r.z=-1:r.z=1,r.unproject(t.cam),t.raycaster.set(t.cam.position,r.sub(t.cam.position).normalize())):t.cam===t.orthographicCamera&&(this.cam_z>0?r.z=1:r.z=-1,r.unproject(t.cam),t.raycaster.set(r,new THREE.Vector3(0,0,-1).transformDirection(t.cam.matrixWorld)));var n=t.raycaster.intersectObjects(t.objects),s=!1,a=t.mdl.position;if(n.length>0){n[0].point.sub(a);for(var c=.5,d=t.getAtomsFromPosition(n[0].point,c);!d&&10>c;)c+=.5,d=t.getAtomsFromPosition(n[0].point,c);d?(s=!0,t.pickpair?(t.pAtomNum%2===0?t.pAtom=d:t.pAtom2=d,++t.pAtomNum):t.pAtom=d,t.showPicking(d)):console.log("No atoms were found in 10 andstrom range")}if(!s&&(n=t.raycaster.intersectObjects(t.objects_ghost),a=t.mdl_ghost.position,n.length>0)){n[0].point.sub(a);for(var c=.5,d=t.getAtomsFromPosition(n[0].point,c);!d&&10>c;)c+=.5,d=t.getAtomsFromPosition(n[0].point,c);d?(t.pickpair?(t.pAtomNum%2===0?t.pAtom=d:t.pAtom2=d,++t.pAtomNum):t.pAtom=d,t.showPicking(d)):console.log("No atoms were found in 10 andstrom range")}}t.controls.handleResize(),t.controls.update(),t.render()}}),this.container.bind("mousemove touchmove",function(e){e.preventDefault(),t.scene&&t.isDragging&&(t.controls.handleResize(),t.controls.update(),t.render())}),this.container.bind("mousewheel",function(e){e.preventDefault(),t.scene&&(t.bStopRotate=!0,t.controls.handleResize(),t.controls.update(),t.render())}),this.container.bind("DOMMouseScroll",function(e){e.preventDefault(),t.scene&&(t.bStopRotate=!0,t.controls.handleResize(),t.controls.update(),t.render())})};iCn3D.prototype={constructor:iCn3D,setRotation:function(e,t){var i=this;e.applyQuaternion(i.cam.quaternion).normalize();var o=new THREE.Quaternion;o.setFromAxisAngle(e,-t);var r={};r.quaternion=o,r.update=!0,i.controls.update(r),i.render()},setOutlineColor:function(e){var t={outline:{vertex_shader:["uniform float offset;","void main() {","vec4 pos = modelViewMatrix * vec4( position + normal * offset, 1.0 );","gl_Position = projectionMatrix * pos;","}"].join("\n"),fragment_shader:["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}};"yellow"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"green"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 0.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"red"===e&&(t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}"].join("\n"));var i={offset:{type:"f",value:.5}},o=t.outline,r=new THREE.ShaderMaterial({uniforms:i,vertexShader:o.vertex_shader,fragmentShader:o.fragment_shader,depthTest:!1,depthWrite:!1,needsUpdate:!0});return r},setWidthHeight:function(e,t){this.renderer.setSize(e*this.scaleFactor,t*this.scaleFactor),this.renderer.domElement.style.width=e+"px",this.renderer.domElement.style.height=t+"px",this.renderer.domElement.width=e*this.scaleFactor,this.renderer.domElement.height=t*this.scaleFactor,this.container.widthInv=1/(this.scaleFactor*e),this.container.heightInv=1/(this.scaleFactor*t),this.container.whratio=e/t},nucleotidesArray:["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU"],ionsArray:["  K"," NA"," MG"," AL"," CA"," TI"," MN"," FE"," NI"," CU"," ZN"," AG"," BA","  F"," CL"," BR","  I"],vdwRadii:{H:1.08,HE:1.34,LI:1.75,BE:2.05,B:1.47,C:1.49,N:1.41,O:1.4,F:1.39,NE:1.68,NA:1.84,MG:2.05,AL:2.11,SI:2.07,P:1.92,S:1.82,CL:1.83,AR:1.93,K:2.05,CA:2.21,SC:2.16,TI:1.87,V:1.79,CR:1.89,MN:1.97,FE:1.94,CO:1.92,NI:1.84,CU:1.86,ZN:2.1,GA:2.08,GE:2.15,AS:2.06,SE:1.93,BR:1.98,KR:2.12,RB:2.16,SR:2.24,Y:2.19,ZR:1.86,NB:2.07,MO:2.09,TC:2.09,RU:2.07,RH:1.95,PD:2.02,AG:2.03,CD:2.3,IN:2.36,SN:2.33,SB:2.25,TE:2.23,I:2.23,XE:2.21,CS:2.22,BA:2.51,LA:2.4,CE:2.35,PR:2.39,ND:2.29,PM:2.36,SM:2.29,EU:2.33,GD:2.37,TB:2.21,DY:2.29,HO:2.16,ER:2.35,TM:2.27,YB:2.42,LU:2.21,HF:2.12,TA:2.17,W:2.1,RE:2.17,OS:2.16,IR:2.02,PT:2.09,AU:2.17,HG:2.09,TL:2.35,PB:2.32,BI:2.43,PO:2.29,AT:2.36,RN:2.43,FR:2.56,RA:2.43,AC:2.6,TH:2.37,PA:2.43,U:2.4,NP:2.21,PU:2.56,AM:2.56,CM:2.56,BK:2.56,CF:2.56,ES:2.56,FM:2.56},covalentRadii:{H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},atomColors:{H:new THREE.Color(16777215),He:new THREE.Color(16761035),HE:new THREE.Color(16761035),Li:new THREE.Color(11674146),LI:new THREE.Color(11674146),B:new THREE.Color(65280),C:new THREE.Color(13158600),N:new THREE.Color(9408511),O:new THREE.Color(15728640),F:new THREE.Color(14329120),Na:new THREE.Color(255),NA:new THREE.Color(255),Mg:new THREE.Color(2263842),MG:new THREE.Color(2263842),Al:new THREE.Color(8421520),AL:new THREE.Color(8421520),Si:new THREE.Color(14329120),SI:new THREE.Color(14329120),P:new THREE.Color(16753920),S:new THREE.Color(16762930),Cl:new THREE.Color(65280),CL:new THREE.Color(65280),Ca:new THREE.Color(8421520),CA:new THREE.Color(8421520),Ti:new THREE.Color(8421520),TI:new THREE.Color(8421520),Cr:new THREE.Color(8421520),CR:new THREE.Color(8421520),Mn:new THREE.Color(8421520),MN:new THREE.Color(8421520),Fe:new THREE.Color(16753920),FE:new THREE.Color(16753920),Ni:new THREE.Color(10824234),NI:new THREE.Color(10824234),Cu:new THREE.Color(10824234),CU:new THREE.Color(10824234),Zn:new THREE.Color(10824234),ZN:new THREE.Color(10824234),Br:new THREE.Color(10824234),BR:new THREE.Color(10824234),Ag:new THREE.Color(8421520),AG:new THREE.Color(8421520),I:new THREE.Color(10494192),Ba:new THREE.Color(16753920),BA:new THREE.Color(16753920),Au:new THREE.Color(14329120),AU:new THREE.Color(14329120)},defaultAtomColor:new THREE.Color(13421772),stdChainColors:[new THREE.Color(16711935),new THREE.Color(255),new THREE.Color(10053171),new THREE.Color(65433),new THREE.Color(16750848),new THREE.Color(16737894),new THREE.Color(3329330),new THREE.Color(2003199),new THREE.Color(16416882),new THREE.Color(16753920),new THREE.Color(52945),new THREE.Color(16738740),new THREE.Color(65280),new THREE.Color(255),new THREE.Color(16711680),new THREE.Color(16776960),new THREE.Color(65535),new THREE.Color(16711935),new THREE.Color(3978097),new THREE.Color(4620980),new THREE.Color(13458524),new THREE.Color(16770229),new THREE.Color(11529966),new THREE.Color(15631086),new THREE.Color(25600),new THREE.Color(139),new THREE.Color(9109504),new THREE.Color(13468991),new THREE.Color(35723),new THREE.Color(9699539)],backgroundColors:{black:new THREE.Color(0),grey:new THREE.Color(13421772),white:new THREE.Color(16777215),transparent:new THREE.Color(0)},residueColors:{ALA:new THREE.Color(13158600),ARG:new THREE.Color(1334015),ASN:new THREE.Color(56540),ASP:new THREE.Color(15075850),CYS:new THREE.Color(15132160),GLN:new THREE.Color(56540),GLU:new THREE.Color(15075850),GLY:new THREE.Color(15461355),HIS:new THREE.Color(8553170),ILE:new THREE.Color(1016335),LEU:new THREE.Color(1016335),LYS:new THREE.Color(1334015),MET:new THREE.Color(15132160),PHE:new THREE.Color(3289770),PRO:new THREE.Color(14456450),SER:new THREE.Color(16422400),THR:new THREE.Color(16422400),TRP:new THREE.Color(11819700),TYR:new THREE.Color(3289770),VAL:new THREE.Color(1016335),ASX:new THREE.Color(16738740),GLX:new THREE.Color(16738740)},defaultResidueColor:new THREE.Color(12492910),chargeColors:{"  G":new THREE.Color(16711680),"  A":new THREE.Color(16711680),"  T":new THREE.Color(16711680),"  C":new THREE.Color(16711680),"  U":new THREE.Color(16711680)," DG":new THREE.Color(16711680)," DA":new THREE.Color(16711680)," DT":new THREE.Color(16711680)," DC":new THREE.Color(16711680)," DU":new THREE.Color(16711680),G:new THREE.Color(16711680),A:new THREE.Color(16711680),T:new THREE.Color(16711680),C:new THREE.Color(16711680),U:new THREE.Color(16711680),DG:new THREE.Color(16711680),DA:new THREE.Color(16711680),DT:new THREE.Color(16711680),DC:new THREE.Color(16711680),DU:new THREE.Color(16711680),ARG:new THREE.Color(255),LYS:new THREE.Color(255),ASP:new THREE.Color(16711680),GLU:new THREE.Color(16711680),GLY:new THREE.Color(8947848),PRO:new THREE.Color(8947848),ALA:new THREE.Color(8947848),VAL:new THREE.Color(8947848),LEU:new THREE.Color(8947848),ILE:new THREE.Color(8947848),PHE:new THREE.Color(8947848),HIS:new THREE.Color(8947848),SER:new THREE.Color(8947848),THR:new THREE.Color(8947848),ASN:new THREE.Color(8947848),GLN:new THREE.Color(8947848),TYR:new THREE.Color(8947848),MET:new THREE.Color(8947848),CYS:new THREE.Color(8947848),TRP:new THREE.Color(8947848)},hydrophobicColors:{"  G":new THREE.Color(8947848),"  A":new THREE.Color(8947848),"  T":new THREE.Color(8947848),"  C":new THREE.Color(8947848),"  U":new THREE.Color(8947848)," DG":new THREE.Color(8947848)," DA":new THREE.Color(8947848)," DT":new THREE.Color(8947848)," DC":new THREE.Color(8947848)," DU":new THREE.Color(8947848),G:new THREE.Color(8947848),A:new THREE.Color(8947848),T:new THREE.Color(8947848),C:new THREE.Color(8947848),U:new THREE.Color(8947848),DG:new THREE.Color(8947848),DA:new THREE.Color(8947848),DT:new THREE.Color(8947848),DC:new THREE.Color(8947848),DU:new THREE.Color(8947848),ARG:new THREE.Color(8947848),LYS:new THREE.Color(8947848),ASP:new THREE.Color(8947848),GLU:new THREE.Color(8947848),GLY:new THREE.Color(65280),PRO:new THREE.Color(65280),ALA:new THREE.Color(65280),VAL:new THREE.Color(65280),LEU:new THREE.Color(65280),ILE:new THREE.Color(65280),PHE:new THREE.Color(65280),HIS:new THREE.Color(8947848),SER:new THREE.Color(8947848),THR:new THREE.Color(8947848),ASN:new THREE.Color(8947848),GLN:new THREE.Color(8947848),TYR:new THREE.Color(8947848),MET:new THREE.Color(8947848),CYS:new THREE.Color(8947848),TRP:new THREE.Color(8947848)},ssColors:{helix:new THREE.Color(16711808),sheet:new THREE.Color(16762880),coil:new THREE.Color(6324479)},defaultBondColor:new THREE.Color(12303291),surfaces:{1:void 0,2:void 0,3:void 0,4:void 0},hasCovalentBond:function(e,t){var i=this.covalentRadii[e.elem]+this.covalentRadii[t.elem];return e.coord.distanceToSquared(t.coord)<1.3*i*i},init:function(){this.structures={},this.chains={},this.residues={},this.secondaries={},this.alnChains={},this.chainsSeq={},this.chainsColor={},this.chainsAn={},this.chainsAnTitle={},this.alnChainsSeq={},this.alnChainsAnno={},this.alnChainsAnTtl={},this.dAtoms={},this.hAtoms={},this.pickedAtomList={},this.prevHighlightObjects=[],this.prevHighlightObjects_ghost=[],this.prevSurfaces=[],this.defNames2Residues={},this.defNames2Atoms={},this.defNames2Descr={},this.defNames2Command={},this.residueId2Name={},this.molTitle="",this.atoms={},this.dAtoms={},this.hAtoms={},this.proteins={},this.sidec={},this.nucleotides={},this.nucleotidesO3={},this.chemicals={},this.ions={},this.water={},this.calphas={},this.hbondpnts=[],this.stabilizerpnts=[],this.ssbondpnts={},this.doublebonds={},this.triplebonds={},this.aromaticbonds={},this.atomPrevColors={},this.style2atoms={},this.labels={},this.lines={},this.inputid={idtype:void 0,id:void 0},this.biomtMatrices=[],this.bAssembly=!1,this.rotateCount=0,this.rotateCountMax=20},reinitAfterLoad:function(){this.dAtoms=this.cloneHash(this.atoms),this.hAtoms=this.cloneHash(this.atoms),this.prevHighlightObjects=[],this.prevHighlightObjects_ghost=[],this.prevSurfaces=[],this.labels={},this.lines={},this.bAssembly=!1}},iCn3D.prototype.loadPDB=function(e){var t=[],i=[],o=e.split("\n"),r={},n={};this.init();var s,a,c,d=[],l=[],h=[],u=[],p=[],m=[],v=0,f=1,g="",E="",y="",b=0,C="",w=!1,T={},R={},H="structure",S=0,A="";for(var _ in o){var x=o[_],O=x.substr(0,6);if("HEADER"===O)H=x.substr(62,4),this.molTitle="";else if("TITLE "===O){var L=x.substr(10);this.molTitle+=L.trim()+" "}else if("HELIX "===O){this.bSecondaryStructure=!0;for(var D,I=x.substr(19,1),k=parseInt(x.substr(21,4)),M=parseInt(x.substr(33,4)),P=k;M>=P;++P)D=I+"_"+P,u.push(D),P===k&&p.push(D),P===M&&m.push(D);t.push({chain:I,initialResidue:k,initialInscode:x.substr(25,1),terminalResidue:M,terminalInscode:x.substr(37,1)})}else if("SHEET "===O){this.bSecondaryStructure=!0;for(var I=x.substr(21,1),k=parseInt(x.substr(22,4)),M=parseInt(x.substr(33,4)),P=k;M>=P;++P){var D=I+"_"+P;d.push(D),P===k&&l.push(D),P===M&&h.push(D)}i.push({chain:I,initialResidue:k,initialInscode:x.substr(26,1),terminalResidue:M,terminalInscode:x.substr(37,1)})}else if("HBOND "===O){bCalculateHbond=!1;var z=(x.substr(6,1),x.substr(8,4).replace(/ /g,""),x.substr(14,4).replace(/ /g,""),x.substr(18,1),x.substr(20,4).replace(/ /g,""),x.substr(25,4).replace(/ /g,""),parseFloat(x.substr(30,8))),N=parseFloat(x.substr(38,8)),j=parseFloat(x.substr(46,8)),F=parseFloat(x.substr(54,8)),U=parseFloat(x.substr(62,8)),V=parseFloat(x.substr(70,8));x.substr(78,8).replace(/ /g,"");this.hbondpnts.push(new THREE.Vector3(z,N,j)),this.hbondpnts.push(new THREE.Vector3(F,U,V))}else if("SSBOND"===O){var B=x.substr(15,1),G=x.substr(17,4).replace(/ /g,""),q=H+"_"+B+"_"+G,W=x.substr(29,1),Y=x.substr(31,4).replace(/ /g,""),X=H+"_"+W+"_"+Y;void 0===this.ssbondpnts[H]&&(this.ssbondpnts[H]=[]),this.ssbondpnts[H].push(q),this.ssbondpnts[H].push(X)}else if("REMARK"===O){var Q=parseInt(x.substr(7,3));if(350==Q&&"BIOMT"==x.substr(13,5)){var Z=parseInt(x[18])-1,K=parseInt(x.substr(21,2));void 0==this.biomtMatrices[K]&&(this.biomtMatrices[K]=(new THREE.Matrix4).identity()),this.biomtMatrices[K].elements[Z]=parseFloat(x.substr(24,9)),this.biomtMatrices[K].elements[Z+4]=parseFloat(x.substr(34,9)),this.biomtMatrices[K].elements[Z+8]=parseFloat(x.substr(44,9)),this.biomtMatrices[K].elements[Z+12]=parseFloat(x.substr(54,10))}else if(465==Q&&" "==x.substr(18,1)&&" "==x.substr(20,1)&&"S"!=x.substr(21,1)){var J=x.substr(15,3),ee=x.substr(19,1),te=parseInt(x.substr(21,5)),s=H+"_"+ee;void 0===R[s]&&(R[s]=[]);var ie={};ie.resi=te,ie.name=this.residueName2Abbr(J).toLowerCase(),ee!=A&&(S=0),!isNaN(te)&&(""==A||ee!=A||ee==A&&te>S)&&(R[s].push(ie),S=te,A=ee)}}else if("ENDMDL"===O)++f;else if("JRNL  "===O)"PMID"===x.substr(12,4)&&(this.pmid=x.substr(19).trim());else if("ATOM  "===O||"HETATM"===O){var oe=1===f?H:H+f.toString(),re=x.substr(16,1);if(" "!==re&&"A"!==re)continue;++v;var ne=parseInt(x.substr(6,5));T[ne]=v;var se=x.substr(76,2).replace(/ /g,"");""===se&&(se=x.substr(12,2).replace(/ /g,""));var ee=x.substr(21,1);""===ee&&(ee=1),s=oe+"_"+ee,s!==g&&(b=0,w=!1);var ae=x.substr(22,5).trim();c=s+"_"+ae,c!==y&&(w?++b:b=s!==g?0:parseInt(E.substr(E.lastIndexOf("_")+1)));var te=parseInt(ae);(ae!=te||w)&&(w=!0,te=0==b?te:b+1),a=s+"_"+te;var ce=x.substr(12,4).replace(/ /g,""),D=ee+"_"+te,de=parseFloat(x.substr(30,8)),le=parseFloat(x.substr(38,8)),he=parseFloat(x.substr(46,8)),J=x.substr(17,3),ue=new THREE.Vector3(de,le,he),pe={het:"H"===O[0],serial:v,name:ce,alt:re,resn:J,structure:oe,chain:ee,resi:te,coord:ue,b:parseFloat(x.substr(60,8)),elem:se,bonds:[],ss:"coil",ssbegin:!1,ssend:!1};this.atoms[v]=pe,this.dAtoms[v]=1,this.hAtoms[v]=1,-1!==$.inArray(D,u)?(this.atoms[v].ss="helix",-1!==$.inArray(D,p)&&(this.atoms[v].ssbegin=!0),-1!==$.inArray(D,m)&&(this.atoms[v].ssend=!0)):-1!==$.inArray(D,d)&&(this.atoms[v].ss="sheet",-1!==$.inArray(D,l)&&(this.atoms[v].ssbegin=!0),-1!==$.inArray(D,h)&&(this.atoms[v].ssend=!0));var me="-";if(me="helix"===this.atoms[v].ss?"H":"sheet"===this.atoms[v].ss?"E":!this.atoms[v].het&&this.residueColors.hasOwnProperty(this.atoms[v].resn.toUpperCase())?"c":"o",this.secondaries[a]=me,a!==E){var ve=this.residueName2Abbr(J);if(this.residueId2Name[a]=ve,1!==v&&(this.residues[E]=n),n={},s!==g){1!==v&&(this.chains[g]=this.unionHash(this.chains[g],r)),r={},void 0===this.structures[oe.toString()]&&(this.structures[oe.toString()]=[]),this.structures[oe.toString()].push(s),void 0===this.chainsSeq[s]&&(this.chainsSeq[s]=[]);var ie={};ie.resi=te,ie.name=ve,this.chainsSeq[s].push(ie)}else{var ie={};ie.resi=te,ie.name=ve,this.chainsSeq[s].push(ie)}}r[v]=1,n[v]=1,C=O,g=s,E=a,y=c}else if("CONECT"===O)for(var fe=parseInt(x.substr(6,5)),P=0;4>P;++P){var ge=parseInt(x.substr([11,16,21,26][P],5));isNaN(ge)||void 0!==this.atoms[T[fe]]&&this.atoms[T[fe]].bonds.push(T[ge])}else"TER   "===O&&++v}for(var Ee=Object.keys(this.structures),ye=0,be=Ee.length;be>ye;++ye){var oe=Ee[ye];if(oe!=H&&(void 0===this.ssbondpnts[oe]&&(this.ssbondpnts[oe]=[]),void 0!==this.ssbondpnts[H]))for(var P=0,Ce=this.ssbondpnts[H].length;Ce>P;++P){var we=this.ssbondpnts[H][P],Te=we.indexOf("_"),Re=oe+we.substr(Te);this.ssbondpnts[oe].push(Re)}}this.adjustSeq(R),o=null,this.residues[a]=n,this.chains[s]=this.unionHash2Atoms(this.chains[s],r);var He,Se,Ae=[],_e=this,xe=function(e){for(var t=Ae.length,i=0;t>i;++i){for(var o=Ae[i],r=i+1;t>r;++r){var n=Ae[r];o.alt===n.alt&&_e.hasCovalentBond(o,n)&&(o.bonds.push(n.serial),n.bonds.push(o.serial))}e&&e(o)}},Oe=new THREE.Vector3(9999,9999,9999),Le=new THREE.Vector3(-9999,-9999,-9999),De=new THREE.Vector3,Ie=0;for(var _ in this.atoms){var ce=this.atoms[_],ue=ce.coord;De.add(ue),Oe.min(ue),Le.max(ue),++Ie,ce.het?ce.het&&("HOH"===ce.resn||"WAT"===ce.resn?this.water[ce.serial]=1:-1!==$.inArray(ce.resn,this.ionsArray)||ce.elem.trim()===ce.resn.trim()?this.ions[ce.serial]=1:this.chemicals[ce.serial]=1):-1!==$.inArray(ce.resn,this.nucleotidesArray)?(this.nucleotides[ce.serial]=1,("O3'"===ce.name||"O3*"===ce.name)&&(this.nucleotidesO3[ce.serial]=1,this.secondaries[ce.structure+"_"+ce.chain+"_"+ce.resi]="o")):(this.proteins[ce.serial]=1,"CA"===ce.name&&(this.calphas[ce.serial]=1),"N"!==ce.name&&"CA"!==ce.name&&"C"!==ce.name&&"O"!==ce.name&&(this.sidec[ce.serial]=1)),(He!==ce.chain||Se!==ce.resi)&&(xe(function(e){("C"===e.name&&"N"===ce.name||"O3'"===e.name&&"P"===ce.name)&&_e.hasCovalentBond(e,ce)&&(e.bonds.push(ce.serial),ce.bonds.push(e.serial))}),He=ce.chain,Se=ce.resi,Ae.length=0),Ae.push(ce)}xe(),this.pmin=Oe,this.pmax=Le,this.cnt=Ie,this.maxD=this.pmax.distanceTo(this.pmin),this.center=De.multiplyScalar(1/this.cnt),this.maxD<5&&(this.maxD=5),this.oriMaxD=this.maxD,this.oriCenter=this.center.clone()},iCn3D.prototype.adjustSeq=function(e){for(var t in this.chainsSeq)if(void 0!==e[t]){var i,o,r,n=this.chainsSeq[t],s=e[t],a=n.length,c=s.length,d=new Array(a+c);for(i=0,o=0,r=0;a>i&&c>o;)n[i].resi<=s[o].resi?(d[r]=n[i],i++):(d[r]=s[o],o++),r++;if(a>i)for(var l=i;a>l;l++)d[r]=n[l],r++;else for(var l=o;c>l;l++)d[r]=s[l],r++;this.chainsSeq[t]=d}},iCn3D.prototype.createSphere=function(e,t,i,o,r){var n;void 0===t&&(t=.8),void 0===i&&(i=!1),void 0===o&&(o=1);var s=this.vdwRadii[e.elem]||t;if(2===r){o*=1.5;var a=this.hColor;n=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,color:a})),n.scale.x=n.scale.y=n.scale.z=i?t:s*(o?o:1),n.position.copy(e.coord),this.mdl.add(n)}else if(1===r)n=new THREE.Mesh(this.sphereGeometry,this.matShader),n.scale.x=n.scale.y=n.scale.z=i?t:s*(o?o:1),n.position.copy(e.coord),n.renderOrder=this.renderOrderPicking,this.mdl.add(n);else{void 0===e.color&&(e.color=this.defaultAtomColor);var a=e.color;if(n=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,color:a})),n.scale.x=n.scale.y=n.scale.z=i?t:s*(o?o:1),n.position.copy(e.coord),this.bImpo){this.posArraySphere.push(e.coord.x),this.posArraySphere.push(e.coord.y),this.posArraySphere.push(e.coord.z),this.colorArraySphere.push(e.color.r),this.colorArraySphere.push(e.color.g),this.colorArraySphere.push(e.color.b);var c=i?t:s*(o?o:1);this.radiusArraySphere.push(c),this.mdl_ghost.add(n)}else this.mdl.add(n)}1===r||2===r?this.bImpo?this.prevHighlightObjects_ghost.push(n):this.prevHighlightObjects.push(n):this.bImpo?this.objects_ghost.push(n):this.objects.push(n)},iCn3D.prototype.createCylinder=function(e,t,i,o,r,n,s){var a;1===r?(a=new THREE.Mesh(this.cylinderGeometryOutline,this.matShader),a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(e),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(i,i,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a.renderOrder=this.renderOrderPicking,this.mdl.add(a),this.prevHighlightObjects.push(a)):(2===r?(a=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,color:o})),i*=1.5):a=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,color:o})),a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(e),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(i,i,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),this.bImpo?(this.posArray.push(e.x),this.posArray.push(e.y),this.posArray.push(e.z),this.colorArray.push(o.r),this.colorArray.push(o.g),this.colorArray.push(o.b),this.pos2Array.push(t.x),this.pos2Array.push(t.y),this.pos2Array.push(t.z),void 0!==n?(this.color2Array.push(n.r),this.color2Array.push(n.g),this.color2Array.push(n.b)):(this.color2Array.push(o.r),this.color2Array.push(o.g),this.color2Array.push(o.b)),this.radiusArray.push(i),this.mdl_ghost.add(a)):this.mdl.add(a),2===r?this.bImpo?this.prevHighlightObjects_ghost.push(a):this.prevHighlightObjects.push(a):this.bImpo?this.objects_ghost.push(a):(void 0===s||s)&&this.objects.push(a))},iCn3D.prototype.createRepresentationSub=function(e,t,i){var o=this,r=[];for(var n in e){var s=e[n];t&&t(s);for(var a in s.bonds){var c=this.atoms[s.bonds[a]];void 0===c||c.serial<s.serial||(c.chain===s.chain&&(c.resi===s.resi||"C"===s.name&&"N"===c.name||"O3'"===s.name&&"P"===c.name||"O3*"===s.name&&"P"===c.name||"SG"===s.name&&"SG"===c.name)?i&&i(s,c):r.push([s.coord,c.coord]))}}if(r.length>0&&this.bShowCrossResidueBond)for(var d=new THREE.Color(65280),n=0,l=r.length;l>n;++n)o.createCylinder(r[n][0],r[n][1],this.cylinderRadius,d,0)},iCn3D.prototype.createSphereRepresentation=function(e,t,i,o,r){var n=this;this.createRepresentationSub(e,function(e){n.createSphere(e,t,i,o,r)})},iCn3D.prototype.createBoxRepresentation_P_CA=function(e,t,i){var o=this;this.createRepresentationSub(e,function(e){("CA"===e.name||"O3'"===e.name||"O3*"===e.name)&&o.createBox(e,void 0,void 0,t,void 0,i)})},iCn3D.prototype.createStickRepresentation=function(e,t,i,o,r,n){var s=this,a=void 0!==n&&n?t/s.cylinderRadius:1;this.createRepresentationSub(e,function(e){s.createSphere(e,t,!o,o,r)},function(e,t){var o=e.coord.clone().add(t.coord).multiplyScalar(.5),n=e.serial+"_"+t.serial;if(s.doublebonds.hasOwnProperty(n)){var c,d,l,h,u=new THREE.Vector3(Math.random(),Math.random(),Math.random());if(1==e.bonds.length&&1==t.bonds.length){h=t.coord.clone(),h.sub(e.coord);var p=u.clone();h.cross(p).normalize().multiplyScalar(.2*a)}else{if(e.bonds.length>=t.bonds.length&&e.bonds.length>1)c=e.serial,d=e.bonds[0],l=e.bonds[1];else{if(!(t.bonds.length>=e.bonds.length&&t.bonds.length>1))return void console.log("Double bond was not drawn due to the undefined cross plane");c=t.serial,d=t.bonds[0],l=t.bonds[1]}var m=s.atoms[c].coord.clone();m.sub(s.atoms[d].coord);var v=s.atoms[c].coord.clone();v.sub(s.atoms[l].coord),m.cross(v),0==parseInt(1e4*m.length())&&(m=new THREE.Vector3(.2,.3,.5)),h=t.coord.clone(),h.sub(e.coord),h.cross(m).normalize().multiplyScalar(.2*a),0==parseInt(1e4*h.length())&&(m=new THREE.Vector3(.5,.3,.2),h.cross(m).normalize().multiplyScalar(.2*a))}e.color===t.color?(s.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),s.cylinderRadius*a*.3,e.color,r),s.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),s.cylinderRadius*a*.3,e.color,r)):s.bImpo?(s.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),s.cylinderRadius*a*.3,e.color,r,t.color),s.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),s.cylinderRadius*a*.3,e.color,r,t.color)):(s.createCylinder(e.coord.clone().add(h),o.clone().add(h),s.cylinderRadius*a*.3,e.color,r),s.createCylinder(t.coord.clone().add(h),o.clone().add(h),s.cylinderRadius*a*.3,t.color,r),s.createCylinder(e.coord.clone().sub(h),o.clone().sub(h),s.cylinderRadius*a*.3,e.color,r),s.createCylinder(t.coord.clone().sub(h),o.clone().sub(h),s.cylinderRadius*a*.3,t.color,r))}else if(s.aromaticbonds.hasOwnProperty(n)){var c,d,l;if(e.bonds.length>t.bonds.length&&e.bonds.length>1)c=e.serial,d=e.bonds[0],l=e.bonds[1];else{if(!(t.bonds.length>1))return;c=t.serial,d=t.bonds[0],l=t.bonds[1]}var m=s.atoms[c].coord.clone();m.sub(s.atoms[d].coord);var v=s.atoms[c].coord.clone();v.sub(s.atoms[l].coord),m.cross(v);var h=t.coord.clone();h.sub(e.coord),h.cross(m).normalize().multiplyScalar(.2*a);for(var f=0,g=0,E=e.bondOrder.length;E>g;++g)"1.5"===e.bondOrder[g]&&e.bonds[g]!==t.serial&&(f=e.bonds[g]);var y="add";if(0===f)y="add";else{var b=e.coord.clone().add(h),C=e.coord.clone().sub(h),w=t.coord.clone().sub(b).normalize(),T=s.atoms[f].coord.clone().sub(b).normalize(),R=t.coord.clone().sub(C).normalize(),H=s.atoms[f].coord.clone().sub(C).normalize(),S=Math.acos(w.dot(T)),A=Math.acos(R.dot(H));y=A>S?"sub":"add"}if(e.color===t.color){var _,x;"add"===y?(s.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),s.cylinderRadius*a*.3,e.color,r),_=e.coord.clone().add(h),x=t.coord.clone().add(h).sub(_).multiplyScalar(1/11)):(s.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),s.cylinderRadius*a*.3,e.color,r),_=e.coord.clone().sub(h),x=t.coord.clone().sub(h).sub(_).multiplyScalar(1/11));for(var g=0;10>=g;++g)if(g%2==0){var O=_.clone().add(x.clone().multiplyScalar(g)),L=_.clone().add(x.clone().multiplyScalar(g+1));s.createCylinder(O,L,s.cylinderRadius*a*.3,e.color,r)}}else{var _,x;"add"===y?(s.createCylinder(e.coord.clone().sub(h),o.clone().sub(h),s.cylinderRadius*a*.3,e.color,r),s.createCylinder(t.coord.clone().sub(h),o.clone().sub(h),s.cylinderRadius*a*.3,t.color,r),_=e.coord.clone().add(h),x=t.coord.clone().add(h).sub(_).multiplyScalar(1/11)):(s.createCylinder(e.coord.clone().add(h),o.clone().add(h),s.cylinderRadius*a*.3,e.color,r),s.createCylinder(t.coord.clone().add(h),o.clone().add(h),s.cylinderRadius*a*.3,t.color,r),_=e.coord.clone().sub(h),x=t.coord.clone().sub(h).sub(_).multiplyScalar(1/11));for(var g=0;10>=g;++g)if(g%2==0){var O=_.clone().add(x.clone().multiplyScalar(g)),L=_.clone().add(x.clone().multiplyScalar(g+1));5>g?s.createCylinder(O,L,s.cylinderRadius*a*.3,e.color,r):s.createCylinder(O,L,s.cylinderRadius*a*.3,t.color,r)}}}else if(s.triplebonds.hasOwnProperty(n)){var u=new THREE.Vector3(Math.random(),Math.random(),Math.random()),p=t.coord.clone();
p.sub(e.coord);var R=u.clone();R.cross(p).normalize().multiplyScalar(.3*a),e.color===t.color?(s.createCylinder(e.coord,t.coord,s.cylinderRadius*a*.2,e.color,r),s.createCylinder(e.coord.clone().add(R),t.coord.clone().add(R),s.cylinderRadius*a*.2,e.color,r),s.createCylinder(e.coord.clone().sub(R),t.coord.clone().sub(R),s.cylinderRadius*a*.2,e.color,r)):s.bImpo?(s.createCylinder(e.coord,t.coord,s.cylinderRadius*a*.2,e.color,r,t.color),s.createCylinder(e.coord.clone().add(R),t.coord.clone().add(R),s.cylinderRadius*a*.2,e.color,r,t.color),s.createCylinder(e.coord.clone().sub(R),t.coord.clone().sub(R),s.cylinderRadius*a*.2,e.color,r,t.color)):(s.createCylinder(e.coord,o,s.cylinderRadius*a*.2,e.color,r),s.createCylinder(t.coord,o,s.cylinderRadius*a*.2,t.color,r),s.createCylinder(e.coord.clone().add(R),o.clone().add(R),s.cylinderRadius*a*.2,e.color,r),s.createCylinder(t.coord.clone().add(R),o.clone().add(R),s.cylinderRadius*a*.2,t.color,r),s.createCylinder(e.coord.clone().sub(R),o.clone().sub(R),s.cylinderRadius*a*.2,e.color,r),s.createCylinder(t.coord.clone().sub(R),o.clone().sub(R),s.cylinderRadius*a*.2,t.color,r))}else e.color===t.color?s.createCylinder(e.coord,t.coord,i,e.color,r):s.bImpo?s.createCylinder(e.coord,t.coord,i,e.color,r,t.color):(s.createCylinder(e.coord,o,i,e.color,r),s.createCylinder(t.coord,o,i,t.color,r))})},iCn3D.prototype.createLineRepresentation=function(e,t){var i=new THREE.Geometry;if(this.createRepresentationSub(e,void 0,function(e,t){if(e.color===t.color)i.vertices.push(e.coord),i.vertices.push(t.coord),i.colors.push(e.color),i.colors.push(t.color);else{var o=e.coord.clone().add(t.coord).multiplyScalar(.5);i.vertices.push(e.coord),i.vertices.push(o),i.vertices.push(t.coord),i.vertices.push(o),i.colors.push(e.color),i.colors.push(e.color),i.colors.push(t.color),i.colors.push(t.color)}}),2!==t){var o;1===t||(o=new THREE.Line(i,new THREE.LineBasicMaterial({linewidth:this.linewidth,vertexColors:!0}),THREE.LinePieces),this.mdl.add(o)),1===t?this.prevHighlightObjects.push(o):this.objects.push(o)}else 2===t&&this.createBoxRepresentation_P_CA(e,.8,t)},iCn3D.prototype.subdivide=function(e,t,i,o,r){var n=[],s=[],a=[],c=new Array;c.push(e[0]);for(var d=1,l=e.length-1;l>d;++d){var h=e[d],u=e[d+1];c.push(h.smoothen?h.clone().add(u).multiplyScalar(.5):h)}c.push(e[e.length-1]);for(var p=[],m=[],v=[],d=-1,f=c.length,g=1/i;f-3>=d;++d){var h=c[-1===d?0:d],u=c[d+1],E=c[d+2],y=c[d===f-3?f-1:d+3],b=E.clone().sub(h).multiplyScalar(.5),C=y.clone().sub(u).multiplyScalar(.5);d>-1&&(void 0===o||o[d+1])&&(n=n.concat(p),s=s.concat(m),a=a.concat(v)),p=[],m=[],v=[];for(var w=0;i>w;++w){var T=g*w,R=u.x+T*b.x+T*T*(-3*u.x+3*E.x-2*b.x-C.x)+T*T*T*(2*u.x-2*E.x+b.x+C.x),H=u.y+T*b.y+T*T*(-3*u.y+3*E.y-2*b.y-C.y)+T*T*T*(2*u.y-2*E.y+b.y+C.y),S=u.z+T*b.z+T*T*(-3*u.z+3*E.z-2*b.z-C.z)+T*T*T*(2*u.z-2*E.z+b.z+C.z);o?(o[d+1]&&w<=parseInt(i/2)&&(n.push(new THREE.Vector3(R,H,S)),s.push(o[d+1]),a.push(t[d+1])),o[d+2]&&w>parseInt(i/2)&&(p.push(new THREE.Vector3(R,H,S)),m.push(o[d+2]),v.push(t[d+2]))):(n.push(new THREE.Vector3(R,H,S)),s.push(d+1),a.push(t[d+1]))}}return(!o||o[d+1])&&(n=n.concat(p),s=s.concat(m),a=a.concat(v),n.push(c[c.length-1]),s.push(c.length-1),a.push(t[c.length-1])),p=[],m=[],v=[],c=[],pnts_positions=[],pnts_positions.push(n),pnts_positions.push(s),pnts_positions.push(a),pnts_positions},iCn3D.prototype.createCurveSubArrow=function(e,t,i,o,r,n,s,a,c,d,l,h,u){var p=[],m=[];p.push(e),m.push(a),this.prepareStrand(p,m,t,i,o,void 0,r,n,s,c,d,!1,l,h,u),p=[],m=[]},iCn3D.prototype.setCalphaDrawnCoord=function(e,t,i){var o=0;if(void 0!==i)for(var r=0,n=e.length;n>r;r+=t){var s=i[o];this.atoms.hasOwnProperty(s)&&(this.atoms[s].coord2=e[r].clone()),++o}},iCn3D.prototype.createCurveSub=function(e,t,i,o,r,n,s,a,c,d){if(0!==e.length){o=o||5;var l;if(s)l=e;else{var h=this.subdivide(e,i,o,a,r);l=h[0],i=h[2]}if(0!==l.length){if(this.setCalphaDrawnCoord(l,o,c),1===r){var u=this.coilWidth/2,p=4,m=!1;if(l.length>1)if(void 0!==d){for(var v,f,g=[],E=0,y=l.length;y>E;++E){if(v=d[E],v!==f&&v!==f+1&&void 0!==f||E===y-1){var b=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(g),g.length,u,p,m);mesh=new THREE.Mesh(b,this.matShader),mesh.renderOrder=this.renderOrderPicking,this.mdl.add(mesh),this.prevHighlightObjects.push(mesh),b=null,g=[]}g.push(l[E]),f=v}g=[]}else{var b=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(l),l.length,u,p,m);mesh=new THREE.Mesh(b,this.matShader),mesh.renderOrder=this.renderOrderPicking,this.mdl.add(mesh),this.prevHighlightObjects.push(mesh),b=null}}else{var C=new THREE.Geometry;if(2===r&&n)for(var E=0;E<l.length;++E)l[E].addScalar(.6),C.vertices.push(l[E]),C.colors.push(new THREE.Color(i[E]));else for(var E=0;E<l.length;++E)C.vertices.push(l[E]),C.colors.push(new THREE.Color(i[E]));var w=new THREE.Line(C,new THREE.LineBasicMaterial({linewidth:t,vertexColors:!0}),THREE.LineStrip);this.mdl.add(w),2===r?this.prevHighlightObjects.push(w):this.objects.push(w)}l=null}}},iCn3D.prototype.createCylinderCurve=function(e,t,i,o,r){var n,s,a,c=null,d=8;for(a in e){var l=e[a];if(!l.het&&-1!=t.indexOf(l.name)){if(null!==c&&n===l.chain&&s+1===l.resi&&Math.abs(c.coord.x-l.coord.x)<d&&Math.abs(c.coord.y-l.coord.y)<d&&Math.abs(c.coord.z-l.coord.z)<d){var h=c.coord.clone().add(l.coord).multiplyScalar(.5);if(r)1===r&&(this.createCylinder(c.coord,h,i,c.color,r),this.createCylinder(h,l.coord,i,l.color,r),this.createSphere(l,i,!0,1,r));else if(o){var u=this.createSingleLine(c.coord,h,c.color,!1);this.mdl.add(u),this.objects.push(u),u=this.createSingleLine(h,l.coord,l.color,!1),this.mdl.add(u),this.objects.push(u)}else this.createCylinder(c.coord,h,i,c.color),this.createCylinder(h,l.coord,i,l.color),this.createSphere(l,i,!0,1,r)}c=l,n=l.chain,s=l.resi,2===r&&this.createBox(l,void 0,void 0,void 0,void 0,r)}}if(null!==c&&n===l.chain&&s+1===l.resi&&Math.abs(c.coord.x-l.coord.x)<d&&Math.abs(c.coord.y-l.coord.y)<d&&Math.abs(c.coord.z-l.coord.z)<d){var h=c.coord.add(l.coord).multiplyScalar(.5);if(r)1===r&&(this.createCylinder(c.coord,h,i,c.color,r),this.createCylinder(h,l.coord,i,l.color,r),this.createSphere(l,i,!0,1,r));else if(o){var u=this.createSingleLine(c.coord,h,c.color,!1);this.mdl.add(u),this.objects.push(u),u=this.createSingleLine(h,l.coord,l.color,!1),this.mdl.add(u),this.objects.push(u)}else this.createCylinder(c.coord,h,i,c.color),this.createCylinder(h,l.coord,i,l.color)}},iCn3D.prototype.prepareStrand=function(e,t,i,o,r,n,s,a,c,d,l,h,u,p,m){if(1!==d.length){var v=[];v.push(o[o.length-2]),v.push(o[o.length-1]),r=r||this.axisDIV;for(var f,g,E,y,b=2/(c-1),C={},w=[],T=0,R=t.length;R>T;++T)C[T]=[];var H=this.subdivide(d,o,r),S=H[0];if(1!==S.length){for(var w=[],A=void 0===m||m?d.length-2:d.length,T=0,R=A;R>T;++T){for(var _=0,x=t.length;x>_;++_)C[_].push(e[_][T]);w.push(o[T])}if(w.push(o[T]),void 0===m||m)for(var T=0,R=t.length;R>T;++T)f=-1+b*t[T],g=S.length-1-r,E=d.length-2,y=new THREE.Vector3(S[g].x+l[E].x*f,S[g].y+l[E].y*f,S[g].z+l[E].z*f),C[T].push(y);for(var O,L=[],T=0,R=t.length;R>T;++T)O=this.subdivide(C[T],w,r,u,s),C[T]=O[0],o=O[2],0===T&&(L=O[1]);if(h?this.createStrip(C[0],C[1],o,r,n,s,!0,void 0,p,L):this.createCurveSub(C[0],i,o,r,s,a,!0,void 0,p,L),void 0===m||m){w=[],L=[];for(var _=0,x=t.length;x>_;++_){C[_]=[];for(var T=r*(d.length-2),R=r*(d.length-1);u[parseInt(T/r)]&&R>T;T+=r)for(var D=parseInt(T/r),I=0;r>I;++I){var f=-1+b*t[_],k=1.8;f=f*k*(r-I)/r;var M=parseInt(T/r),y=new THREE.Vector3(S[T+I].x+l[M].x*f,S[T+I].y+l[M].y*f,S[T+I].z+l[M].z*f);y.smoothen=!0,C[_].push(y),w.push(v[0]),0===_&&L.push(D)}var f=0,g=S.length-1,E=d.length-1,y=new THREE.Vector3(S[g].x+l[E].x*f,S[g].y+l[E].y*f,S[g].z+l[E].z*f);y.smoothen=!0,C[_].push(y),w.push(v[1]),0===_&&L.push(g)}S=[],h?this.createStrip(C[0],C[1],w,r,n,s,!0,void 0,void 0,L):this.createCurveSub(C[0],i,w,r,s,a,!0,void 0,void 0,L)}for(var T in C){for(var I=0,P=C[T].length;P>I;++I)C[T][I]=null;C[T]=[]}C={}}}},iCn3D.prototype.createStripArrow=function(e,t,i,o,r,n,s,a,c,d,l,h,u,p){var m=[],v=[];m.push(e),m.push(t),v.push(a),v.push(c),this.prepareStrand(m,v,void 0,i,o,r,n,void 0,s,d,l,!0,h,u,p),m=[],v=[]},iCn3D.prototype.createStrip=function(e,t,i,o,r,n,s,a,c,d){if(!(e.length<2)){if(o=o||this.axisDIV,!s){var l=this.subdivide(e,i,o,a,n),h=this.subdivide(t,i,o,a,n);e=l[0],t=h[0],i=l[2]}if(!(e.length<2)){if(this.setCalphaDrawnCoord(e,o,c),1===n){var u=this.coilWidth/2,p=4,m=!1;if(void 0!==d){for(var v,f,g=[],E=[],y=0,b=e.length;b>y;++y){if(v=d[y],v!==f&&v!==f+1&&void 0!==f||y===b-1){var C=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(g),g.length,u,p,m);z=new THREE.Mesh(C,this.matShader),z.renderOrder=this.renderOrderPicking,this.mdl.add(z),this.prevHighlightObjects.push(z),C=null;var w=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(E),E.length,u,p,m);z=new THREE.Mesh(w,this.matShader),z.renderOrder=this.renderOrderPicking,this.mdl.add(z),this.prevHighlightObjects.push(z),w=null,g=[],E=[]}g.push(e[y]),E.push(t[y]),f=v}g=[],E=[]}else{var C=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(e),e.length,u,p,m);z=new THREE.Mesh(C,this.matShader),z.renderOrder=this.renderOrderPicking,this.mdl.add(z),this.prevHighlightObjects.push(z),C=null;var w=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(t),t.length,u,p,m);z=new THREE.Mesh(w,this.matShader),z.renderOrder=this.renderOrderPicking,this.mdl.add(z),this.prevHighlightObjects.push(z),w=null}}else{for(var T,R,H,S,A,_=new THREE.Geometry,x=_.vertices,O=_.faces,y=0,L=e.length;L>y;++y)x.push(R=e[y]),x.push(R),x.push(H=t[y]),x.push(H),L-1>y&&(T=t[y].clone().sub(e[y]).cross(e[y+1].clone().sub(e[y])).normalize().multiplyScalar(r)),x.push(S=e[y].clone().add(T)),x.push(S),x.push(A=t[y].clone().add(T)),x.push(A);for(var D=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]],y=1,L=e.length;L>y;++y)for(var I=8*y,k=new THREE.Color(i[y-1]),M=0;4>M;++M)O.push(new THREE.Face3(I+D[M][0],I+D[M][1],I+D[M][2],void 0,k)),O.push(new THREE.Face3(I+D[M][3],I+D[M][0],I+D[M][2],void 0,k));for(var P=x.length-8,y=0;4>y;++y)x.push(x[2*y]),x.push(x[P+2*y]);P+=8,O.push(new THREE.Face3(P,P+2,P+6,void 0,O[0].color)),O.push(new THREE.Face3(P+4,P,P+6,void 0,O[0].color)),O.push(new THREE.Face3(P+1,P+5,P+7,void 0,O[O.length-3].color)),O.push(new THREE.Face3(P+3,P+1,P+7,void 0,O[O.length-3].color)),_.computeFaceNormals(),_.computeVertexNormals(!1);var z;2===n?(z=new THREE.Mesh(_,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(z),this.prevHighlightObjects.push(z)):(z=new THREE.Mesh(_,new THREE.MeshPhongMaterial({overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(z),this.objects.push(z))}e=null,t=null}}},iCn3D.prototype.createStrand=function(e,t,i,o,r,n,s,a,c){var d=o?!0:!1,l={};if(this.bAllAtoms)l=e;else{var h,u,p,m,v,f,g,E,y=0,b=Object.keys(e).length;l=this.cloneHash(e);for(var C in e){if(h=e[C].structure+"_"+e[C].chain,u=parseInt(e[C].resi),p=e[C],void 0===m&&(g=e[C]),h!==m&&void 0!==m||u!==v&&u!==v+1&&void 0!==v||y===b-1){h!==m&&void 0!==m||u!==v&&u!==v+1&&void 0!==v?E=f:y===b-1&&(E=p);var w=g.resi;if("coil"!==g.ss&&!g.ssbegin){for(var T=g.resi-1;T>0;--T){var R=g.structure+"_"+g.chain+"_"+T;if(!this.residues.hasOwnProperty(R))break;var H=this.getFirstAtomObj(this.residues[R]);if(H.ss===g.ss&&H.ssbegin){w=H.resi;break}}for(var T=w;T<g.resi;++T){var R=g.structure+"_"+g.chain+"_"+T;l=this.unionHash(l,this.hash2Atoms(this.residues[R]))}}if(3===this.pk&&1===c&&"coil"===g.ss){var R=g.structure+"_"+g.chain+"_"+(g.resi-1);this.residues.hasOwnProperty(R)&&(l=this.unionHash(l,this.hash2Atoms(this.residues[R])),e=this.unionHash(e,this.hash2Atoms(this.residues[R])))}var S=E.resi;if("coil"!==E.ss&&!E.ssend&&!E.notshow){for(var A=this.getLastAtomObj(this.chains[E.structure+"_"+E.chain]).resi,T=E.resi+1;A>=T;++T){var R=E.structure+"_"+E.chain+"_"+T;if(!this.residues.hasOwnProperty(R))break;var H=this.getFirstAtomObj(this.residues[R]);if(H.ss===E.ss&&H.ssend){S=H.resi;break}}for(var T=E.resi+1;S>=T;++T){var R=E.structure+"_"+E.chain+"_"+T;l=this.unionHash(l,this.hash2Atoms(this.residues[R]))}}if(3===this.pk&&1===c&&"coil"===E.ss){var R=E.structure+"_"+E.chain+"_"+(E.resi+1);this.residues.hasOwnProperty(R)&&(l=this.unionHash(l,this.hash2Atoms(this.residues[R])),e=this.unionHash(e,this.hash2Atoms(this.residues[R])))}E.notshow&&(E.notshow=void 0),g=p}m=h,v=u,f=p,++y}}2===c&&(o?(o=!1,t=null,i=null,r=null,n=null,a=void 0):(o=!0,t=2,i=void 0,r=void 0,n=void 0,a=this.ribbonthickness)),t=t||this.strandDIV,i=i||this.axisDIV,r=r||this.coilWidth,s=s||!1,n=n||this.helixSheetWidth;for(var _={},x=0;t>x;++x)_[x]=[];var O,L,D,H,I=[],k=[],M=[],P=[],z=[],N=null,j=null,F=null,U=null,V=null,B=null,G=null,q=null,W=!1,$=null,Y=null,v=null,X=null,Q=null,Z=!1,K=!1,J={};this.bCalphaOnly=this.isCalphaPhosOnly(l,"CA");var ee={};for(var T in l){var H=l[T];R=H.structure+"_"+H.chain+"_"+H.resi,ee[R]=1}var te=Object.keys(ee).length,ie=0,oe=0,re=Object.keys(this.hAtoms).length==Object.keys(this.atoms).length?!0:!1;for(var T in l){H=l[T];if(("O"===H.name||"CA"===H.name)&&!H.het&&("CA"===H.name&&(e.hasOwnProperty(T)&&("coil"===H.ss||H.ssend||H.ssbegin)&&(J[T]=H),N=H.coord,F=H.color,X=H.serial),"O"===H.name||this.bCalphaOnly&&"CA"===H.name)){"O"===H.name&&(j=H.coord);var ne=!0;if((O!==H.chain||L+1!==H.resi)&&(ne=!1),H.ssend&&"sheet"===H.ss?Z=!0:H.ssend&&"helix"===H.ss&&(K=!0),V){1===c||2===c?z.push(this.hColor):z.push(B),D="coil"!==q&&"coil"===H.ss?r:W&&H.ssbegin?r:"coil"===q?r:n;var se;"O"===H.name?(se=V.clone(),null!==U&&void 0!==U?se.sub(U):(U=V.clone(),se=new THREE.Vector3(Math.random(),Math.random(),Math.random()))):this.bCalphaOnly&&"CA"===H.name&&(se=new THREE.Vector3(Math.random(),Math.random(),Math.random())),se.normalize(),se.multiplyScalar(D),null!==G&&se.dot(G)<0&&se.negate(),G=se;for(var ae=0,ce=2/(t-1);t>ae;++ae){var de=-1+ce*ae,le=new THREE.Vector3(U.x+G.x*de,U.y+G.y*de,U.z+G.z*de);s||"sheet"!==q||(le.smoothen=!0),_[ae].push(le)}I.push(U),k.push(G),e.hasOwnProperty(Y)?(M.push(v),P.push(Q),++oe):(M.push(0),P.push(0)),++ie}if((H.ssbegin||H.ssend||ie===te-1)&&_[0].length>0&&ne){1===c||2===c?z.push(this.hColor):z.push(B),D=H.ssend&&"sheet"===H.ss?0:"coil"===q&&H.ssbegin?r:W&&H.ssbegin?r:"coil"===H.ss?r:n;var se;"O"===H.name?(se=j.clone(),se.sub(N)):this.bCalphaOnly&&"CA"===H.name&&(se=new THREE.Vector3(Math.random(),Math.random(),Math.random())),se.normalize(),se.multiplyScalar(D),null!==G&&se.dot(G)<0&&se.negate(),G=se;for(var ae=0,ce=2/(t-1);t>ae;++ae){var de=-1+ce*ae,le=new THREE.Vector3(N.x+G.x*de,N.y+G.y*de,N.z+G.z*de);s||"sheet"!==q||(le.smoothen=!0),_[ae].push(le)}$=H.serial,I.push(N),k.push(G),e.hasOwnProperty($)?(M.push(H.resi),P.push(X)):(M.push(0),P.push(0));for(var ae=0;!o&&t>ae;++ae)Z?this.createCurveSubArrow(_[ae],1,z,i,c,d,t,ae,I,k,M,P):re?this.createCurveSub(_[ae],1,z,i,c,d,!1,M,P):this.createCurveSubArrow(_[ae],1,z,i,c,d,t,ae,I,k,M,P,!1);if(o)if(Z){var he=0,ue=t-1;this.createStripArrow(_[0],_[t-1],z,i,a,c,t,he,ue,I,k,M,P)}else if(K)if(re)this.createStrip(_[0],_[t-1],z,i,a,c,!1,M,P);else{var he=0,ue=t-1;this.createStripArrow(_[0],_[t-1],z,i,a,c,t,he,ue,I,k,M,P)}else 2===c&&this.createStrip(_[0],_[t-1],z,i,a,c,!1,M,P);for(var x=0;t>x;++x)_[x]=[];z=[],I=[],k=[],M=[],P=[],Z=!1,K=!1}if((O!==H.chain||L+1!==H.resi)&&_[0].length>0){for(var ae=0;!o&&t>ae;++ae)Z?this.createCurveSubArrow(_[ae],1,z,i,c,d,t,ae,I,k,M,P):K&&(re?this.createCurveSub(_[ae],1,z,i,c,d,!1,M,P):this.createCurveSubArrow(_[ae],1,z,i,c,d,t,ae,I,k,M,P,!1));if(o)if(Z){var he=0,ue=t-1;this.createStripArrow(_[0],_[t-1],z,i,a,c,t,he,ue,I,k,M,P)}else if(K)if(re)this.createStrip(_[0],_[t-1],z,i,a,c,!1,M,P);else{var he=0,ue=t-1;this.createStripArrow(_[0],_[t-1],z,i,a,c,t,he,ue,I,k,M,P,!1)}for(var x=0;t>x;++x)_[x]=[];z=[],I=[],k=[],M=[],P=[],Z=!1,K=!1}O=H.chain,L=H.resi,q=H.ss,W=H.ssend,Y=H.serial,v=H.resi,Q=X,U=N,V=H.coord,B=F}}this.createTube(J,"CA",r,c),J={},_={}},iCn3D.prototype.createTubeSub=function(e,t,i,o){if(!(e.length<2)){var r=this.tubeDIV,n=this.axisDIV,s=1/r,a=1/n,c=new THREE.Geometry,d=this.subdivide(e,t,n),l=d[0];t=d[2];for(var h,u=new THREE.Vector3,p=0,m=l.length;m>p;++p){var v,f=(p-1)*a;if(0===p)v=i[0];else if(f%1===0)v=i[f];else{var g=Math.floor(f),E=f-g;v=i[g]*E+i[g+1]*(1-E)}var y,b,C;m-1>p?(y=l[p].clone().sub(l[p+1]),b=new THREE.Vector3(0,-y.z,y.y).normalize().multiplyScalar(v),C=y.clone().cross(b).normalize().multiplyScalar(v),u.dot(b)<0&&(b.negate(),C.negate()),u=b,h=C):(b=u,C=h);for(var w=0;r>w;++w){var T=2*Math.PI*s*w;c.vertices.push(l[p].clone().add(b.clone().multiplyScalar(Math.cos(T))).add(C.clone().multiplyScalar(Math.sin(T))))}}for(var R=0,p=0,m=l.length-1;m>p;++p){var H=new THREE.Color(t[p]),S=0,A=c.vertices[R].clone().sub(c.vertices[R+r]).lengthSq(),_=c.vertices[R].clone().sub(c.vertices[R+r+1]).lengthSq();A>_&&(A=_,S=1);for(var w=0;r>w;++w)c.faces.push(new THREE.Face3(R+w,R+(w+S)%r+r,R+(w+1)%r,void 0,H)),c.faces.push(new THREE.Face3(R+(w+1)%r,R+(w+S)%r+r,R+(w+S+1)%r+r,void 0,H));R+=r}c.computeFaceNormals(),c.computeVertexNormals(!1);var x;2===o?(x=new THREE.Mesh(c,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(x)):1===o?(x=new THREE.Mesh(c,this.matShader),x.renderOrder=this.renderOrderPicking,this.mdl.add(x)):(x=new THREE.Mesh(c,new THREE.MeshPhongMaterial({overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(x)),1===o||2===o?this.prevHighlightObjects.push(x):this.objects.push(x)}},iCn3D.prototype.createTube=function(e,t,i,o){var r,n,s,a=[],c=[],d=[],l=0;for(var h in e){var u=e[h];if(u.name===t&&!u.het){l>0&&(r!==u.chain||n+1!==u.resi||Math.abs(u.coord.x-s.coord.x)>6||Math.abs(u.coord.y-s.coord.y)>6||Math.abs(u.coord.z-s.coord.z)>6)&&(2!==o&&this.createTubeSub(a,c,d,o),a=[],c=[],d=[]),a.push(u.coord),d.push(i||(u.b>0?.01*u.b:.3)),c.push(u.color),r=u.chain,n=u.resi;var p=1.2;2!==o||u.ssbegin||this.createBox(u,void 0,void 0,p,void 0,o),++l,s=u}}2!==o&&this.createTubeSub(a,c,d,o)},iCn3D.prototype.createCylinderHelix=function(e,t,i){var o,r,n,s=null,a={},c={};for(n in e){var d=e[n];d.het||(("helix"!==d.ss&&"sheet"!==d.ss||d.ssend||d.ssbegin)&&(a[d.serial]=d),"sheet"===d.ss&&(c[d.serial]=d),"CA"===d.name&&("helix"===d.ss&&d.ssend&&(null!==s&&o===d.chain&&r<d.resi&&(1===i||2===i?this.createCylinder(s.coord,d.coord,t,this.hColor,i):this.createCylinder(s.coord,d.coord,t,d.color)),s=null),null===s&&"helix"===d.ss&&d.ssbegin&&(s=d,o=d.chain,r=d.resi)))}1===i||2===i?(Object.keys(a).length>0&&this.createTube(a,"CA",.3,i),Object.keys(c).length>0&&this.createStrand(c,void 0,void 0,!0,0,this.helixSheetWidth,!1,2*this.ribbonthickness,i)):(Object.keys(a).length>0&&this.createTube(a,"CA",.3),Object.keys(c).length>0&&this.createStrand(c,void 0,void 0,!0,0,this.helixSheetWidth,!1,2*this.ribbonthickness))},iCn3D.prototype.drawNucleicAcidStick=function(e,t){var i,o,r,n=null,s=null;for(r in e){var a=e[r];void 0===a||a.het||((a.resi!==o||a.chain!==i)&&(null!==n&&null!==s&&this.createCylinder(new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z),new THREE.Vector3(s.coord.x,s.coord.y,s.coord.z),this.cylinderRadius,n.color,t),n=null,s=null),("O3'"===a.name||"O3*"===a.name)&&(n=a),"  A"===a.resn||"  G"===a.resn||" DA"===a.resn||" DG"===a.resn?"N1"===a.name&&(s=a):"N3"===a.name&&(s=a),o=a.resi,i=a.chain)}null!==n&&null!==s&&this.createCylinder(new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z),new THREE.Vector3(s.coord.x,s.coord.y,s.coord.z),this.cylinderRadius,n.color,t)},iCn3D.prototype.isCalphaPhosOnly=function(e,t,i){var o=!1,r=0,n=30,s=!1;for(var a in e){if(!(n>r))break;if(e[a].name!==t&&(void 0==i||void 0!=i&&e.name!==i)){s=!0;break}++r}return s||(o=!0),o},iCn3D.prototype.drawCartoonNucleicAcid=function(e,t,i,o){this.drawStrandNucleicAcid(e,2,t,!0,void 0,i,o)},iCn3D.prototype.drawStrandNucleicAcid=function(e,t,i,o,r,n,s){2===s&&(t=void 0,n=void 0),r=r||this.nucleicAcidWidth,i=i||this.axisDIV,t=t||this.nucleicAcidStrandDIV;var a,c,d,l=[];for(d=0;t>d;d++)l[d]=[];var h,u,p,m=[],v=null;for(a in e){var f=e[a];if(void 0!==f&&("O3'"===f.name||"OP2"===f.name||"O3*"===f.name||"O2P"===f.name)&&!f.het)if("O3'"===f.name||"O3*"===f.name){if(h!==f.chain||u+1!==f.resi){if(p&&v)for(c=0;t>c;c++){var g=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(p.x+v.x*g,p.y+v.y*g,p.z+v.z*g))}for(o&&this.createStrip(l[0],l[1],m,i,n,s),c=0;!n&&t>c;c++)this.createCurveSub(l[c],1,m,i,s);var l=[];for(d=0;t>d;d++)l[d]=[];m=[],v=null}p=new THREE.Vector3(f.coord.x,f.coord.y,f.coord.z),h=f.chain,u=f.resi,1===s||2===s?m.push(this.hColor):m.push(f.color)}else if("OP2"===f.name||"O2P"===f.name){if(!p){v=null;continue}var E=new THREE.Vector3(f.coord.x,f.coord.y,f.coord.z);for(E.sub(p),E.normalize().multiplyScalar(r),null!==v&&E.dot(v)<0&&E.negate(),v=E,c=0;t>c;c++){var g=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(p.x+v.x*g,p.y+v.y*g,p.z+v.z*g))}p=null}}if(p&&v)for(c=0;t>c;c++){var g=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(p.x+v.x*g,p.y+v.y*g,p.z+v.z*g))}for(o&&this.createStrip(l[0],l[1],m,i,n,s),c=0;!n&&t>c;c++)this.createCurveSub(l[c],1,m,i,s)},iCn3D.prototype.createSingleLine=function(e,t,i,o,r){var n,s=new THREE.Geometry;n=o?new THREE.LineDashedMaterial({linewidth:1,color:i,dashSize:r,gapSize:.5*r}):new THREE.LineBasicMaterial({linewidth:1,color:i}),s.vertices.push(e),s.vertices.push(t),o&&s.computeLineDistances();var a=new THREE.Line(s,n,THREE.LinePieces);return a},iCn3D.prototype.createBox=function(e,t,i,o,r,n){var s;void 0===t&&(t=.8),void 0===i&&(i=!1),void 0===o&&(o=.8),n?(void 0===r&&(r=this.hColor),s=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,color:r}))):(void 0===r&&(r=e.color),s=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({overdraw:this.overdraw,specular:this.frac,shininess:30,emissive:0,color:r}))),s.scale.x=s.scale.y=s.scale.z=i?t:(this.vdwRadii[e.elem]||t)*(o?o:1),s.position.copy(e.coord),this.mdl.add(s),n?this.prevHighlightObjects.push(s):this.objects.push(s)},iCn3D.prototype.makeTextSprite=function(e,t){void 0===t&&(t={});var i=t.hasOwnProperty("fontface")?t.fontface:"Arial",o=t.hasOwnProperty("fontsize")?t.fontsize:18,r=t.hasOwnProperty("alpha")?t.alpha:1,n=!0,s=!1;t.hasOwnProperty("bSchematic")&&t.bSchematic&&(s=!0,o=40);var a,c,d;t.hasOwnProperty("backgroundColor")&&void 0!==t.backgroundColor?(a=this.hexToRgb(t.backgroundColor,r),c=t.hasOwnProperty("borderColor")?this.hexToRgb(t.borderColor,r):{r:0,g:0,b:0,a:1},d=t.hasOwnProperty("borderThickness")?t.borderThickness:4):(n=!1,a=void 0,c=void 0,d=0);var l=1,h=t.hasOwnProperty("textColor")&&void 0!==t.textColor?this.hexToRgb(t.textColor,l):{r:255,g:255,b:0,a:1},u=document.createElement("canvas"),p=u.getContext("2d");p.font="Bold "+o+"px "+i;var m=p.measureText(e),v=m.width,f=v+2*d,g=o+2*d;s&&(f>g?g=f:f=g);var E=s?3*this.maxD/100:3*this.maxD/100,y=.8*v/g;if(u.width=f,u.height=g,p.clearRect(0,0,f,g),n)if(p.fillStyle="rgba("+a.r+","+a.g+","+a.b+","+a.a+")",p.strokeStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")",p.lineWidth=d,s){var b=.35*f;this.circle(p,0,0,f,g,b)}else{var b=0;this.roundRect(p,0,0,f,g,b)}p.font="Bold "+o+"px "+i,p.textAlign="center",p.textBaseline="middle",p.fillStyle="rgba("+h.r+", "+h.g+", "+h.b+", 1.0)",p.strokeStyle="rgba("+h.r+", "+h.g+", "+h.b+", 1.0)",p.fillText(e,.5*f,.5*g);var C=new THREE.Texture(u);C.needsUpdate=!0;var w=!0,T=new THREE.SpriteMaterial({map:C,depthTest:!w,depthWrite:!w});T.map.minFilter=THREE.LinearFilter;var R=new THREE.Sprite(T);return s?R.scale.set(E,E,1):R.scale.set(y*E,E,1),R},iCn3D.prototype.roundRect=function(e,t,i,o,r,n){e.beginPath(),e.moveTo(t+n,i),e.lineTo(t+o-n,i),e.quadraticCurveTo(t+o,i,t+o,i+n),e.lineTo(t+o,i+r-n),e.quadraticCurveTo(t+o,i+r,t+o-n,i+r),e.lineTo(t+n,i+r),e.quadraticCurveTo(t,i+r,t,i+r-n),e.lineTo(t,i+n),e.quadraticCurveTo(t,i,t+n,i),e.closePath(),e.fill(),e.stroke()},iCn3D.prototype.circle=function(e,t,i,o,r,n){e.beginPath(),e.arc(t+o/2,i+r/2,n,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke()},iCn3D.prototype.createLabelRepresentation=function(e){this.maxD;for(var t in e)for(var i=void 0!==e[t]?e[t]:[],o=0,r=i.length;r>o;++o){var n=i[o];0==n.size&&(n.size=void 0),0==n.color&&(n.color=void 0),0==n.background&&(n.background=void 0);var s=void 0!==n.size?n.size:this.LABELSIZE,a=void 0!==n.color?n.color:"#ffff00",c=void 0!==n.background?n.background:"#cccccc",d=void 0!==n.alpha?n.alpha:1;c=n.background,void 0!==a&&void 0!==c&&a.toLowerCase()===c.toLowerCase()&&(a="#888888");var l=!1,h=!1;if(Object.keys(this.proteins).length+Object.keys(this.nucleotides).length>0){var u=this.getFirstAtomObj(this.hAtoms);void 0!==u&&((this.chemicals.hasOwnProperty(u.serial)||"c alpha trace"==u.style||"o3 trace"==u.style)&&(l=!0),("stick"==u.style||"ball and stick"==u.style)&&(h=!0))}var p;p=void 0!==n.bSchematic&&n.bSchematic?this.makeTextSprite(n.text,{fontsize:parseInt(s),textColor:a,borderColor:c,backgroundColor:c,alpha:d,bSchematic:1}):1===n.text.length?this.makeTextSprite(n.text,{fontsize:parseInt(s),textColor:a,borderColor:c,backgroundColor:c,alpha:d,bSchematic:1}):this.makeTextSprite(n.text,{fontsize:parseInt(s),textColor:a,borderColor:c,backgroundColor:c,alpha:d,bSchematic:0}),p.position.set(n.position.x,n.position.y,n.position.z),this.mdl.add(p)}},iCn3D.prototype.setAtmClr=function(e,t){for(var i in e){var o=this.atoms[i];o.color=(new THREE.Color).setHex(t),this.atomPrevColors[i]=o.color}},iCn3D.prototype.updateChainsColor=function(e){var t=e.structure+"_"+e.chain;void 0!==this.chainsColor[t]&&(this.chainsColor[t]=e.color)},iCn3D.prototype.setColorByOptions=function(e,t,i){if(void 0!==e)if(void 0!==i&&i)for(var o in t){var r=this.atoms[o];this.atomPrevColors[o]=r.color}else if(0===e.color.indexOf("#"))for(var o in t){var r=this.atoms[o];r.color=(new THREE.Color).setStyle(e.color.toLowerCase()),this.atomPrevColors[o]=r.color}else switch(e.color.toLowerCase()){case"spectrum":var n=0,s=1/this.cnt;for(var o in t){var r=this.atoms[o];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:(new THREE.Color).setHSL(2/3*(1-n++*s),1,.45),this.atomPrevColors[o]=r.color}break;case"chain":if(void 0!==this.chainsColor&&Object.keys(this.chainsColor).length>0){this.applyOriginalColor(this.hash2Atoms(this.hAtoms));var a=this.unionHash(this.chemicals,this.ions);for(var o in a){var r=this.atoms[o];r.color=this.atomColors[r.elem]||this.defaultAtomColor,this.atomPrevColors[o]=r.color}}else{var c=-1,d="",l=this.stdChainColors.length;for(var o in t){var r=this.atoms[o];r.chain!=d&&(++c,c%=l),r.color=this.stdChainColors[c],Object.keys(this.chainsColor).length>0&&this.updateChainsColor(r),this.atomPrevColors[o]=r.color,d=r.chain}}break;case"secondary structure":for(var o in t){var r=this.atoms[o];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:this.ssColors[r.ss]||new THREE.Color(255),this.atomPrevColors[o]=r.color}break;case"residue":for(var o in t){var r=this.atoms[o];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:this.residueColors[r.resn]||this.defaultResidueColor,this.atomPrevColors[o]=r.color}break;case"charge":for(var o in t){var r=this.atoms[o];r.color=r.het?this.defaultAtomColor:this.chargeColors[r.resn]||this.defaultResidueColor,this.atomPrevColors[o]=r.color}break;case"hydrophobic":for(var o in t){var r=this.atoms[o];r.color=r.het?this.defaultAtomColor:this.hydrophobicColors[r.resn]||this.defaultResidueColor,this.atomPrevColors[o]=r.color}break;case"atom":for(var o in t){var r=this.atoms[o];r.color=this.atomColors[r.elem]||this.defaultAtomColor,this.atomPrevColors[o]=r.color}break;case"conserved":for(var o in t){var r=this.atoms[o];r.color=this.defaultAtomColor,this.atomPrevColors[o]=r.color}for(var h in this.alnChainsSeq)for(var u=this.alnChainsSeq[h],o=0,p=u.length;p>o;++o){var m=h+"_"+u[o].resi;for(var v in this.residues[m])if(t.hasOwnProperty(v)){var f=new THREE.Color(u[o].color);this.atoms[v].color=f,this.atomPrevColors[v]=f}}break;case"white":this.setAtmClr(t,16777215);break;case"grey":this.setAtmClr(t,8947848);break;case"red":this.setAtmClr(t,16711680);break;case"green":this.setAtmClr(t,65280);break;case"blue":this.setAtmClr(t,255);break;case"magenta":this.setAtmClr(t,16711935);break;case"yellow":this.setAtmClr(t,16776960);break;case"cyan":this.setAtmClr(t,65535);break;case"custom":break;default:for(var o in t){var r=this.atoms[o];r.color=(new THREE.Color).setStyle("#"+e.color.toLowerCase()),this.atomPrevColors[o]=r.color}}},iCn3D.prototype.applyDisplayOptions=function(e,t,i){void 0===e&&(e=this.opts);var o,r={},n={},s={};if(1===i&&Object.keys(t).length<Object.keys(this.atoms).length){s=this.hash2Atoms(t);for(var a in s){var c=s[a];o=c.structure+"_"+c.chain+"_"+c.resi,r[o]=1}for(var a in r){var d=a.lastIndexOf("_"),l=a.substr(0,d+1),h=parseInt(a.substr(d+1)),u=l+(h-1).toString(),p=l+(h+1).toString();r.hasOwnProperty(u)||r.hasOwnProperty(u)||(n[a]=1)}if(1===Object.keys(s).length&&Object.keys(this.residues[o]).length>1&&"sphere"!==s[Object.keys(s)[0]].style&&"dot"!==s[Object.keys(s)[0]].style){if(void 0===this.bCid||!this.bCid)for(var a in s){var c=s[a],m=1;this.createBox(c,void 0,void 0,m,void 0,i)}}else for(var o in n){var c=this.getFirstAtomObj(this.residues[o]),u=c.structure+"_"+c.chain+"_"+parseInt(c.resi-1),p=c.structure+"_"+c.chain+"_"+parseInt(c.resi+1);if("cylinder and plate"===c.style&&"helix"===c.ss)for(var a in this.residues[o]){var c=this.atoms[a],m=1;this.createBox(c,void 0,void 0,m,void 0,i)}else if("ribbon"===c.style&&"coil"===c.ss||"strand"===c.style&&"coil"===c.ss||"o3 trace"===c.style||"schematic"===c.style||"c alpha trace"===c.style||"b factor tube"===c.style||"cylinder and plate"===c.style&&"helix"!==c.ss){var v=!1;if(!v&&this.residues.hasOwnProperty(p)){var f=Object.keys(this.residues[p])[0],g=this.hash2Atoms(this.residues[p])[f];if(c.style===g.style&&!g.ssbegin||g.ssbegin){var E=this.residues[p];if(t=this.unionHash(t,E),v=!0,g.ssbegin)for(var a in E)this.atoms[a].notshow=!0}}if(!v&&this.residues.hasOwnProperty(u)){var f=Object.keys(this.residues[u])[0],g=this.hash2Atoms(this.residues[u])[f];c.style===g.style&&(t=this.unionHash(t,this.residues[u]),v=!0)}}else if("ribbon"===c.style&&"coil"!==c.ss&&c.ssend||"strand"===c.style&&"coil"!==c.ss&&c.ssend){var v=!1;if(!v&&this.residues.hasOwnProperty(p)){var f=Object.keys(this.residues[p])[0],g=this.hash2Atoms(this.residues[p])[f];t=this.unionHash(t,this.residues[p]),v=!0}}}s={}}this.setStyle2Atoms(t),this.bAllAtoms=!1,t&&void 0!==t&&(this.bAllAtoms=Object.keys(t).length===Object.keys(this.atoms).length);var y=.5*this.cylinderRadius;void 0!==this.labels&&delete this.labels.schematic;for(var b in this.style2atoms){atomHash=this.style2atoms[b];var C=this.isCalphaPhosOnly(this.hash2Atoms(atomHash),"O3'","O3*");if("ribbon"===b)this.createStrand(this.hash2Atoms(atomHash),2,void 0,!0,void 0,void 0,!1,this.ribbonthickness,i);else if("strand"===b)this.createStrand(this.hash2Atoms(atomHash),null,null,null,null,null,!1,void 0,i);else if("cylinder and plate"===b)this.createCylinderHelix(this.hash2Atoms(atomHash),this.cylinderHelixRadius,i);else if("nucleotide cartoon"===b)C?this.createCylinderCurve(this.hash2Atoms(atomHash),["P"],this.traceRadius,!1,i):(this.drawCartoonNucleicAcid(this.hash2Atoms(atomHash),null,this.ribbonthickness,i),2!==i&&this.drawNucleicAcidStick(this.hash2Atoms(atomHash),i));else if("o3 trace"===b)C?this.createCylinderCurve(this.hash2Atoms(atomHash),["P"],this.traceRadius,!1,i):this.createCylinderCurve(this.hash2Atoms(atomHash),["O3'","O3*"],this.traceRadius,!1,i);else if("schematic"===b){var w=this.getFirstAtomObj(atomHash);this.chemicals.hasOwnProperty(w.serial)?(this.addNonCarbonAtomLabels(this.hash2Atoms(atomHash)),bSchematic=!0,this.createStickRepresentation(this.hash2Atoms(atomHash),y,y,void 0,i,bSchematic)):(this.addResiudeLabels(this.hash2Atoms(atomHash),!0),C?this.createCylinderCurve(this.hash2Atoms(atomHash),["P"],this.traceRadius,!1,i):this.createCylinderCurve(this.hash2Atoms(atomHash),["O3'","O3*"],this.traceRadius,!1,i),
this.createCylinderCurve(this.hash2Atoms(atomHash),["CA"],this.traceRadius,!1,i))}else"c alpha trace"===b?this.createCylinderCurve(this.hash2Atoms(atomHash),["CA"],this.traceRadius,!1,i):"b factor tube"===b?this.createTube(this.hash2Atoms(atomHash),"CA",null,i):"lines"===b?1===i?this.createStickRepresentation(this.hash2Atoms(atomHash),this.hlLineRadius,this.hlLineRadius,void 0,i):this.createLineRepresentation(this.hash2Atoms(atomHash),i):"stick"===b?this.createStickRepresentation(this.hash2Atoms(atomHash),this.cylinderRadius,this.cylinderRadius,void 0,i):"ball and stick"===b?this.createStickRepresentation(this.hash2Atoms(atomHash),this.cylinderRadius,.5*this.cylinderRadius,this.dotSphereScale,i):"sphere"===b?this.createSphereRepresentation(this.hash2Atoms(atomHash),this.sphereRadius,void 0,void 0,i):"dot"===b&&this.createSphereRepresentation(this.hash2Atoms(atomHash),this.sphereRadius,!1,this.dotSphereScale,i)}void 0!==this.labels&&Object.keys(this.labels).length>0&&(this.hideLabels(),this.createLabelRepresentation(this.labels))},iCn3D.prototype.hideLabels=function(){if(void 0!==this.mdl)for(var e=0,t=this.mdl.children.length;t>e;++e){var i=this.mdl.children[e];void 0!==i&&"Sprite"===i.type&&this.mdl.remove(i)}},iCn3D.prototype.getShader=function(e){var t=$NGL_shaderTextHash[e],i=/#include\s+(\S+)/gim;return t=t.replace(i,function(e,t){var i;return THREE.ShaderChunk.hasOwnProperty(t)&&(i=THREE.ShaderChunk[t]),i?i:""})},iCn3D.prototype.createImpostorShaderBase=function(e,t,i,o,r,n,s,a,c){var d=this,l=new THREE.ShaderMaterial({defines:d.defines,uniforms:d.uniforms,vertexShader:d.getShader(e+".vert"),fragmentShader:d.getShader(e+".frag"),depthTest:!0,depthWrite:!0,needsUpdate:!0,lights:!0});l.extensions.fragDepth=!0;for(var h,u,p=n*s,m=n*a,v=p>65535?Uint32Array:Uint16Array,f=new v(m),g=0;n>g;g++){h=g*a,u=g*s,f.set(i,h);for(var E=0;a>E;++E)f[h+E]+=u}var y=new THREE.BufferGeometry,b=!0;f&&(y.setIndex(new THREE.BufferAttribute(f,1)),y.getIndex().setDynamic(b));var C={f:1,v2:2,v3:3,c:3};for(var w in r){var T,R=r[w];T=new Float32Array(p*C[R.type]),y.addAttribute(w,new THREE.BufferAttribute(T,C[R.type]).setDynamic(b))}var R,H,S,A,_,x,O=y.attributes;for(var w in o){H=o[w],R=O[w],S=R.itemSize,A=R.array;for(var L=0;n>L;++L){m=L*S,_=m*s;for(var D=0;s>D;++D){x=_+S*D;for(var I=0;S>I;++I)A[x+I]=H[m+I]}}R.needsUpdate=!0}for(var k=y.attributes.mapping.array,g=0;n>g;g++)k.set(t,g*c*s);var M=new THREE.Mesh(y,l);M.frustumCulled=!1,M.scale.x=M.scale.y=M.scale.z=1,this.mdlImpostor.add(M)},iCn3D.prototype.createImpostorShaderCylinder=function(e){var t=this,i=new Float32Array(t.posArray),o=new Float32Array(t.colorArray),r=new Float32Array(t.pos2Array),n=new Float32Array(t.color2Array),s=new Float32Array(t.radiusArray),a=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),c=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]),d=12,l="v3",h=6,u=3,p=i.length/3,m={position1:i,color:o,position2:r,color2:n,radius:s},v={position1:{type:"v3",value:null},color:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:l,value:null}};this.createImpostorShaderBase(e,a,c,m,v,p,h,d,u)},iCn3D.prototype.createImpostorShaderSphere=function(e){var t=this,i=new Float32Array(t.posArraySphere),o=new Float32Array(t.colorArraySphere),r=new Float32Array(t.radiusArraySphere),n=new Float32Array([-1,1,-1,-1,1,1,1,-1]),s=new Uint16Array([0,1,2,1,3,2]),a=6,c="v2",d=4,l=2,h=i.length/3,u={position:i,color:o,radius:r},p={position:{type:"v3",value:null},color:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:c,value:null}};this.createImpostorShaderBase(e,n,s,u,p,h,d,a,l)},iCn3D.prototype.setStyle2Atoms=function(e){this.style2atoms={};for(var t in e)void 0===this.style2atoms[this.atoms[t].style]&&(this.style2atoms[this.atoms[t].style]={}),this.style2atoms[this.atoms[t].style][t]=1,void 0!==this.atoms[t].style2&&"nothing"!==this.atoms[t].style2&&(void 0===this.style2atoms[this.atoms[t].style2]&&(this.style2atoms[this.atoms[t].style2]={}),this.style2atoms[this.atoms[t].style2][t]=1)},iCn3D.prototype.setAtomStyleByOptions=function(e){void 0===e&&(e=this.opts);var t;if(void 0!==e.proteins){t=this.intHash(this.hAtoms,this.proteins);for(var i in t)this.atoms[i].style=e.proteins.toLowerCase()}if(void 0!==e.sidec&&"nothing"!==e.sidec){t=this.intHash(this.hAtoms,this.sidec);for(var i in t)this.atoms[i].style2=e.sidec.toLowerCase()}if(void 0!==e.chemicals){t=this.intHash(this.hAtoms,this.chemicals);for(var i in t)this.atoms[i].style=e.chemicals.toLowerCase()}if(void 0!==e.ions){t=this.intHash(this.hAtoms,this.ions);for(var i in t)this.atoms[i].style=e.ions.toLowerCase()}if(void 0!==e.water){t=this.intHash(this.hAtoms,this.water);for(var i in t)this.atoms[i].style=e.water.toLowerCase()}if(void 0!==e.nucleotides){t=this.intHash(this.hAtoms,this.nucleotides);for(var i in t)this.atoms[i].style=e.nucleotides.toLowerCase()}},iCn3D.prototype.rebuildSceneBase=function(e){var t=this;if(jQuery.extend(t.opts,e),this.cam_z=2*this.maxD,void 0!==this.scene)for(var i=this.scene.children.length-1;i>=0;i--){var o=this.scene.children[i];this.scene.remove(o)}else this.scene=new THREE.Scene;if(void 0!==this.scene_ghost)for(var i=this.scene_ghost.children.length-1;i>=0;i--){var o=this.scene_ghost.children[i];this.scene_ghost.remove(o)}else this.scene_ghost=new THREE.Scene;this.directionalLight=new THREE.DirectionalLight(16777215,1),this.cam_z>0?this.directionalLight.position.set(0,0,1):this.directionalLight.position.set(0,0,-1);var r=new THREE.AmbientLight(4210752);this.scene.add(this.directionalLight),this.scene.add(r),this.mdl=new THREE.Object3D,this.mdlImpostor=new THREE.Object3D,this.scene.add(this.mdl),this.scene.add(this.mdlImpostor),this.mdl_ghost=new THREE.Object3D,this.scene_ghost.add(this.mdl_ghost),this.objects=[],this.objects_ghost=[],this.raycaster=new THREE.Raycaster,this.projector=new THREE.Projector,this.mouse=new THREE.Vector2;var n=this.backgroundColors[this.opts.background.toLowerCase()];"transparent"===this.opts.background.toLowerCase()?this.renderer.setClearColor(n,0):this.renderer.setClearColor(n,1),this.perspectiveCamera=new THREE.PerspectiveCamera(20,this.container.whratio,.1,1e4),this.perspectiveCamera.position.set(0,0,this.cam_z),this.perspectiveCamera.lookAt(new THREE.Vector3(0,0,0)),this.orthographicCamera=new THREE.OrthographicCamera,this.orthographicCamera.position.set(0,0,this.cam_z),this.orthographicCamera.lookAt(new THREE.Vector3(0,0,0)),this.cams={perspective:this.perspectiveCamera,orthographic:this.orthographicCamera}},iCn3D.prototype.setCamera=function(){this.cam=this.cams[this.opts.camera.toLowerCase()],this.cam===this.perspectiveCamera?(this.cam_z>0?this.cam.position.z=2*this.maxD:this.cam.position.z=2*-this.maxD,"yes"===this.opts.slab?this.cam.near=2*this.maxD:this.cam.near=.1,this.cam.far=1e4,this.controls=new THREE.TrackballControls(this.cam,document.getElementById(this.id),this)):this.cam===this.orthographicCamera&&(this.cam.right=this.maxD/2*2.5,this.cam.left=-this.cam.right,this.cam.top=this.cam.right/this.container.whratio,this.cam.bottom=-this.cam.right/this.container.whratio,"yes"===this.opts.slab?this.cam.near=2*this.maxD:this.cam.near=0,this.cam.far=1e4,this.controls=new THREE.OrthographicTrackballControls(this.cam,document.getElementById(this.id),this)),this.cam.updateProjectionMatrix()},iCn3D.prototype.render=function(){this.directionalLight.position.copy(this.cam.position),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.render(this.scene,this.cam)},iCn3D.prototype.drawImpostorShader=function(){var e=this,t=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(e){this.value.copy(e.modelViewMatrix)}),i=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(e){this.value.getInverse(e.modelViewMatrix)}),o=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(e){this.value.getInverse(e.modelViewMatrix).transpose()}),r=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(t){this.value.multiplyMatrices(e.cam.projectionMatrix,t.modelViewMatrix)}),n=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(t){var i=new THREE.Matrix4;i.multiplyMatrices(e.cam.projectionMatrix,t.modelViewMatrix),this.value.getInverse(i)}),s=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(){this.value.copy(e.cam.projectionMatrix)}),a=new THREE.Uniform(new THREE.Matrix4).onUpdate(function(){this.value.getInverse(e.cam.projectionMatrix)}),c=this.backgroundColors[this.opts.background.toLowerCase()],d=2*this.maxD,l=3*this.maxD;this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,{modelViewMatrix:t,modelViewMatrixInverse:i,modelViewMatrixInverseTranspose:o,modelViewProjectionMatrix:r,modelViewProjectionMatrixInverse:n,projectionMatrix:s,projectionMatrixInverse:a,diffuse:{type:"v3",value:[1,1,1]},emissive:{type:"v3",value:[0,0,0]},roughness:{type:"f",value:.5},metalness:{type:"f",value:.3},opacity:{type:"f",value:1},nearClip:{type:"f",value:.1},ortho:{type:"f",value:0},shrink:{type:"f",value:.13},fogColor:{type:"v3",value:[c.r,c.g,c.b]},fogNear:{type:"f",value:d},fogFar:{type:"f",value:l},fogDensity:{type:"f",value:2}},THREE.UniformsLib.ambient,THREE.UniformsLib.lights]),this.defines={USE_COLOR:1,NEAR_CLIP:1,CAP:1},"yes"===this.opts.fog&&(this.defines.USE_FOG=1,"orthographic"===this.opts.camera&&(this.defines.FOG_EXP2=1)),this.bExtFragDepth&&(this.defines.USE_LOGDEPTHBUF_EXT=1),this.createImpostorShaderSphere("SphereImpostor"),this.createImpostorShaderCylinder("CylinderImpostor")},iCn3D.prototype.clearImpostors=function(){this.posArray=[],this.colorArray=[],this.pos2Array=[],this.color2Array=[],this.radiusArray=[],this.posArraySphere=[],this.colorArraySphere=[],this.radiusArraySphere=[]},iCn3D.prototype.applyTransformation=function(e,t,i){var o={};o.update=!1,o._zoomFactor=e,o.mouseChange=new THREE.Vector2,o.mouseChange.copy(t),o.quaternion=new THREE.Quaternion,o.quaternion.copy(i),this.controls.update(o)},iCn3D.prototype.applyCenterOptions=function(e){switch(void 0===e&&(e=this.opts),e.rotationcenter.toLowerCase()){case"molecule center":void 0!==this.center&&this.setRotationCenter(this.center);break;case"pick center":void 0!==this.pAtom&&this.setRotationCenter(this.pAtom.coord);break;case"display center":var t=this.centerAtoms(this.dAtoms).center;this.setRotationCenter(t);break;case"highlight center":var t=this.centerAtoms(this.hAtoms).center;this.setRotationCenter(t)}},iCn3D.prototype.setRotationCenter=function(e){this.mdl.position.set(0,0,0),this.mdlImpostor.position.set(0,0,0),this.mdl_ghost.position.set(0,0,0),this.mdl.position.sub(e),this.mdlImpostor.position.sub(e),this.mdl_ghost.position.sub(e)},iCn3D.prototype.applyOriginalColor=function(e){void 0===e&&(e=this.atoms);for(var t in e){var i=e[t],o=i.structure+"_"+i.chain;if(!this.chainsColor.hasOwnProperty(o))break;i.color=this.chainsColor[o]}},iCn3D.prototype.cloneHash=function(e){var t={};for(var i in e)t[i]=e[i];return t},iCn3D.prototype.residueName2Abbr=function(e){switch(void 0!==e&&" "!==e.charAt(0)&&" "===e.charAt(1)&&(e=e.charAt(0)),e){case"  A":return"A";case"  C":return"C";case"  G":return"G";case"  T":return"T";case"  U":return"U";case"  I":return"I";case" DA":return"A";case" DC":return"C";case" DG":return"G";case" DT":return"T";case" DU":return"U";case" DI":return"I";case"ALA":return"A";case"ARG":return"R";case"ASN":return"N";case"ASP":return"D";case"CYS":return"C";case"GLU":return"E";case"GLN":return"Q";case"GLY":return"G";case"HIS":return"H";case"ILE":return"I";case"LEU":return"L";case"LYS":return"K";case"MET":return"M";case"PHE":return"F";case"PRO":return"P";case"SER":return"S";case"THR":return"T";case"TRP":return"W";case"TYR":return"Y";case"VAL":return"V";case"SEC":return"U";case"HOH":return"O";case"WAT":return"O";default:return e}},iCn3D.prototype.intHash=function(e,t){var i={};if(Object.keys(e).length<Object.keys(t).length)for(var o in e)void 0!==t&&t[o]&&(i[o]=e[o]);else for(var o in t)void 0!==e&&e[o]&&(i[o]=t[o]);return e={},t={},i},iCn3D.prototype.exclHash=function(e,t){var i={};for(var o in e)o in t||(i[o]=e[o]);return e={},t={},i},iCn3D.prototype.unionHash=function(e,t){return this.unionHashNotInPlace(e,t)},iCn3D.prototype.unionHashNotInPlace=function(e,t){var i=jQuery.extend({},e,t);return e={},t={},i},iCn3D.prototype.intHash2Atoms=function(e,t){return this.hash2Atoms(this.intHash(e,t))},iCn3D.prototype.exclHash2Atoms=function(e,t){return this.hash2Atoms(this.exclHash(e,t))},iCn3D.prototype.unionHash2Atoms=function(e,t){return this.hash2Atoms(this.unionHash(e,t))},iCn3D.prototype.hash2Atoms=function(e){var t={};for(var i in e)t[i]=this.atoms[i];return e={},t},iCn3D.prototype.exportCanvas=function(){this.render(),window.open(this.renderer.domElement.toDataURL("image/png"))},iCn3D.prototype.zoomIn=function(e){var t={};t._zoomFactor=1-e,t.update=!0,this.controls.update(t),this.render()},iCn3D.prototype.zoomOut=function(e){var t={};t._zoomFactor=1+e,t.update=!0,this.controls.update(t),this.render()},iCn3D.prototype.rotateLeft=function(e){var t=new THREE.Vector3(0,1,0),i=-e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var o=new THREE.Quaternion;o.setFromAxisAngle(t,-i);var r={};r.quaternion=o,r.update=!0,this.controls.update(r),this.render()},iCn3D.prototype.rotateRight=function(e){var t=new THREE.Vector3(0,1,0),i=e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var o=new THREE.Quaternion;o.setFromAxisAngle(t,-i);var r={};r.quaternion=o,r.update=!0,this.controls.update(r),this.render()},iCn3D.prototype.rotateUp=function(e){var t=new THREE.Vector3(1,0,0),i=-e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var o=new THREE.Quaternion;o.setFromAxisAngle(t,-i);var r={};r.quaternion=o,r.update=!0,this.controls.update(r),this.render()},iCn3D.prototype.rotateDown=function(e){var t=new THREE.Vector3(1,0,0),i=e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var o=new THREE.Quaternion;o.setFromAxisAngle(t,-i);var r={};r.quaternion=o,r.update=!0,this.controls.update(r),this.render()},iCn3D.prototype.translateLeft=function(e){var t=new THREE.Vector2(0,0);t.x-=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.translateRight=function(e){var t=new THREE.Vector2(0,0);t.x+=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.translateUp=function(e){var t=new THREE.Vector2(0,0);t.y-=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.translateDown=function(e){var t=new THREE.Vector2(0,0);t.y+=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.showPickingBase=function(e){if(this.bShift||this.bCtrl||this.removeHlObjects(),this.pickedAtomList={},1===this.pk)this.pickedAtomList[e.serial]=1;else if(2===this.pk){var t=e.structure+"_"+e.chain+"_"+e.resi;this.pickedAtomList=this.residues[t]}else if(3===this.pk)this.pickedAtomList=this.selectStrandHelixFromAtom(e);else if(4===this.pk){var i=e.structure+"_"+e.chain;this.pickedAtomList=this.chains[i]}0===this.pk?this.bShowHighlight=!1:this.bShowHighlight=!0;var o=Object.keys(this.hAtoms).length==Object.keys(this.atoms).length?{}:this.intHash(this.hAtoms,this.pickedAtomList),r=Object.keys(o).length;if(this.bShift||this.bCtrl)if(this.bShift){if(void 0===this.prevPickedAtomList)this.hAtoms=this.unionHash(this.hAtoms,this.pickedAtomList);else{var n=this.getFirstAtomObj(this.prevPickedAtomList),s=this.getFirstAtomObj(this.pickedAtomList),a=n.structure+"_"+n.chain,c=s.structure+"_"+s.chain;if(a!=c)this.hAtoms=this.unionHash(this.hAtoms,this.pickedAtomList);else for(var d=this.unionHash(this.prevPickedAtomList,this.pickedAtomList),l=this.getFirstAtomObj(d),h=this.getLastAtomObj(d),u=l.serial;u<=h.serial;++u)this.hAtoms[u]=1}this.prevPickedAtomList=this.cloneHash(this.pickedAtomList)}else this.bCtrl&&(r>0?this.hAtoms=this.exclHash(this.hAtoms,this.pickedAtomList):this.hAtoms=this.unionHash(this.hAtoms,this.pickedAtomList));else this.hAtoms=this.cloneHash(this.pickedAtomList);this.removeHlObjects(),this.addHlObjects()},iCn3D.prototype.showPicking=function(e){this.showPickingBase(e);var t="."+e.chain+":"+e.resi,i=t+"@"+e.name,o={};o.picking=[];var r={};r.position=new THREE.Vector3(e.coord.x+1,e.coord.y+1,e.coord.z+1),1===this.pk?r.text=i:2===this.pk&&(r.text=t),(1===this.pk||2===this.pk)&&(o.picking.push(r),this.createLabelRepresentation(o))},iCn3D.prototype.removeHlObjects=function(){for(var e in this.prevHighlightObjects)this.mdl.remove(this.prevHighlightObjects[e]);this.prevHighlightObjects=[];for(var e in this.prevHighlightObjects_ghost)this.mdl.remove(this.prevHighlightObjects_ghost[e]);this.prevHighlightObjects_ghost=[]},iCn3D.prototype.addHlObjects=function(e,t,i){void 0===e&&(e=this.hColor),void 0===i&&(i=this.hAtoms),this.applyDisplayOptions(this.opts,this.intHash(i,this.dAtoms),this.bHighlight),(void 0===t||t)&&this.render()},iCn3D.prototype.switchHighlightLevelBase=function(){var e=this;$(document).bind("keydown",function(t){if(38===t.keyCode){if(t.preventDefault(),e.bShift||e.bCtrl||e.removeHlObjects(),1===e.highlightlevel){e.highlightlevel=2;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.residues[i.structure+"_"+i.chain+"_"+i.resi]):e.hAtoms=e.cloneHash(e.residues[i.structure+"_"+i.chain+"_"+i.resi])}else if(2===e.highlightlevel){e.highlightlevel=3;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.selectStrandHelixFromAtom(i)):e.hAtoms=e.cloneHash(e.selectStrandHelixFromAtom(i))}else if(3===e.highlightlevel){e.highlightlevel=4;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.chains[i.structure+"_"+i.chain]):e.hAtoms=e.cloneHash(e.chains[i.structure+"_"+i.chain])}else if(4===e.highlightlevel||5===e.highlightlevel){e.highlightlevel=5;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl||(e.hAtoms={});for(var o=e.structures[i.structure],r=0,n=o.length;n>r;++r)e.hAtoms=e.unionHash(e.hAtoms,e.chains[o[r]])}e.addHlObjects()}else if(40===t.keyCode){if(t.preventDefault(),e.removeHlObjects(),2!==e.highlightlevel&&1!==e.highlightlevel||1!==Object.keys(e.pickedAtomList).length){if(3===e.highlightlevel){var s={};for(var r in e.pickedAtomList)residueid=e.atoms[r].structure+"_"+e.atoms[r].chain+"_"+e.atoms[r].resi,s[residueid]=1;if(1===Object.keys(s).length){e.highlightlevel=2;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.residues[i.structure+"_"+i.chain+"_"+i.resi]):e.hAtoms=e.cloneHash(e.residues[i.structure+"_"+i.chain+"_"+i.resi])}}else if(4===e.highlightlevel){e.highlightlevel=3;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.selectStrandHelixFromAtom(i)):e.hAtoms=e.cloneHash(e.selectStrandHelixFromAtom(i))}else if(5===e.highlightlevel){e.highlightlevel=4;var i=e.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.chains[i.structure+"_"+i.chain]):e.hAtoms=e.cloneHash(e.chains[i.structure+"_"+i.chain])}}else e.highlightlevel=1,e.hAtoms=e.cloneHash(e.pickedAtomList),e.bShift||e.bCtrl?e.hAtoms=e.unionHash(e.hAtoms,e.pickedAtomList):e.hAtoms=e.cloneHash(e.pickedAtomList);e.addHlObjects()}})},iCn3D.prototype.switchHighlightLevel=function(){this.switchHighlightLevelBase()},iCn3D.prototype.resetOrientation=function(){var e=!1;if(this.commands.length>0){var t=this.commands[0].split("|||");if(2==t.length){var i=JSON.parse(t[1]);this._zoomFactor=i.factor,this.mouseChange.x=i.mouseChange.x,this.mouseChange.y=i.mouseChange.y,this.quaternion._x=i.quaternion._x,this.quaternion._y=i.quaternion._y,this.quaternion._z=i.quaternion._z,this.quaternion._w=i.quaternion._w,e=!0}}e||(this._zoomFactor=1,this.mouseChange=new THREE.Vector2(0,0),this.quaternion=new THREE.Quaternion(0,0,0,1)),this.maxD=this.oriMaxD,this.center=this.oriCenter.clone(),"show"==this.ori_chemicalbinding?this.bSkipChemicalbinding=!1:"hide"==this.ori_chemicalbinding&&(this.bSkipChemicalbinding=!0)},iCn3D.prototype.getAtomsFromPosition=function(e,t){var i,o;(void 0===t||null===t)&&(t=1);for(i in this.atoms){var o=this.atoms[i];if(this.ions.hasOwnProperty(i)&&"sphere"===this.opts.ions){var r=this.vdwRadii[o.elem];if(Math.abs(o.coord.x-e.x)-r>t)continue;if(Math.abs(o.coord.y-e.y)-r>t)continue;if(Math.abs(o.coord.z-e.z)-r>t)continue}else{if(o.coord.x<e.x-t||o.coord.x>e.x+t)continue;if(o.coord.y<e.y-t||o.coord.y>e.y+t)continue;if(o.coord.z<e.z-t||o.coord.z>e.z+t)continue}return o}return null},iCn3D.prototype.getFirstAtomObj=function(e){var t=Object.keys(e),i=t[0];return this.atoms[i]},iCn3D.prototype.getLastAtomObj=function(e){var t=Object.keys(e),i=t[t.length-1];return this.atoms[i]},iCn3D.prototype.hexToRgb=function(e,t){var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16),a:t}:null},iCn3D.prototype.selectStrandHelixFromAtom=function(e){for(var t=e,i=e,o={},r=t.resi,n=t.resi-1;n>0;--n){var s=t.structure+"_"+t.chain+"_"+n;if(!this.residues.hasOwnProperty(s))break;var e=this.getFirstAtomObj(this.residues[s]);if(r=e.resi,"coil"!==t.ss&&e.ss===t.ss&&e.ssbegin||"coil"===t.ss&&e.ss!==t.ss){"coil"===t.ss&&e.ss!==t.ss&&(r=e.resi+1);break}}for(var n=r;n<=t.resi;++n){var s=t.structure+"_"+t.chain+"_"+n;o=this.unionHash(o,this.hash2Atoms(this.residues[s]))}for(var a=i.resi,c=this.getLastAtomObj(this.chains[i.structure+"_"+i.chain]).resi,n=i.resi+1;c>=n;++n){var s=i.structure+"_"+i.chain+"_"+n;if(!this.residues.hasOwnProperty(s))break;var e=this.getFirstAtomObj(this.residues[s]);if(a=e.resi,"coil"!==i.ss&&e.ss===i.ss&&e.ssend||"coil"===i.ss&&e.ss!==i.ss){"coil"===i.ss&&e.ss!==i.ss&&(a=e.resi-1);break}}for(var n=i.resi+1;a>=n;++n){var s=i.structure+"_"+i.chain+"_"+n;o=this.unionHash(o,this.hash2Atoms(this.residues[s]))}return o},iCn3D.prototype.addNonCarbonAtomLabels=function(e){var t=18,i="#FFFFFF",o=this.intHash(this.hAtoms,e);void 0===this.labels.schematic&&(this.labels.schematic=[]);for(var r in o){var n=this.atoms[r];if(this.residues.hasOwnProperty(n.structure+"_"+n.chain+"_"+n.resi)&&"C"!==n.elem){var s={};s.position=n.coord,s.bSchematic=1,s.text=n.elem,s.size=t,s.color="#"+n.color.getHexString(),s.background=i,this.labels.schematic.push(s)}}this.removeHlObjects()},iCn3D.prototype.addResiudeLabels=function(e,t,i){var o=18,r="#CCCCCC";void 0===i&&(i=1);var n=this.intHash(this.hAtoms,e);t?void 0===this.labels.schematic&&(this.labels.schematic=[]):void 0===this.labels.residue&&(this.labels.residue=[]);var s="";for(var a in n){var c=this.atoms[a],d={},l=c.structure+"_"+c.chain+"_"+c.resi;if(!c.het&&("CA"===c.name||"O3'"===c.name||"O3*"===c.name)||this.water.hasOwnProperty(c.serial)||this.ions.hasOwnProperty(c.serial)||this.chemicals.hasOwnProperty(c.serial)&&l!==s){d.position=c.coord,d.bSchematic=0,t&&(d.bSchematic=1),d.text=this.residueName2Abbr(c.resn),d.size=o;var h=c.color.getHexString().toUpperCase();d.color="CCCCCC"===h||"C8C8C8"===h?"#888888":"#"+h,d.background=r,t?this.labels.schematic.push(d):this.labels.residue.push(d)}s=l}this.removeHlObjects()},iCn3D.prototype.rebuildScene=function(e){var t=this;this.rebuildSceneBase(e),this.applyDisplayOptions(this.opts,this.dAtoms),this.applyCenterOptions(),this.setCamera(),t.scene_ghost.updateMatrixWorld(!0)},iCn3D.prototype.draw=function(){this.rebuildScene(),this.bImpo&&this.drawImpostorShader(),void 0!==this.hAtoms&&Object.keys(this.hAtoms).length>0&&Object.keys(this.hAtoms).length<Object.keys(this.atoms).length&&(this.removeHlObjects(),(void 0===this.bShowHighlight||this.bShowHighlight)&&this.addHlObjects()),this.bRender===!0&&(this.applyTransformation(this._zoomFactor,this.mouseChange,this.quaternion),this.render()),this.clearImpostors()};var iCn3DUI=function(e){var t=this;t.bFullUi=!1,t.cfg=e,t.divid=t.cfg.divid,t.pre=t.divid+"_",t.inputid="",t.WIDTH=400,t.HEIGHT=400,t.RESIDUE_WIDTH=10,t.MENU_HEIGHT=0,t.MENU_WIDTH=$(window).width(),t.LESSWIDTH=0,t.LESSWIDTH_RESIZE=20,t.LESSHEIGHT=20,t.ROT_DIR="right",t.bHideSelection=!0,t.ALTERNATE_STRUCTURE=-1,t.EXTRAHEIGHT=0,t.GREY8="#888888",t.GREYB="#BBBBBB",t.GREYC="#CCCCCC",t.GREYD="#DDDDDD",t.bSelectResidue=!1,t.bSelectAlignResidue=!1,t.selectedResidues={},t.bCrashed=!1,t.prevCommands="",t.opts={},t.opts.camera="perspective",t.opts.background="transparent",t.opts.color="chain",t.opts.proteins="ribbon",t.opts.sidec="nothing",t.opts.nucleotides="nucleotide cartoon",t.opts.surface="nothing",t.opts.opacity="0.8",t.opts.wireframe="no",t.opts.chemicals="stick",t.opts.water="nothing",t.opts.ions="sphere",t.opts.hbonds="no",t.opts.rotationcenter="molecule center",t.opts.axis="no",t.opts.fog="no",t.opts.slab="no",t.opts.pk="residue",t.opts.chemicalbinding="hide",void 0!==t.cfg.cid&&(t.opts.pk="atom",t.opts.chemicals="ball and stick",t.opts.color="atom"),void 0!==t.cfg.options&&jQuery.extend(t.opts,t.cfg.options),t.modifyIcn3d()};if(iCn3DUI.prototype={constructor:iCn3DUI,modifyIcn3d:function(){var e=this;e.modifyIcn3dshowPicking()},modifyIcn3dshowPicking:function(){var e=this;iCn3D.prototype.showPicking=function(t){this.showPickingBase(t);var i,o=t.resn+t.resi;void 0!==e.cfg.cid?(i=t.name,this.pk=1):(i=o+"@"+t.name,this.pk=2);var r={};r.custom=[];var n={};n.position=new THREE.Vector3(t.coord.x+1,t.coord.y+1,t.coord.z+1),1===this.pk?n.text=i:2===this.pk&&(n.text=o),n.background="#CCCCCC",r.custom.push(n),this.createLabelRepresentation(r)}},show3DStructure:function(){var e=this,t=e.setHtml();$("#"+e.divid).html(t),e.setViewerWidthHeight();var i,o;i=-1!==e.cfg.width.toString().indexOf("%")?e.WIDTH*e.cfg.width.substr(0,e.cfg.width.toString().indexOf("%"))/100-e.LESSWIDTH:e.cfg.width,o=-1!==e.cfg.height.toString().indexOf("%")?e.HEIGHT*e.cfg.height.substr(0,e.cfg.height.toString().indexOf("%"))/100-e.EXTRAHEIGHT-e.LESSHEIGHT:e.cfg.height,$("#"+e.pre+"viewer").width(i).height(o),$("#"+e.pre+"canvas").width(i).height(o),parseInt(i)<=200&&$("#"+e.pre+"toolbox").hide(),e.allEventFunctions(),e.allCustomEvents(),e.icn3d=new iCn3D(e.pre+"canvas"),e.isMobile()||(e.icn3d.scaleFactor=2),e.handleContextLost(),void 0!==e.cfg.bCalphaOnly&&(e.icn3d.bCalphaOnly=e.cfg.bCalphaOnly),e.loadStructure()},setHtml:function(){var e=this,t="";return t+="<div id='"+e.pre+"viewer' style='position:relative; width:100%; height:100%;'>",t+="<div id='"+e.pre+"title' style='position:absolute; top:20px; left:80px; color:"+e.GREYD+";'></div>",void 0===e.cfg.mmtfid&&(t+="<div id='"+e.pre+"wait' style='width:100%; height: 100%; background-color: rgba(0,0,0, 0.8);'><div style='padding-top:15%; text-align: center; font-size: 2em; color: #FFFF00;'>Loading the structure...</div></div>"),t+="<canvas id='"+e.pre+"canvas' style='width:100%; height:100%; background-color: #000;'>Your browser does not support WebGL.</canvas>",t+="<div class='icn3d-tabBox' id='"+e.pre+"toolbox'>",t+="<span class='icn3d-bottomTab'>Tools</span>",t+="<div class='icn3d-insideTab' style='overflow: auto;'>",t+="<form action='' id='"+e.pre+"paraform' method='POST'>",void 0===e.cfg.cid?(t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Proteins&nbsp;</b>",t+="<select id='"+e.pre+"proteins'>",t+="<option value='ribbon' selected>Ribbon</option>",t+="<option value='strand'>Strand</option>",t+="<option value='cylinder and plate'>Cylinder and Plate</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='c alpha trace'>C Alpha Trace</option>",t+="<option value='b factor tube'>B Factor Tube</option>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Side Chains&nbsp;</b>",t+="<select id='"+e.pre+"sidec'>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing' selected>Hide</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Nucleotides&nbsp;</b>",t+="<select id='"+e.pre+"nucleotides'>",t+="<option value='nucleotide cartoon' selected>Cartoon</option>",t+="<option value='o3 trace'>O3' Trace</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Chemicals&nbsp;</b>",t+="<select id='"+e.pre+"chemicals'>",t+="<option value='lines'>Lines</option>",t+="<option value='stick' selected>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>"):(t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Chemicals&nbsp;</b>",t+="<select id='"+e.pre+"chemicals'>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick' selected>Ball and Stick</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>"),t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Color&nbsp;</b>",t+="<select id='"+e.pre+"color'>",void 0===e.cfg.cid?(t+="<option value='secondary structure'>Secondary Structure</option>",t+="<option value='charge'>Charge</option>",t+="<option value='hydrophobic'>Hydrophobic</option>",t+="<option value='chain' selected>Chain</option>",t+="<option value='residue'>Residue</option>",t+="<option value='atom'>Atom</option>"):t+="<option value='atom' selected>Atom</option>",void 0!==e.cfg.align&&(t+="<option value='conserved'>Identity</option>"),t+="<option value='red'>Red</option>",t+="<option value='green'>Green</option>",t+="<option value='blue'>Blue</option>",t+="<option value='magenta'>Magenta</option>",t+="<option value='yellow'>Yellow</option>",t+="<option value='cyan'>Cyan</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Camera&nbsp;</b>",t+="<select id='"+e.pre+"camera'>",t+="<option value='perspective' selected>Perspective</option>",t+="<option value='orthographic'>Orthographic</option>",t+="</select>",t+="</div>",e.isMobile()||(t+="<div class='icn3d-option'>",t+='&nbsp;&nbsp;<b>Select</b>: hold "Alt" and select<br/>',t+='&nbsp;&nbsp;<b>Union</b>: hold "Ctrl" to union<br/>',t+="&nbsp;&nbsp;<b>Switch</b>: after pk, press up/down arrow",t+="</div>"),t+="<div class='icn3d-option'>",t+="&nbsp;&nbsp;<button id='"+e.pre+"reset'>Reset</button> <button id='"+e.pre+"help'>Help</button>",t+="</div>",t+="</form>",t+="</div>",t+="</div>",t+="</div>",t+="<!-- dialog will not be part of the form -->",t+="<div id='"+e.pre+"alldialogs' class='icn3d-hidden'>",t+="</div>"},loadStructure:function(){var e=this;if(e.icn3d.molTitle="",void 0!==e.cfg.mmtfid)e.inputid=e.cfg.mmtfid,e.downloadMmtf(e.cfg.mmtfid);else if(void 0!==e.cfg.pdbid){e.inputid=e.cfg.pdbid;var t=e.cfg.pdbid.toLowerCase();e.downloadPdb(t)}else if(void 0!==e.cfg.mmdbid)e.inputid=e.cfg.mmdbid,e.downloadMmdb(e.cfg.mmdbid);else if(void 0!==e.cfg.gi){var i="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/elink.fcgi?dbfrom=protein&db=structure&linkname=protein_structure_direct&id="+e.cfg.gi;$.ajax({url:i,dataType:"text",cache:!0,tryCount:0,retryLimit:1,success:function(t){if(-1===t.indexOf("<Link>"))alert("There are no MMDB IDs available for the gi "+e.cfg.gi);else{var i=t.substr(t.indexOf("<Link>")),o=i.indexOf("<Id>"),r=i.indexOf("</Id>"),n=i.substr(o+4,r-o-4);e.inputid=n,
e.downloadMmdb(n)}},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}})}else if(void 0!==e.cfg.cid){e.inputid=e.cfg.cid;var o="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+e.cfg.cid+"/description/jsonp";$.ajax({url:o,dataType:"jsonp",tryCount:0,retryLimit:1,success:function(t){void 0!==t.InformationList&&void 0!==t.InformationList.Information&&(e.icn3d.molTitle=t.InformationList.Information[0].Title)},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}}),e.downloadCid(e.cfg.cid)}else if(void 0!==e.cfg.mmcifid)e.inputid=e.cfg.mmcifid,e.downloadMmcif(e.cfg.mmcifid);else if(void 0!==e.cfg.align)e.inputid=e.cfg.align,e.downloadAlignment(e.cfg.align);else if(void 0!==e.cfg.url){var r=e.cfg.url.split("|"),n=r[0],o=r[1];e.inputid=void 0,e.downloadUrl(o,n)}else alert("Please input a gi, MMDB ID, PDB ID, CID, or mmCIF ID...")},renderStructure:function(e){var t=this;e?(jQuery.extend(t.icn3d.opts,t.opts),t.icn3d.draw()):t.icn3d.draw()},selectAll:function(){var e=this;for(var t in e.icn3d.atoms)e.icn3d.hAtoms[t]=1},setCamera:function(e,t){var i=this;i.icn3d.opts[e]=t,i.icn3d.draw()},setColor:function(e,t){var i=this;i.icn3d.opts[e]=t,i.selectAll(),i.icn3d.setColorByOptions(i.icn3d.opts,i.icn3d.atoms),i.icn3d.draw()},setStyle:function(e,t){var i=this,o={};switch(i.selectAll(),e){case"proteins":o=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.proteins);break;case"sidec":o=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.sidec),calpha_atoms=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.calphas),o=i.icn3d.unionHash(o,calpha_atoms);break;case"nucleotides":o=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.nucleotides);break;case"chemicals":o=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.chemicals);break;case"ions":o=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.ions);break;case"water":o=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.water)}if("sidec"===e)for(var r in o)i.icn3d.atoms[r].style2=t;else for(var r in o)i.icn3d.atoms[r].style=t;i.icn3d.opts[e]=t,i.icn3d.draw()},clickTab:function(){$(".icn3d-bottomTab").click(function(e){var t=$(".icn3d-insideTab").height();0===t?$(".icn3d-insideTab").height(250):$(".icn3d-insideTab").height(0)})},changeProteinStyle:function(){var e=this;$("#"+e.pre+"proteins").change(function(t){t.preventDefault(),$("#"+e.pre+"sidec").val("nothing")})},clickReset:function(){var e=this;$("#"+e.pre+"reset").click(function(t){t.preventDefault(),e.icn3d.resetOrientation(),e.icn3d.draw()})},clickHelp:function(){var e=this;$("#"+e.pre+"help").click(function(e){e.preventDefault(),window.open("https://www.ncbi.nlm.nih.gov/Structure/icn3d/docs/icn3d_help.html","_blank")})},showSubsets:function(){var e=this;$("#"+e.pre+"filter").click(function(e){e.preventDefault();for(var t=document.getElementsByName(pre+"filter_ckbx"),i="",o="&het=0",r=0,n=t.length;n>r;++r)t[r].checked&&("chemicals"==t[r].value?o="&het=2":i+=t[r].value+",");""==i&&(i=t[0].value);var s=document.URL+"&mols="+i+"&complexity=2"+o;window.open(s,"_self")})},changeSelection:function(){var e=this;["camera","color","sidec","proteins","chemicals","water","ions","nucleotides"].forEach(function(t){$("#"+e.pre+t).change(function(i){"camera"===t?e.setCamera(t,$("#"+e.pre+t).val()):"color"===t?e.setColor(t,$("#"+e.pre+t).val()):e.setStyle(t,$("#"+e.pre+t).val())})})},allEventFunctions:function(){var e=this;e.clickTab(),e.changeProteinStyle(),e.clickReset(),e.clickHelp(),e.showSubsets(),e.windowResize(),e.changeSelection()},allCustomEvents:function(){},download2Ddgm:function(e,t){}},"undefined"==typeof jQuery)throw new Error("iCn3DUI requires jQuery");if("undefined"==typeof iCn3D)throw new Error("iCn3DUI requires iCn3D");iCn3DUI.prototype.rotStruc=function(e,t){var i=this;if(i.icn3d.bStopRotate)return!1;if(i.icn3d.rotateCount>i.icn3d.rotateCountMax)return i.icn3d.resetOrientation(),!1;if(++i.icn3d.rotateCount,void 0!==t&&t)if("left"===e)i.ROT_DIR="left";else if("right"===e)i.ROT_DIR="right";else if("up"===e)i.ROT_DIR="up";else{if("down"!==e)return!1;i.ROT_DIR="down"}if("left"===e&&"left"===i.ROT_DIR)i.icn3d.rotateLeft(1);else if("right"===e&&"right"===i.ROT_DIR)i.icn3d.rotateRight(1);else if("up"===e&&"up"===i.ROT_DIR)i.icn3d.rotateUp(1);else{if("down"!==e||"down"!==i.ROT_DIR)return!1;i.icn3d.rotateDown(1)}setTimeout(function(){i.rotStruc(e)},100)},iCn3DUI.prototype.showTitle=function(){var e=this;if(void 0!==e.icn3d.molTitle&&""!==e.icn3d.molTitle){var t=e.icn3d.molTitle;if(void 0===e.inputid)e.icn3d.molTitle.length>40&&(t=e.icn3d.molTitle.substr(0,40)+"..."),$("#"+e.pre+"title").html(t);else if(void 0!==e.cfg.cid){var i=e.getLinkToStructureSummary();$("#"+e.pre+"title").html("PubChem CID <a href='"+i+"' target='_blank' style='color:"+e.GREYD+"'>"+e.inputid.toUpperCase()+"</a>: "+t)}else if(void 0!==e.cfg.align)$("#"+e.pre+"title").html(t);else{var i=e.getLinkToStructureSummary();e.icn3d.molTitle.length>40&&(t=e.icn3d.molTitle.substr(0,40)+"...");var o=void 0!==e.asuAtomCount?" (Asymmetric Unit)":"";$("#"+e.pre+"title").html("PDB ID <a href='"+i+"' target='_blank' style='color:"+e.GREYD+"'>"+e.inputid.toUpperCase()+"</a>"+o+": "+t)}}else $("#"+e.pre+"title").html("")},iCn3DUI.prototype.getLinkToStructureSummary=function(e){var t=this,i="https://www.ncbi.nlm.nih.gov/structure/?term=";if(i=void 0!==t.cfg.cid?"https://www.ncbi.nlm.nih.gov/pccompound/?term=":-1!==t.inputid.indexOf(",")?"https://www.ncbi.nlm.nih.gov/structure/?term=":"https://www.ncbi.nlm.nih.gov/Structure/pdb/",void 0===t.inputid)i="https://www.ncbi.nlm.nih.gov/pccompound/?term="+t.molTitle;else{var o=t.inputid.split("_");1===o.length?(i+=t.inputid,void 0!==e&&e&&t.setLogCmd("link to Structure Summary "+t.inputid+": "+i,!1)):2===o.length&&(i+=o[0]+" OR "+o[1],void 0!==e&&e&&t.setLogCmd("link to structures "+o[0]+" and "+o[1]+": "+i,!1))}return i},iCn3DUI.prototype.isIE=function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");return t>0||navigator.userAgent.match(/Trident.*rv\:11\./)?!0:!1},iCn3DUI.prototype.getBlobFromBufferAndText=function(e,t){for(var i=this,o=new Uint8Array(e),r=new Uint8Array(t.length),n=0;n<t.length;++n)r[n]=i.passInt8([t.charCodeAt(n)])[0];var s=[];s.push(new Blob([o],{type:"application/octet-stream"})),s.push(new Blob([r],{type:"application/octet-stream"}));var a=new Blob(s,{type:"image/png"});return a},iCn3DUI.prototype.getTransformationStr=function(e){var t={factor:1,mouseChange:{x:0,y:0},quaternion:{_x:0,_y:0,_z:0,_w:1}};return t.factor=parseFloat(e.factor).toPrecision(5),t.mouseChange.x=parseFloat(e.mouseChange.x).toPrecision(5),t.mouseChange.y=parseFloat(e.mouseChange.y).toPrecision(5),t.quaternion._x=parseFloat(e.quaternion._x).toPrecision(5),t.quaternion._y=parseFloat(e.quaternion._y).toPrecision(5),t.quaternion._z=parseFloat(e.quaternion._z).toPrecision(5),t.quaternion._w=parseFloat(e.quaternion._w).toPrecision(5),"1.0000"==t.factor&&(t.factor=1),"0.0000"==t.mouseChange.x&&(t.mouseChange.x=0),"0.0000"==t.mouseChange.y&&(t.mouseChange.y=0),"0.0000"==t.quaternion._x&&(t.quaternion._x=0),"0.0000"==t.quaternion._y&&(t.quaternion._y=0),"0.0000"==t.quaternion._z&&(t.quaternion._z=0),"1.0000"==t.quaternion._w&&(t.quaternion._w=1),JSON.stringify(t)},iCn3DUI.prototype.createLinkForBlob=function(e,t){var i=document.createElement("a");i.href=window.URL.createObjectURL(e),i.setAttribute("download",t),document.body.appendChild(i),i.click(),document.body.removeChild(i)},iCn3DUI.prototype.saveFile=function(e,t,i){var o,r=this;if("command"===t){for(var n="",s=0,a=r.icn3d.commands.length;a>s;++s){var c=r.icn3d.commands[s].trim();if(s==a-1){var d=c.split("|||"),l={};l.factor=r.icn3d._zoomFactor,l.mouseChange=r.icn3d.mouseChange,l.quaternion=r.icn3d.quaternion,c=d[0]+"|||"+r.getTransformationStr(l)}n+=c+"\n"}var h=decodeURIComponent(n);o=new Blob([h],{type:"text;charset=utf-8;"})}else if("png"===t){r.icn3d.render();var u=!0;if(window.File&&window.FileReader&&window.FileList&&window.Blob||(u=!1),r.isIE()){if(o=r.icn3d.renderer.domElement.msToBlob(),u){var p=new FileReader;p.onload=function(t){var i=t.target.result,n=r.shareLinkUrl(),s="\nShare Link: "+n;o=r.getBlobFromBufferAndText(i,s),saveAs(o,e)},p.readAsArrayBuffer(o)}}else r.icn3d.renderer.domElement.toBlob(function(t){if(!u)return o=t,void saveAs(o,e);var i=new FileReader;i.onload=function(t){var i=t.target.result,n=r.shareLinkUrl(),s="\nShare Link: "+n;o=r.getBlobFromBufferAndText(i,s),saveAs(o,e)},i.readAsArrayBuffer(t)})}else if("html"===t){var n=i,h=decodeURIComponent(n);o=new Blob([h],{type:"text/html;charset=utf-8;"})}else if("text"===t){var h=i;o=new Blob(h,{type:"text;charset=utf-8;"})}else if("binary"===t){var h=i;o=new Blob(h,{type:"application/octet-stream"})}saveAs(o,e)},iCn3DUI.prototype.isMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},iCn3DUI.prototype.isMac=function(){return/Mac/i.test(navigator.userAgent)},iCn3DUI.prototype.isSessionStorageSupported=function(){var e="test";try{return sessionStorage.setItem(e,"1"),sessionStorage.removeItem(e),!0}catch(t){return!1}},iCn3DUI.prototype.resizeCanvas=function(e,t,i,o){var r=this;if(void 0!==i&&i||void 0!==r.cfg.resize&&r.cfg.resize){var n=t;$("#"+r.pre+"canvas").width(e).height(n),$("#"+r.pre+"viewer").width(e).height(t),r.icn3d.setWidthHeight(e,n),(void 0===o||o)&&r.icn3d.draw()}},iCn3DUI.prototype.handleContextLost=function(){var e=this,t=$("#"+e.pre+"canvas")[0];t.addEventListener("webglcontextlost",function(e){e.preventDefault()},!1),t.addEventListener("webglcontextrestored",function(t){console.log("WebGL context was lost. Reset WebGLRenderer and launch iCn3D again."),e.icn3d.renderer=new THREE.WebGLRenderer({canvas:e.icn3d.container.get(0),antialias:!0,preserveDrawingBuffer:!0,alpha:!0}),e.icn3d.draw()},!1)},iCn3DUI.prototype.windowResize=function(){var e=this;void 0!==e.cfg.resize&&e.cfg.resize&&!e.isMobile()&&$(window).resize(function(){e.WIDTH=$(window).width(),e.HEIGHT=$(window).height();var t=e.WIDTH-e.LESSWIDTH_RESIZE,i=e.HEIGHT-e.LESSHEIGHT-e.EXTRAHEIGHT;void 0!==e.icn3d&&e.resizeCanvas(t,i)})},iCn3DUI.prototype.setViewerWidthHeight=function(){var e=this;e.WIDTH=$(window).width(),e.HEIGHT=$(window).height();var t=$("#"+e.pre+"viewer").width(),i=$("#"+e.pre+"viewer").height();t&&e.WIDTH>t&&(e.WIDTH=t),i&&e.HEIGHT>i&&(e.HEIGHT=i),e.isMac()&&e.isMobile()&&(e.WIDTH<e.MENU_WIDTH&&(e.WIDTH=e.MENU_WIDTH),e.HEIGHT=$(window).height()/$(window).width()*e.MENU_WIDTH),-1===e.cfg.width.toString().indexOf("%")&&(e.WIDTH=parseInt(e.cfg.width)+e.LESSWIDTH),-1===e.cfg.height.toString().indexOf("%")&&(e.HEIGHT=parseInt(e.cfg.height)+e.EXTRAHEIGHT+e.LESSHEIGHT)},iCn3DUI.prototype.showLoading=function(){var e=this;$("#"+e.pre+"wait")&&$("#"+e.pre+"wait").show(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").hide(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").hide()},iCn3DUI.prototype.hideLoading=function(){var e=this;void 0!==e.bCommandLoad&&e.bCommandLoad||($("#"+e.pre+"wait")&&$("#"+e.pre+"wait").hide(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").show(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").show())},iCn3DUI.prototype.downloadMmcif=function(e){var t,i,o=this;t="https://files.rcsb.org/view/"+e+".cif",i="text",o.icn3d.bCid=void 0,$.ajax({url:t,dataType:i,cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){o.showLoading()},complete:function(){o.hideLoading()},success:function(e){t="https://www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi",$.ajax({url:t,type:"POST",data:{mmciffile:e},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){o.showLoading()},complete:function(){o.hideLoading()},success:function(e){o.loadMmcifData(e)},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}})},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}})},iCn3DUI.prototype.loadMmcifData=function(e){var t=this;if(void 0===e.atoms)return alert("invalid atoms data."),!1;t.icn3d.init(),t.loadAtomDataIn(e,e.mmcif,"mmcifid"),void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide();for(var i=e.assembly,o=0,r=i.length;r>o;++o){void 0==t.icn3d.biomtMatrices[o]&&(t.icn3d.biomtMatrices[o]=(new THREE.Matrix4).identity());for(var n=0,s=i[o].length;s>n;++n)t.icn3d.biomtMatrices[o].elements[n]=i[o][n]}t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()},iCn3DUI.prototype.downloadMmdb=function(e,t){var i,o=this;i=void 0!==t&&t?"https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?v=2&program=icn3d&b&gi="+e:"https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?v=2&program=icn3d&b&uid="+e,o.icn3d.bCid=void 0,void 0!==o.cfg.inpara&&(i+=o.cfg.inpara),void 0===o.chainids2resids&&(o.chainids2resids={}),$.ajax({url:i,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){o.showLoading()},complete:function(){o.hideLoading()},success:function(e){o.icn3d.init(),o.interactionData={moleculeInfor:e.moleculeInfor,intrac:e.intrac,intracResidues:e.intracResidues},o.mmdb_data=e;var t=void 0!==e.pdbId?e.pdbId:e.mmdbId;o.inputid=t,o.asuAtomCount=e.asuAtomCount;var i=e.moleculeInfor,r={},n={},s={};o.icn3d.chainsColor={};var a="<table width='100%'><tr><td></td><th>#</th><th align='center'>Chain</th><th align='center'>Residue Count</th></tr>",c=1,d={};for(var l in i){var h="#"+("000000"+i[l].color.toString(16)).slice(-6),u=i[l].chain.trim();void 0===d[u]?d[u]=1:++d[u];var p=1===d[u]?u:u+d[u].toString(),m=t+"_"+p;a+="<tr style='color:"+h+"'><td><input type='checkbox' name='"+o.pre+"filter_ckbx' value='"+l+"' chain='"+m+"'/></td><td align='center'>"+c+"</td><td align='center'>"+p+"</td><td align='center'>"+i[l].resCount+"</td></tr>",r[l]=h,n[m]=l,s[l]=m,o.icn3d.chainsColor[m]=new THREE.Color(h),++c}return void 0!==o.icn3d.chemicals&&Object.keys(o.icn3d.chemicals).length>0&&(a+="<tr><td><input type='checkbox' name='"+o.pre+"filter_ckbx' value='chemicals'/></td><td align='center'>"+c+"</td><td align='center'>Chemicals</td><td align='center'>"+Object.keys(o.icn3d.chemicals).length+" atoms</td></tr>"),a+="</table>",o.icn3d.molid2color=r,o.icn3d.chain2molid=n,o.icn3d.molid2chain=s,$("#"+o.pre+"accordion5").show(),o.loadAtomDataIn(e,t,"mmdbid"),void 0===o.cfg.align&&1==Object.keys(o.icn3d.structures).length&&null!==$("#"+o.pre+"alternateWrapper")&&$("#"+o.pre+"alternateWrapper").hide(),o.icn3d.setAtomStyleByOptions(o.opts),o.icn3d.setColorByOptions(o.opts,o.icn3d.atoms,!0),o.renderStructure(),void 0!==o.cfg.rotate&&o.rotStruc(o.cfg.rotate,!0),o.html2ddgm="",void 0!==o.cfg.show2d&&o.cfg.show2d&&(o.openDialog(o.pre+"dl_2ddgm","Interactions"),o.download2Ddgm(o.inputid.toUpperCase())),void 0!==o.deferred&&o.deferred.resolve(),void 0!==o.deferred2&&o.deferred2.resolve(),void 0===e.atoms&&void 0===e.molid2rescount?(alert("invalid MMDB data."),!1):void 0},error:function(i,r,n){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void(t?alert("This gi "+e+" has no corresponding 3D structure..."):alert("This mmdbid "+e+" with the parameters "+o.cfg.inpara+" has no corresponding 3D structure..."))}})},iCn3DUI.prototype.downloadGi=function(e){var t=this;t.icn3d.bCid=void 0;var i=!0;t.downloadMmdb(e,i)},iCn3DUI.prototype.getMissingResidues=function(e,t,i){for(var o=this,r=-9999,n=0,s=!0,a=0,c=e.length;c>a;++a){var d,l;"mmdbid"===t?(d=e[a][1],l=0):"mmcifid"===t?(d=e[a][1],d=o.icn3d.residueName2Abbr(d),l=0):"align"===t&&(d=e[a][2],l=1);var h={};h.resi=a+1;var u=parseInt(e[a][l]),p=a==c-1?9999:parseInt(e[a+1][l]);if(0!==u||0===u&&(-1===r||1==p)){if(h.name=d.toLowerCase(),s&&n>0){void 0===o.countNextresiArray[i]&&(o.countNextresiArray[i]=[]);var m=[n,parseInt(e[a][0])];o.countNextresiArray[i].push(m),n=0}s=!1}else h.name=d.toLowerCase(),++n,s=!0;void 0===o.icn3d.chainsSeq[i]&&(o.icn3d.chainsSeq[i]=[]);var v="";h.resi%10===0&&(v=h.resi.toString()),o.icn3d.chainsSeq[i].push(h),r=u}},iCn3DUI.prototype.loadAtomDataIn=function(e,t,i,o){var r=this,n=new THREE.Vector3(9999,9999,9999),s=new THREE.Vector3(-9999,-9999,-9999),a=new THREE.Vector3,c=e.atoms,d=0,l=0,h={},u={};r.pmid=e.pubmedId;var p={},m={},v={};if(r.chainid2title={},r.chainid2sid={},"align"===i){r.pmid="";var f=-1!==r.cfg.inpara.indexOf("atype=1")?"Invariant Core ":"";r.icn3d.molTitle=f+"Structure Alignment of ";for(var g=0,E=e.alignedStructures[0].length;E>g;++g){var y=e.alignedStructures[0][g];1===g&&(r.icn3d.secondId=y.pdbId);for(var b=y.pdbId,C=y.mmdbId,w=y.serialInterval[0],T=y.serialInterval[1];T>=w;++w)h[w]=b.toString(),u[C]=b;for(var w=0,T=y.molecules.length;T>w;++w){var R=y.molecules[w].chain,H=y.molecules[w].kind,S=y.molecules[w].name,A=y.molecules[w].sequence,_=y.molecules[w].sid,x=b+"_"+R;p[x]=A,m[x]=H,r.chainid2title[x]=S,void 0!==_&&(r.chainid2sid[x]=_)}r.icn3d.molTitle+='<a href="https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdbsrv.cgi?uid='+y.pdbId.toUpperCase()+'" target="_blank" style="color: '+r.GREYD+';">'+y.pdbId.toUpperCase()+"</a>",void 0!==y.descr&&(r.pmid+=y.descr.pubmedid),0===g&&(r.icn3d.molTitle+=" and ",void 0!==y.descr&&(r.pmid+="_"))}r.icn3d.molTitle+=" from VAST+"}else if(void 0!==e.descr&&(r.icn3d.molTitle+=e.descr.name),"mmdbid"===i){var b=e.pdbId,O={};for(var L in e.moleculeInfor){var R=e.moleculeInfor[L].chain.trim(),x=b+"_"+R;O.hasOwnProperty(R)?(++O[R],x+=O[R]):O[R]=1;var H=e.moleculeInfor[L].kind,D=e.moleculeInfor[L].color,_=e.moleculeInfor[L].sid;m[x]=H,v[x]=D,void 0!==_&&(r.chainid2sid[x]=_)}}if(r.countNextresiArray={},"mmdbid"===i||"mmcifid"===i)for(var R in e.sequences){var I=e.sequences[R],x=t+"_"+R;"mmcifid"===i&&(x="1_"+R),r.getMissingResidues(I,i,x)}else if("align"===i)for(var x in p){var I=p[x];r.getMissingResidues(I,i,x)}var k,L,M={},P="",z="",N="",j="",F="",U="",V=-999,l=0,B=0,G=!0,q=[],W="",Y="";r.mmdbMolidResid2mmdbChainResi={};var X=r.icn3d.isCalphaPhosOnly(c,"O3'","O3*");for(var g in c){++d,M[g]=d;var Q=c[g];Q.serial=d;var Z;"mmdbid"===i||"mmcifid"===i?Z=t:"align"===i&&(Z=h[d]);var K=0;if("mmdbid"===i||"align"===i?(Q.resi_ori=parseInt(Q.resi),Q.resi=Q.ids.r,K=Q.resi-Q.resi_ori):Q.resi=parseInt(Q.resi),Z!==Y&&(q=[]),void 0!==Q.chain||"mmdbid"!==i&&"align"!==i)Q.chain=""===Q.chain?"Misc":Q.chain;else if("mmdbid"===i)if(L=Q.ids.m,void 0!==r.icn3d.molid2chain[L]){var J=r.icn3d.molid2chain[L].indexOf("_");Q.chain=r.icn3d.molid2chain[L].substr(J+1)}else{L!==W&&q.push(Q.resi);var ee;ee=$.inArray(Q.resi,q)===q.length-1?"Misc":"Misc2",Q.chain=ee}else if("align"===i)if(L=Q.ids.m,void 0!==r.icn3d.pdbid_molid2chain[Z+"_"+L])Q.chain=r.icn3d.pdbid_molid2chain[Z+"_"+L];else{L!==W&&q.push(Q.resi);var ee;ee=$.inArray(Q.resi,q)===q.length-1?"Misc":"Misc2",Q.chain=ee}Q.chain=Q.chain.trim(),("mmdbid"===i||"align"===i)&&(Q.structure=Z),j=Q.structure,F=j+"_"+Q.chain,F!==z&&(B=0,l=0),"mmdbid"===i?Q.coord=new THREE.Vector3(Q.coord[0],Q.coord[1],Q.coord[2]):Q.coord=new THREE.Vector3(Q.coord.x,Q.coord.y,Q.coord.z);var te=r.icn3d.residueName2Abbr(Q.resn.substr(0,3));if("mmdbid"===i){if("mmdbid"===i&&(Q.b=void 0!==Q.b?Q.b:1),k=Q.resi,void 0!==r.countNextresiArray[F]&&void 0!==r.countNextresiArray[F][B]&&Q.resi===r.countNextresiArray[F][B][1]+K){var ie=r.countNextresiArray[F][B][0];l+=ie,++B}L!==W?Q.resi=Q.resi:Q.resi!==V?Q.resi=l+1:Q.resi=l,V=k}("mmdbid"===i||"align"===i)&&(r.mmdbMolidResid2mmdbChainResi[Z+"_"+Q.ids.m+"_"+Q.ids.r]=Z+"_"+Q.chain+"_"+Q.resi),n.min(Q.coord),s.max(Q.coord),a.add(Q.coord);var oe=void 0===r.cfg.mmcifid?"protein"===m[F]:"p"===Q.mt,re=void 0===r.cfg.mmcifid?"nucleotide"===m[F]:"n"===Q.mt,ne=void 0===r.cfg.mmcifid?"solvent"===m[F]:"s"===Q.mt,se=void 0===r.cfg.mmcifid?"ligand"===m[F]||void 0===m[F]:"l"===Q.mt;oe||re?(oe?(r.icn3d.proteins[d]=1,"CA"===Q.name&&(r.icn3d.calphas[d]=1),"N"!==Q.name&&"CA"!==Q.name&&"C"!==Q.name&&"O"!==Q.name&&(r.icn3d.sidec[d]=1)):re&&(r.icn3d.nucleotides[d]=1,("O3'"==Q.name||"O3*"==Q.name||X&&"P"==Q.name)&&(r.icn3d.nucleotidesO3[d]=1)),Q.het=!1):ne?(r.icn3d.water[d]=1,Q.het=!0):se&&(Q.elem===Q.resn?r.icn3d.ions[d]=1:r.icn3d.chemicals[d]=1,Q.het=!0),"mmdbid"===i?Q.color=Q.het?r.icn3d.atomColors[Q.elem]||r.icn3d.defaultAtomColor:new THREE.Color(v[F]):void 0!==Q.color&&(Q.color=new THREE.Color(Q.color))," "!==Q.resn.charAt(0)&&" "===Q.resn.charAt(1)&&(Q.resn=Q.resn.charAt(0)),"HOH"==Q.resn&&(r.icn3d.water[d]=1),r.icn3d.atoms[d]=Q,r.icn3d.dAtoms[d]=1,r.icn3d.hAtoms[d]=1;var x=Q.structure+"_"+Q.chain;void 0===r.icn3d.chains[x]&&(r.icn3d.chains[x]={}),r.icn3d.chains[x][d]=1;var ae=Q.structure+"_"+Q.chain+"_"+Q.resi;void 0===r.icn3d.residues[ae]&&(r.icn3d.residues[ae]={}),r.icn3d.residues[ae][d]=1,U=F+"_"+Q.resi,U!==N&&F!==z&&(G=!0,1!==d&&(void 0===r.icn3d.structures[P]&&(r.icn3d.structures[P]=[]),r.icn3d.structures[P].push(z))),r.icn3d.residueId2Name[ae]=te;var ce="-";if("helix"===Q.ss?ce="H":"sheet"===Q.ss?ce="E":Q.het||re?ce="o":!Q.het&&r.icn3d.residueColors.hasOwnProperty(Q.resn.toUpperCase())?ce="c":"coil"===Q.ss&&(ce="c"),r.icn3d.secondaries[Q.structure+"_"+Q.chain+"_"+Q.resi]=ce,Q.resi!=l||L!=W)if(void 0===r.icn3d.chainsSeq[x]&&(r.icn3d.chainsSeq[x]=[],G=!1),"mmdbid"!==i&&"mmcifid"!==i||!G||void 0===r.icn3d.chainsSeq[x][Q.resi-1]){var de={};de.resi=Q.resi,de.name=te;var le="";Q.resi%10===0&&(le=Q.resi.toString()),r.icn3d.chainsSeq[x].push(de)}else r.icn3d.chainsSeq[x][Q.resi-1].name=te;l=Q.resi,P=j,z=F,N=U,W=L,Y=Z}if(e.atoms={},void 0===r.icn3d.structures[j]&&(r.icn3d.structures[j]=[]),r.icn3d.structures[j].push(F),"mmcifid"!==i)for(var g in r.icn3d.atoms)for(var he=void 0===r.icn3d.atoms[g].bonds?0:r.icn3d.atoms[g].bonds.length,w=0;he>w;++w)r.icn3d.atoms[g].bonds[w]=M[r.icn3d.atoms[g].bonds[w]];if(r.icn3d.cnt=d,r.icn3d.pmin=n,r.icn3d.pmax=s,r.icn3d.maxD=s.distanceTo(n),r.icn3d.center=a.multiplyScalar(1/r.icn3d.cnt),r.icn3d.maxD<5&&(r.icn3d.maxD=5),r.icn3d.oriMaxD=r.icn3d.maxD,r.icn3d.oriCenter=r.icn3d.center.clone(),"mmdbid"===i){var ue=e.disulfides;if(void 0!==ue)for(var g=0,E=ue.length;E>g;++g){var pe=ue[g][0].ca,me=ue[g][1].ca,ve=r.icn3d.atoms[pe],fe=r.icn3d.atoms[me],ge=ve.structure+"_"+ve.chain+"_"+ve.resi,Ee=fe.structure+"_"+fe.chain+"_"+fe.resi;void 0===r.icn3d.ssbondpnts[ve.structure]&&(r.icn3d.ssbondpnts[ve.structure]=[]),r.icn3d.ssbondpnts[ve.structure].push(ge),r.icn3d.ssbondpnts[ve.structure].push(Ee)}}else if("mmcifid"===i){var ue=e.disulfides;if(void 0!==ue){void 0===r.icn3d.ssbondpnts[t]&&(r.icn3d.ssbondpnts[t]=[]);for(var g=0,E=ue.length;E>g;++g){var ge=ue[g][0],Ee=ue[g][1];r.icn3d.ssbondpnts[t].push(ge),r.icn3d.ssbondpnts[t].push(Ee)}for(var ye=Object.keys(r.icn3d.structures),be=0,Ce=ye.length;Ce>be;++be){var y=ye[be];if(y!=t){void 0===r.icn3d.ssbondpnts[y]&&(r.icn3d.ssbondpnts[y]=[]);for(var w=0,T=r.icn3d.ssbondpnts[t].length;T>w;++w){var we=r.icn3d.ssbondpnts[t][w],J=we.indexOf("_"),Te=y+we.substr(J);r.icn3d.ssbondpnts[y].push(Te)}}}}}"align"===i&&void 0!==o&&r.setSeqAlign(o,e.alignedStructures),r.showTitle(),e={}},iCn3DUI.prototype.downloadMmtf=function(e){var t=this;MMTF.fetch(e,function(e){t.icn3d.init();var i=new THREE.Vector3(9999,9999,9999),o=new THREE.Vector3(-9999,-9999,-9999),r=new THREE.Vector3,n=e.structureId;if(t.icn3d.molTitle=e.title,e.bioAssemblyList[0].transformList.length>1){t.icn3d.biomtMatrices=[];for(var s=0,a=e.bioAssemblyList[0].transformList.length;a>s;++s){for(var c=(new THREE.Matrix4).identity(),d=0,l=e.bioAssemblyList[0].transformList[s].matrix.length;l>d;++d)c.elements[d]=e.bioAssemblyList[0].transformList[s].matrix[d];t.icn3d.biomtMatrices.push(c)}}var h,u,p,m,v,f,g,E,y,b,C,w,T,R,H,S={},A=[],_="coil",x="",O=0,L=0,D=!1,I={onModel:function(e){h=0===e.modelIndex?n:n+(e.modelIndex+1).toString()},onChain:function(e){D=!1,u=e.chainName;var i=h+"_"+u;void 0===t.icn3d.structures[h]&&(t.icn3d.structures[h]=[]),t.icn3d.structures[h].push(i)},onGroup:function(e){p=e.groupName,m=e.groupId,(m==O||D)&&(D=!0,m=O+1);var i=h+"_"+u+"_"+m;v=0===e.secStruct||2===e.secStruct||4===e.secStruct?"helix":3===e.secStruct?"sheet":-1===e.secStruct?"other":"coil";var o=!1;if(u!==x){if("coil"!==v&&"other"!==v?(f=!0,g=!1):(f=!1,g=!1),"coil"!==_&&"other"!==_){var r=h+"_"+x+"_"+O.toString();for(var n in t.icn3d.residues[r])t.icn3d.atoms[n].ssbegin=!1,t.icn3d.atoms[n].ssend=!0}}else v!==_?"coil"===_||"other"===_?(f=!0,g=!1):"coil"===v||"other"===v?(o=!0,f=!1,g=!1):("sheet"===_&&"helix"===v||"helix"===_&&"sheet"===v)&&(o=!0,f=!0,g=!1):(f=!1,g=!1);if(o){var r=h+"_"+u+"_"+(m-1).toString();for(var n in t.icn3d.residues[r])t.icn3d.atoms[n].ssbegin=!1,t.icn3d.atoms[n].ssend=!0}_=v,x=u,O=m,E=!1,y=!1,b=!1,"non-polymer"===e.chemCompType.toLowerCase()||"other"===e.chemCompType.toLowerCase()||-1!==e.chemCompType.toLowerCase().indexOf("saccharide")?E=!0:-1!==e.chemCompType.toLowerCase().indexOf("peptide")?y=!0:-1!==e.chemCompType.toLowerCase().indexOf("dna")||-1!==e.chemCompType.toLowerCase().indexOf("rna")?b=!0:y=!0;var s=h+"_"+u,a={};a.resi=m,a.name=t.icn3d.residueName2Abbr(p),t.icn3d.residueId2Name[i]=a.name,void 0===t.icn3d.chainsSeq[s]&&(t.icn3d.chainsSeq[s]=[]);var c="";a.resi%10===0&&(c=a.resi.toString());var d="-";"helix"===v?d="H":"sheet"===v?d="E":"coil"===v?d="c":"other"===v&&(d="o"),void 0===t.icn3d.chainsSeq[s]&&(t.icn3d.chainsSeq[s]=[]),t.icn3d.chainsSeq[s].push(a),t.icn3d.secondaries[i]=d},onAtom:function(e){if(C=e.element,w=e.atomName,T=new THREE.Vector3(e.xCoord,e.yCoord,e.zCoord),R=e.bFactor,H=e.altLoc,"\x00"===e.altLoc&&(H=""),""===H||"A"===H){++L,"SG"===w&&A.push(L),S[e.atomIndex]=L;var n={het:E,serial:L,name:w,alt:H,resn:p,structure:h,chain:u,resi:m,coord:T,b:R,elem:C,bonds:[],bondOrder:[],ss:v,ssbegin:f,ssend:g};t.icn3d.atoms[L]=n,i.min(T),o.max(T),r.add(T);var s=h+"_"+u,a=s+"_"+m;void 0===t.icn3d.chains[s]&&(t.icn3d.chains[s]={}),t.icn3d.chains[s][L]=1,void 0===t.icn3d.residues[a]&&(t.icn3d.residues[a]={}),t.icn3d.residues[a][L]=1,y?(t.icn3d.proteins[L]=1,"CA"===w&&(t.icn3d.calphas[L]=1),"N"!==w&&"CA"!==w&&"C"!==w&&"O"!==w&&(t.icn3d.sidec[L]=1)):b?(t.icn3d.nucleotides[L]=1,("O3'"==w||"O3*"==w)&&(t.icn3d.nucleotidesO3[L]=1)):C.toLowerCase()===p.toLowerCase()?t.icn3d.ions[L]=1:"HOH"===p||"WAT"===p||"SQL"===p||"H2O"===p||"W"===p||"DOD"===p||"D3O"===p?t.icn3d.water[L]=1:t.icn3d.chemicals[L]=1,t.icn3d.dAtoms[L]=1,t.icn3d.hAtoms[L]=1}},onBond:function(e){var i=S[e.atomIndex1],o=S[e.atomIndex2];if(S.hasOwnProperty(e.atomIndex1)&&S.hasOwnProperty(e.atomIndex2)&&(t.icn3d.atoms[i].bonds.push(o),t.icn3d.atoms[o].bonds.push(i),E)){var r=e.bondOrder;t.icn3d.atoms[i].bondOrder.push(r),t.icn3d.atoms[o].bondOrder.push(r),2===r?(t.icn3d.doublebonds[i+"_"+o]=1,t.icn3d.doublebonds[o+"_"+i]=1):3===r&&(t.icn3d.triplebonds[i+"_"+o]=1,t.icn3d.triplebonds[o+"_"+i]=1)}}};MMTF.traverse(e,I);for(var k=A.length,s=0,a=k;a>s;++s)for(var d=s+1,l=k;a>d;++d){var M=A[s],P=A[d],z=t.icn3d.atoms[M],N=t.icn3d.atoms[P];if(-1!==$.inArray(P,z.bonds)){var j=z.structure+"_"+z.chain+"_"+z.resi,F=N.structure+"_"+N.chain+"_"+N.resi;void 0===t.icn3d.ssbondpnts[z.structure]&&(t.icn3d.ssbondpnts[z.structure]=[]),t.icn3d.ssbondpnts[z.structure].push(j),t.icn3d.ssbondpnts[z.structure].push(F)}}t.icn3d.cnt=L,t.icn3d.pmin=i,t.icn3d.pmax=o,t.icn3d.maxD=o.distanceTo(i),t.icn3d.center=r.multiplyScalar(1/t.icn3d.cnt),t.icn3d.maxD<5&&(t.icn3d.maxD=5),t.icn3d.oriMaxD=t.icn3d.maxD,t.icn3d.oriCenter=t.icn3d.center.clone(),void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),t.showTitle(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()},function(e){console.error(e)})},iCn3DUI.prototype.downloadPdb=function(e){var t,i,o=this;t="https://files.rcsb.org/view/"+e+".pdb",i="text",o.icn3d.bCid=void 0,$.ajax({url:t,dataType:i,cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){o.showLoading()},complete:function(){o.hideLoading()},success:function(e){o.loadPdbData(e)},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}})},iCn3DUI.prototype.downloadUrl=function(e,t){var i=this,o="text";i.icn3d.bCid=void 0,$.ajax({url:e,dataType:o,cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){$("#"+i.pre+"wait")&&$("#"+i.pre+"wait").show(),$("#"+i.pre+"canvas")&&$("#"+i.pre+"canvas").hide(),$("#"+i.pre+"cmdlog")&&$("#"+i.pre+"cmdlog").hide()},complete:function(){$("#"+i.pre+"wait")&&$("#"+i.pre+"wait").hide(),$("#"+i.pre+"canvas")&&$("#"+i.pre+"canvas").show(),$("#"+i.pre+"cmdlog")&&$("#"+i.pre+"cmdlog").show()},success:function(e){"pdb"===t?i.loadPdbData(e):"mol2"===t?i.loadMol2Data(e):"sdf"===t?i.loadSdfData(e):"xyz"===t&&i.loadXyzData(e)},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}})},iCn3DUI.prototype.loadPdbData=function(e){var t=this;t.icn3d.loadPDB(e);var i=t.icn3d.isCalphaPhosOnly(t.icn3d.hash2Atoms(t.icn3d.proteins),"CA"),o=i?"1":"0";if(t.icn3d.bSecondaryStructure||i)t.loadPdbDataRender();else{var r="//www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi";$.ajax({url:r,type:"POST",data:{dssp:"t",calphaonly:o,pdbfile:e},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(e){var i=e;if(-1===JSON.stringify(e).indexOf("Oops there was a problem"))for(var o in t.icn3d.chainsSeq)for(var r=o.indexOf("_"),n=o.substr(r+1),s=t.icn3d.chainsSeq[o],a="coil",c=0,d=s.length;d>c;++c){var l=s[c].resi,h=n+"_"+l,u="-";i.hasOwnProperty(h)&&(u=i[h]);var p;p="H"===u?"helix":"E"===u?"sheet":"coil",t.icn3d.chainsAn[o][1][c]=u;var m=o+"_"+l,v=0;if(p!==a?"coil"===a?(ssbegin=!0,ssend=!1):"coil"===p?(v=2,ssbegin=!1,ssend=!1):("sheet"===a&&"helix"===p||"helix"===a&&"sheet"===p)&&(v=1,ssbegin=!0,ssend=!1):(ssbegin=!1,ssend=!1),1==v){var f=o+"_"+(l-1).toString();for(var g in t.icn3d.residues[f])t.icn3d.atoms[g].ssbegin=!0,t.icn3d.atoms[g].ssend=!1}else if(2==v){var f=o+"_"+(l-1).toString();for(var g in t.icn3d.residues[f])t.icn3d.atoms[g].ssbegin=!1,t.icn3d.atoms[g].ssend=!0}for(var g in t.icn3d.residues[m])t.icn3d.atoms[g].ss=p,t.icn3d.atoms[g].ssbegin=ssbegin,t.icn3d.atoms[g].ssend=ssend;a=p}t.loadPdbDataRender()},error:function(e,i,o){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void t.loadPdbDataRender()}})}},iCn3DUI.prototype.loadPdbDataRender=function(){var e=this;e.pmid=e.icn3d.pmid,void 0===e.cfg.align&&1==Object.keys(e.icn3d.structures).length&&$("#"+e.pre+"alternateWrapper").hide(),e.icn3d.setAtomStyleByOptions(e.opts),e.icn3d.setColorByOptions(e.opts,e.icn3d.atoms),e.renderStructure(),e.showTitle(),void 0!==e.cfg.rotate&&e.rotStruc(e.cfg.rotate,!0),void 0!==e.deferred&&e.deferred.resolve(),void 0!==e.deferred2&&e.deferred2.resolve()},iCn3DUI.prototype.downloadCid=function(e){var t=this,i="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+e+"/record/SDF/?record_type=3d&response_type=display";t.opts.pk="atom",t.opts.chemicals="ball and stick",t.icn3d.opts.pk="atom",t.icn3d.opts.chemicals="ball and stick",t.icn3d.bCid=!0,$.ajax({url:i,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){t.showLoading()},complete:function(){t.hideLoading()},success:function(i){var o=t.loadSdfAtomData(i,e);void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),o?(t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()):alert("The SDF of CID "+e+" has the wrong format...")},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0}}).fail(function(){alert("This CID may not have 3D structure...")})},iCn3DUI.prototype.loadSdfData=function(e){var t=this,i=t.loadSdfAtomData(e);void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),
i?(t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()):alert("The SDF file has the wrong format...")},iCn3DUI.prototype.loadSdfAtomData=function(e,t){var i=this,o=e.split(/\r?\n|\r/);if(o.length<4)return!1;i.icn3d.init();var r=t?t:1,n="A",s=1,a="LIG",c=r,d=r+"_"+n,l=d+"_"+s,h=parseInt(o[3].substr(0,3));if(isNaN(h)||0>=h)return!1;var u=parseInt(o[3].substr(3,3)),p=4;if(o.length<p+h+u)return!1;var m,v,f=0,g=h,E={},y={},b={},C=1;for(m=f;g>m;m++){v=o[p],p++;var w=v.substr(31,3).replace(/ /g,"");if("H"!==w){var T=parseFloat(v.substr(0,10)),R=parseFloat(v.substr(10,10)),H=parseFloat(v.substr(20,10)),S=new THREE.Vector3(T,R,H),A={het:!0,serial:C,name:w,resn:a,structure:r,chain:n,resi:s,coord:S,b:0,elem:w,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};i.icn3d.atoms[C]=A,b[C]=1,E[m]=C,++C}else y[m]=1}i.icn3d.dAtoms=b,i.icn3d.hAtoms=b,i.icn3d.structures[c]=[d],i.icn3d.chains[d]=b,i.icn3d.residues[l]=b,i.icn3d.residueId2Name[l]=a,void 0===i.icn3d.chainsSeq[d]&&(i.icn3d.chainsSeq[d]=[]);var _={};for(_.resi=s,_.name=a,i.icn3d.chainsSeq[d].push(_),m=0;u>m;m++){v=o[p],p++;var x=parseInt(v.substr(0,3))-1+f,O=parseInt(v.substr(3,3))-1+f,L=v.substr(6,3).trim();if(!y.hasOwnProperty(x)&&!y.hasOwnProperty(O)){var D=E[x],I=E[O];i.icn3d.atoms[D].bonds.push(I),i.icn3d.atoms[D].bondOrder.push(L),i.icn3d.atoms[I].bonds.push(D),i.icn3d.atoms[I].bondOrder.push(L),"2"==L?(i.icn3d.doublebonds[D+"_"+I]=1,i.icn3d.doublebonds[I+"_"+D]=1):"3"==L&&(i.icn3d.triplebonds[D+"_"+I]=1,i.icn3d.triplebonds[I+"_"+D]=1)}}return i.setMaxD(),i.showTitle(),!0},iCn3DUI.prototype.setMaxD=function(){var e=this,t=new THREE.Vector3(9999,9999,9999),i=new THREE.Vector3(-9999,-9999,-9999),o=new THREE.Vector3,r=0;for(var n in e.icn3d.atoms){var s=e.icn3d.atoms[n],a=s.coord;o.add(a),t.min(a),i.max(a),++r,s.het&&(-1!==$.inArray(s.elem,e.icn3d.ionsArray)?e.icn3d.ions[s.serial]=1:e.icn3d.chemicals[s.serial]=1)}e.icn3d.pmin=t,e.icn3d.pmax=i,e.icn3d.cnt=r,e.icn3d.maxD=e.icn3d.pmax.distanceTo(e.icn3d.pmin),e.icn3d.center=o.multiplyScalar(1/e.icn3d.cnt),e.icn3d.maxD<5&&(e.icn3d.maxD=5),e.icn3d.oriMaxD=e.icn3d.maxD,e.icn3d.oriCenter=e.icn3d.center.clone()};